<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>Koa2学习笔记 | jinux</title>
  <meta name="description" content="前端 学习 javascript">
  <meta name="keywords" content>
  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="alternate" href="/atom.xml" title="jinux">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="mysql学习笔记整理-账号管理">
<meta name="keywords" content="后端">
<meta property="og:type" content="article">
<meta property="og:title" content="Koa2学习笔记">
<meta property="og:url" content="/2023/05/16/Koa2学习笔记/index.html">
<meta property="og:site_name" content="jinux">
<meta property="og:description" content="mysql学习笔记整理-账号管理">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/start-result-01.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/async.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/route-result-01.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/request-get.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/request-post-form.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/request-post-result.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/request-post-form.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/request-post-result.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/static-server-result-01.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/static-server-result-02.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/static-server-result-03.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/static-server-result-01.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/static-server-result-02.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/static-server-result-03.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/cookie-result-01.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/session-result-01.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/session-result-03.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/session-result-02.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/upload-simple-result-03.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/upload-simple-result-02.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/upload-simple-result-01.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/upload-simple-result-04.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/upload-async-result-01.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/mysql-init-result-01.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/mysql-init-result-02.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/jsonp-result-01.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/jsonp-result-02.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/test-unit-result-01.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/test-unit-result-03.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/debug-result-001.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/debug-result-002.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/debug-result-003.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/debug-result-004.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/debug-result-006.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/debug-result-005.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/debug-result-008.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/debug-result-007.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/project-result-02.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/project-result-00.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/project-result-01.png">
<meta property="og:image" content="/2023/05/16/Koa2学习笔记/images/project-result-02.png">
<meta property="og:updated_time" content="2024-01-11T07:00:59.131Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Koa2学习笔记">
<meta name="twitter:description" content="mysql学习笔记整理-账号管理">
<meta name="twitter:image" content="/2023/05/16/Koa2学习笔记/images/start-result-01.png">

  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="icon" href="/favicon.ico">
  <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/node-waves/0.7.5/waves.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>
</html>
<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script>
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/' >
				<!-- <i class="fa fa-home"></i> -->
				jinux
			</a>

				<div class='menu'>
					<ul class='h-list'>
						
							<li>
								<a class='flat-box nav-home' href='/'>
									<i class="fa fa-home"></i>
									主页
								</a>
							</li>
						
							<li>
								<a class='flat-box nav-cube' href='/categories'>
									<i class="fa fa-cube"></i>
									导航
								</a>
							</li>
						
							<li>
								<a class='flat-box nav-github' href='https://github.com/jinux7'>
									<i class="fa fa-github"></i>
									github
								</a>
							</li>
						
							<li>
								<a class='flat-box nav-archive' href='/archives'>
									<i class="fa fa-archive"></i>
									归档
								</a>
							</li>
						
					</ul>
					<div class='underline'></div>
				</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon"><i class="fa fa-search"></i></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><i class="fa fa-search flat-box"></i></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><i class="fa fa-navicon flat-box"></i></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				xaoxuu
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><i class="fa fa-comments flat-box"></i></a></li>
				<li class='s-top'><a href='javascript:void(0)'><i class="fa fa-arrow-up flat-box"></i></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><i class="fa fa-list-ul flat-box"></i></a></li>
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
        <div class="header">jinux</div>
		<nav>
			
				<a href="/" class="nav-home nav">
					<i class="fa fa-home"></i>
					主页
				</a>
			
				<a href="/categories" class="nav-cube nav">
					<i class="fa fa-cube"></i>
					导航
				</a>
			
				<a href="https://github.com/jinux7" class="nav-github nav">
					<i class="fa fa-github"></i>
					github
				</a>
			
				<a href="/archives" class="nav-archive nav">
					<i class="fa fa-archive"></i>
					归档
				</a>
			
		</nav>
	</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        <article id="post-Koa2学习笔记" class="post white-box article-type-post" itemscope itemprop="blogPost">
    <section class='meta'>
        <h1 class="title">
            
                Koa2学习笔记
            
        </h1>
        <time>
            2023-05-16 Tuesday&nbsp;&nbsp;
            <i class="fa fa-eye" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
        </time>
        
    
    <div class='cats'>
        <a href="/categories/nodejs/">nodejs</a>
    </div>


    </section>
    
        <section class="toc-wrapper">
            <div class="header"><i class="fa fa-list" aria-hidden="true"></i>&nbsp;&nbsp;目录</div>
            <div class='content'>
                <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#koa2开始"><span class="toc-number">1.</span> <span class="toc-text">koa2开始</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#koa2-快速开始"><span class="toc-number">1.1.</span> <span class="toc-text">koa2 快速开始</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#环境准备"><span class="toc-number">1.1.1.</span> <span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#快速开始"><span class="toc-number">1.1.2.</span> <span class="toc-text">快速开始</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装koa2"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">安装koa2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hello-world-代码"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">hello world 代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动demo"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">启动demo</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#async-await使用"><span class="toc-number">1.2.</span> <span class="toc-text">async/await使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#快速上手理解"><span class="toc-number">1.2.1.</span> <span class="toc-text">快速上手理解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#在chrome的console中执行结果如下"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">在chrome的console中执行结果如下</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#从上述例子可以看出-async-await-的特点："><span class="toc-number">1.2.1.2.</span> <span class="toc-text">从上述例子可以看出 async/await 的特点：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#koa2简析结构"><span class="toc-number">1.3.</span> <span class="toc-text">koa2简析结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#源码文件"><span class="toc-number">1.3.1.</span> <span class="toc-text">源码文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#koa2特性"><span class="toc-number">1.3.2.</span> <span class="toc-text">koa2特性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#koa中间件开发和使用"><span class="toc-number">1.4.</span> <span class="toc-text">koa中间件开发和使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#generator中间件开发"><span class="toc-number">1.4.1.</span> <span class="toc-text">generator中间件开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#generator中间件开发-1"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">generator中间件开发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#generator中间件在koa-1中的使用"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">generator中间件在koa@1中的使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#generator中间件在koa-2中的使用"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">generator中间件在koa@2中的使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#async中间件开发"><span class="toc-number">1.4.2.</span> <span class="toc-text">async中间件开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#async-中间件开发"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">async 中间件开发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#async-中间件在koa-2中使用"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">async 中间件在koa@2中使用</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#路由"><span class="toc-number">2.</span> <span class="toc-text">路由</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#koa2-原生路由实现"><span class="toc-number">2.1.</span> <span class="toc-text">koa2 原生路由实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简单例子"><span class="toc-number">2.1.1.</span> <span class="toc-text">简单例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#定制化的路由"><span class="toc-number">2.1.2.</span> <span class="toc-text">定制化的路由</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#源码文件目录"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">源码文件目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#demo源码"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">demo源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行demo"><span class="toc-number">2.1.2.3.</span> <span class="toc-text">运行demo</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#执行运行脚本"><span class="toc-number">2.1.2.3.1.</span> <span class="toc-text">执行运行脚本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#运行效果如下"><span class="toc-number">2.1.2.3.2.</span> <span class="toc-text">运行效果如下</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装koa-router中间件"><span class="toc-number">2.1.3.</span> <span class="toc-text">安装koa-router中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#快速使用koa-router"><span class="toc-number">2.1.4.</span> <span class="toc-text">快速使用koa-router</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#请求数据获取"><span class="toc-number">3.</span> <span class="toc-text">请求数据获取</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#GET请求数据获取"><span class="toc-number">3.1.</span> <span class="toc-text">GET请求数据获取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用方法"><span class="toc-number">3.1.1.</span> <span class="toc-text">使用方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#举个例子"><span class="toc-number">3.1.2.</span> <span class="toc-text">举个例子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#例子代码"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">例子代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#执行程序"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">执行程序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POST请求参数获取"><span class="toc-number">3.2.</span> <span class="toc-text">POST请求参数获取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#原理"><span class="toc-number">3.2.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#解析出POST请求上下文中的表单数据"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">解析出POST请求上下文中的表单数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#举个例子-1"><span class="toc-number">3.2.2.</span> <span class="toc-text">举个例子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#例子代码-1"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">例子代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动例子"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">启动例子</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#访问页面"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">访问页面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#提交表单发起POST请求结果显示"><span class="toc-number">3.2.2.4.</span> <span class="toc-text">提交表单发起POST请求结果显示</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#koa-bodyparser中间件"><span class="toc-number">3.3.</span> <span class="toc-text">koa-bodyparser中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#原理-1"><span class="toc-number">3.3.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装koa2版本的koa-bodyparser-3中间件"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">安装koa2版本的koa-bodyparser@3中间件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#举个例子-2"><span class="toc-number">3.3.2.</span> <span class="toc-text">举个例子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#例子代码-2"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">例子代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动例子-1"><span class="toc-number">3.3.2.2.</span> <span class="toc-text">启动例子</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#访问页面-1"><span class="toc-number">3.3.2.3.</span> <span class="toc-text">访问页面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#提交表单发起POST请求结果显示-1"><span class="toc-number">3.3.2.4.</span> <span class="toc-text">提交表单发起POST请求结果显示</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#静态资源加载"><span class="toc-number">4.</span> <span class="toc-text">静态资源加载</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#原生koa2实现静态资源服务器"><span class="toc-number">4.1.</span> <span class="toc-text">原生koa2实现静态资源服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言"><span class="toc-number">4.1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#原生koa2-静态资源服务器例子"><span class="toc-number">4.1.2.</span> <span class="toc-text">原生koa2 静态资源服务器例子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#代码目录"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">代码目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#代码解析"><span class="toc-number">4.1.2.2.</span> <span class="toc-text">代码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#index-js"><span class="toc-number">4.1.2.2.1.</span> <span class="toc-text">index.js</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#util-content-js"><span class="toc-number">4.1.2.2.2.</span> <span class="toc-text">util/content.js</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#util-dir-js"><span class="toc-number">4.1.2.2.3.</span> <span class="toc-text">util/dir.js</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#util-file-js"><span class="toc-number">4.1.2.2.4.</span> <span class="toc-text">util/file.js</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#util-walk-js"><span class="toc-number">4.1.2.2.5.</span> <span class="toc-text">util/walk.js</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#util-mime-js"><span class="toc-number">4.1.2.2.6.</span> <span class="toc-text">util/mime.js</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行效果"><span class="toc-number">4.1.2.3.</span> <span class="toc-text">运行效果</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#启动服务"><span class="toc-number">4.1.2.3.1.</span> <span class="toc-text">启动服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#效果"><span class="toc-number">4.1.2.3.2.</span> <span class="toc-text">效果</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#访问http-localhost-3000"><span class="toc-number">4.1.2.3.2.1.</span> <span class="toc-text">访问http://localhost:3000</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#访问http-localhost-3000-index-html"><span class="toc-number">4.1.2.3.2.2.</span> <span class="toc-text">访问http://localhost:3000/index.html</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#访问http-localhost-3000-js-index-js"><span class="toc-number">4.1.2.3.2.3.</span> <span class="toc-text">访问http://localhost:3000/js/index.js</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#koa-static中间件使用"><span class="toc-number">4.2.</span> <span class="toc-text">koa-static中间件使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用例子"><span class="toc-number">4.2.1.</span> <span class="toc-text">使用例子</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#效果-1"><span class="toc-number">4.2.1.0.1.</span> <span class="toc-text">效果</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#访问http-localhost-3000-1"><span class="toc-number">4.2.1.0.1.1.</span> <span class="toc-text">访问http://localhost:3000</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#访问http-localhost-3000-index-html-1"><span class="toc-number">4.2.1.0.1.2.</span> <span class="toc-text">访问http://localhost:3000/index.html</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#访问http-localhost-3000-js-index-js-1"><span class="toc-number">4.2.1.0.1.3.</span> <span class="toc-text">访问http://localhost:3000/js/index.js</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#cookie-session"><span class="toc-number">5.</span> <span class="toc-text">cookie/session</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#koa2使用cookie"><span class="toc-number">5.1.</span> <span class="toc-text">koa2使用cookie</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用方法-1"><span class="toc-number">5.1.1.</span> <span class="toc-text">使用方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#例子代码-3"><span class="toc-number">5.1.2.</span> <span class="toc-text">例子代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#运行例子"><span class="toc-number">5.1.3.</span> <span class="toc-text">运行例子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#执行脚本"><span class="toc-number">5.1.3.1.</span> <span class="toc-text">执行脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行结果"><span class="toc-number">5.1.3.2.</span> <span class="toc-text">运行结果</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#访问http-localhost-3000-index"><span class="toc-number">5.1.3.2.1.</span> <span class="toc-text">访问http://localhost:3000/index</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#koa2实现session"><span class="toc-number">5.2.</span> <span class="toc-text">koa2实现session</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言-1"><span class="toc-number">5.2.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库存储方案"><span class="toc-number">5.2.2.</span> <span class="toc-text">数据库存储方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#快速使用"><span class="toc-number">5.2.3.</span> <span class="toc-text">快速使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#例子代码-4"><span class="toc-number">5.2.3.1.</span> <span class="toc-text">例子代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行例子-1"><span class="toc-number">5.2.3.2.</span> <span class="toc-text">运行例子</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#执行命令"><span class="toc-number">5.2.3.2.1.</span> <span class="toc-text">执行命令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#访问连接设置session"><span class="toc-number">5.2.3.2.2.</span> <span class="toc-text">访问连接设置session</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#查看数据库session是否存储"><span class="toc-number">5.2.3.2.3.</span> <span class="toc-text">查看数据库session是否存储</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#查看cookie中是否种下了sessionId"><span class="toc-number">5.2.3.2.4.</span> <span class="toc-text">查看cookie中是否种下了sessionId</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#模板引擎"><span class="toc-number">6.</span> <span class="toc-text">模板引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#koa2加载模板引擎"><span class="toc-number">6.1.</span> <span class="toc-text">koa2加载模板引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#快速开始-1"><span class="toc-number">6.1.1.</span> <span class="toc-text">快速开始</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装模块"><span class="toc-number">6.1.1.1.</span> <span class="toc-text">安装模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用模板引擎"><span class="toc-number">6.1.1.2.</span> <span class="toc-text">使用模板引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#文件目录"><span class="toc-number">6.1.1.2.1.</span> <span class="toc-text">文件目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#index-js文件"><span class="toc-number">6.1.1.2.2.</span> <span class="toc-text">./index.js文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#view-index-ejs-模板"><span class="toc-number">6.1.1.2.3.</span> <span class="toc-text">./view/index.ejs 模板</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ejs模板引擎"><span class="toc-number">6.2.</span> <span class="toc-text">ejs模板引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#具体查看ejs官方文档"><span class="toc-number">6.2.1.</span> <span class="toc-text">具体查看ejs官方文档</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#文件上传"><span class="toc-number">7.</span> <span class="toc-text">文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#busboy模块"><span class="toc-number">7.1.</span> <span class="toc-text">busboy模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#快速开始-2"><span class="toc-number">7.1.1.</span> <span class="toc-text">快速开始</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装"><span class="toc-number">7.1.1.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#模块简介"><span class="toc-number">7.1.1.2.</span> <span class="toc-text">模块简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#开始使用"><span class="toc-number">7.1.1.3.</span> <span class="toc-text">开始使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更多模块信息"><span class="toc-number">7.1.2.</span> <span class="toc-text">更多模块信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#上传文件简单实现"><span class="toc-number">7.2.</span> <span class="toc-text">上传文件简单实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#依赖模块"><span class="toc-number">7.2.1.</span> <span class="toc-text">依赖模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装依赖"><span class="toc-number">7.2.1.1.</span> <span class="toc-text">安装依赖</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#例子源码"><span class="toc-number">7.2.2.</span> <span class="toc-text">例子源码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#封装上传文件到写入服务的方法"><span class="toc-number">7.2.2.1.</span> <span class="toc-text">封装上传文件到写入服务的方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#入口文件"><span class="toc-number">7.2.2.2.</span> <span class="toc-text">入口文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行结果-1"><span class="toc-number">7.2.2.3.</span> <span class="toc-text">运行结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#异步上传图片实现"><span class="toc-number">7.3.</span> <span class="toc-text">异步上传图片实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#快速上手"><span class="toc-number">7.3.1.</span> <span class="toc-text">快速上手</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#源码理解"><span class="toc-number">7.3.2.</span> <span class="toc-text">源码理解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#demo源码目录"><span class="toc-number">7.3.2.1.</span> <span class="toc-text">demo源码目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#后端代码"><span class="toc-number">7.3.2.2.</span> <span class="toc-text">后端代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#前端代码"><span class="toc-number">7.3.2.3.</span> <span class="toc-text">前端代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行效果-1"><span class="toc-number">7.3.2.4.</span> <span class="toc-text">运行效果</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#数据库mysql"><span class="toc-number">8.</span> <span class="toc-text">数据库mysql</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql模块"><span class="toc-number">8.1.</span> <span class="toc-text">mysql模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#快速开始-3"><span class="toc-number">8.1.1.</span> <span class="toc-text">快速开始</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装MySQL数据库"><span class="toc-number">8.1.1.1.</span> <span class="toc-text">安装MySQL数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装-node-js的mysql模块"><span class="toc-number">8.1.1.2.</span> <span class="toc-text">安装 node.js的mysql模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#模块介绍"><span class="toc-number">8.1.1.3.</span> <span class="toc-text">模块介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#开始使用-1"><span class="toc-number">8.1.1.4.</span> <span class="toc-text">开始使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#创建数据库会话"><span class="toc-number">8.1.1.4.1.</span> <span class="toc-text">创建数据库会话</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#创建数据连接池"><span class="toc-number">8.1.1.4.2.</span> <span class="toc-text">创建数据连接池</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更多模块信息-1"><span class="toc-number">8.1.2.</span> <span class="toc-text">更多模块信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#async-await封装使用mysql"><span class="toc-number">8.2.</span> <span class="toc-text">async/await封装使用mysql</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言-2"><span class="toc-number">8.2.1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Promise封装mysql模块"><span class="toc-number">8.2.1.1.</span> <span class="toc-text">Promise封装mysql模块</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Promise封装-async-db"><span class="toc-number">8.2.1.1.1.</span> <span class="toc-text">Promise封装 ./async-db</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#async-await使用-1"><span class="toc-number">8.2.1.1.2.</span> <span class="toc-text">async/await使用</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#建表初始化"><span class="toc-number">8.3.</span> <span class="toc-text">建表初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言-3"><span class="toc-number">8.3.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#快速开始-4"><span class="toc-number">8.3.2.</span> <span class="toc-text">快速开始</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#源码目录"><span class="toc-number">8.3.2.1.</span> <span class="toc-text">源码目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#具体流程"><span class="toc-number">8.3.2.2.</span> <span class="toc-text">具体流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#源码详解"><span class="toc-number">8.3.3.</span> <span class="toc-text">源码详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#数据库操作文件-util-db-js"><span class="toc-number">8.3.3.1.</span> <span class="toc-text">数据库操作文件 ./util/db.js</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取所有sql脚本内容-util-get-sql-content-map-js"><span class="toc-number">8.3.3.2.</span> <span class="toc-text">获取所有sql脚本内容 ./util/get-sql-content-map.js</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取sql目录详情-util-get-sql-map-js"><span class="toc-number">8.3.3.3.</span> <span class="toc-text">获取sql目录详情 ./util/get-sql-map.js</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#遍历目录操作-util-walk-file-js"><span class="toc-number">8.3.3.4.</span> <span class="toc-text">遍历目录操作 ./util/walk-file.js</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#入口文件-index-js"><span class="toc-number">8.3.3.5.</span> <span class="toc-text">入口文件 ./index.js</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sql脚本文件-sql-data-sql"><span class="toc-number">8.3.3.6.</span> <span class="toc-text">sql脚本文件 ./sql/data.sql</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sql脚本文件-sql-user-sql"><span class="toc-number">8.3.3.7.</span> <span class="toc-text">sql脚本文件 ./sql/user.sql</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#效果-2"><span class="toc-number">8.3.4.</span> <span class="toc-text">效果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#执行脚本-1"><span class="toc-number">8.3.4.1.</span> <span class="toc-text">执行脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#执行结果"><span class="toc-number">8.3.4.2.</span> <span class="toc-text">执行结果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看数据库写入数据"><span class="toc-number">8.3.4.3.</span> <span class="toc-text">查看数据库写入数据</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JSONP实现"><span class="toc-number">9.</span> <span class="toc-text">JSONP实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#原生koa2实现jsonp"><span class="toc-number">9.1.</span> <span class="toc-text">原生koa2实现jsonp</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言-4"><span class="toc-number">9.1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现JSONP"><span class="toc-number">9.1.2.</span> <span class="toc-text">实现JSONP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#具体原理"><span class="toc-number">9.1.2.1.</span> <span class="toc-text">具体原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解析原理"><span class="toc-number">9.1.2.2.</span> <span class="toc-text">解析原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#效果截图"><span class="toc-number">9.1.2.3.</span> <span class="toc-text">效果截图</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#同域访问JSON请求"><span class="toc-number">9.1.2.3.1.</span> <span class="toc-text">同域访问JSON请求</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#跨域访问JSON请求"><span class="toc-number">9.1.2.3.2.</span> <span class="toc-text">跨域访问JSON请求</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#完整demo代码"><span class="toc-number">9.1.2.4.</span> <span class="toc-text">完整demo代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#简单例子-1"><span class="toc-number">9.1.2.5.</span> <span class="toc-text">简单例子</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#测试"><span class="toc-number">10.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#单元测试"><span class="toc-number">10.1.</span> <span class="toc-text">单元测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言-5"><span class="toc-number">10.1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#准备工作"><span class="toc-number">10.1.2.</span> <span class="toc-text">准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装测试相关框架"><span class="toc-number">10.1.2.1.</span> <span class="toc-text">安装测试相关框架</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试例子"><span class="toc-number">10.1.3.</span> <span class="toc-text">测试例子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#例子目录"><span class="toc-number">10.1.3.1.</span> <span class="toc-text">例子目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#所需测试demo"><span class="toc-number">10.1.3.2.</span> <span class="toc-text">所需测试demo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#开始写测试用例"><span class="toc-number">10.1.3.3.</span> <span class="toc-text">开始写测试用例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#执行测试用例"><span class="toc-number">10.1.3.4.</span> <span class="toc-text">执行测试用例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用例详解"><span class="toc-number">10.1.3.5.</span> <span class="toc-text">用例详解</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#服务入口加载"><span class="toc-number">10.1.3.5.1.</span> <span class="toc-text">服务入口加载</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#测试套件、用例"><span class="toc-number">10.1.3.5.2.</span> <span class="toc-text">测试套件、用例</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#debug"><span class="toc-number">11.</span> <span class="toc-text">debug</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#开发debug"><span class="toc-number">11.1.</span> <span class="toc-text">开发debug</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#快速开始-5"><span class="toc-number">11.1.1.</span> <span class="toc-text">快速开始</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#环境"><span class="toc-number">11.1.1.1.</span> <span class="toc-text">环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动脚本"><span class="toc-number">11.1.1.2.</span> <span class="toc-text">启动脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#调试demo"><span class="toc-number">11.1.1.2.1.</span> <span class="toc-text">调试demo</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#指令框显示"><span class="toc-number">11.1.1.2.2.</span> <span class="toc-text">指令框显示</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#访问chrome浏览器调试server"><span class="toc-number">11.1.1.2.3.</span> <span class="toc-text">访问chrome浏览器调试server</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#打开chrome浏览器的node调试窗口"><span class="toc-number">11.1.1.2.4.</span> <span class="toc-text">打开chrome浏览器的node调试窗口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#可以自定义打断点调试了"><span class="toc-number">11.1.1.2.5.</span> <span class="toc-text">可以自定义打断点调试了</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#项目框架搭建"><span class="toc-number">12.</span> <span class="toc-text">项目框架搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#项目demo"><span class="toc-number">12.1.</span> <span class="toc-text">项目demo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#快速启动"><span class="toc-number">12.1.1.</span> <span class="toc-text">快速启动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#demo地址"><span class="toc-number">12.1.1.1.</span> <span class="toc-text">demo地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#环境准备-1"><span class="toc-number">12.1.1.2.</span> <span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#初始化数据库"><span class="toc-number">12.1.1.3.</span> <span class="toc-text">初始化数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动脚本-1"><span class="toc-number">12.1.1.4.</span> <span class="toc-text">启动脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#访问项目demo"><span class="toc-number">12.1.1.5.</span> <span class="toc-text">访问项目demo</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#框架设计"><span class="toc-number">12.2.</span> <span class="toc-text">框架设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#实现概要"><span class="toc-number">12.2.1.</span> <span class="toc-text">实现概要</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文件目录设计"><span class="toc-number">12.2.2.</span> <span class="toc-text">文件目录设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#入口文件预览"><span class="toc-number">12.2.3.</span> <span class="toc-text">入口文件预览</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库设计"><span class="toc-number">12.3.</span> <span class="toc-text">数据库设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化数据库脚本"><span class="toc-number">12.3.1.</span> <span class="toc-text">初始化数据库脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#脚本目录"><span class="toc-number">12.3.1.1.</span> <span class="toc-text">脚本目录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#路由设计"><span class="toc-number">12.4.</span> <span class="toc-text">路由设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用koa-router中间件"><span class="toc-number">12.4.1.</span> <span class="toc-text">使用koa-router中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#路由目录"><span class="toc-number">12.4.1.1.</span> <span class="toc-text">路由目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#子路由配置"><span class="toc-number">12.4.1.2.</span> <span class="toc-text">子路由配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#resetful-API-子路由"><span class="toc-number">12.4.1.3.</span> <span class="toc-text">resetful API 子路由</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#子路由汇总"><span class="toc-number">12.4.1.3.1.</span> <span class="toc-text">子路由汇总</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#app-js加载路由中间件"><span class="toc-number">12.4.1.3.2.</span> <span class="toc-text">app.js加载路由中间件</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#webpack4-环境搭建"><span class="toc-number">12.5.</span> <span class="toc-text">webpack4 环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言-6"><span class="toc-number">12.5.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#webpack4"><span class="toc-number">12.5.2.</span> <span class="toc-text">webpack4</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装和文档"><span class="toc-number">12.5.2.1.</span> <span class="toc-text">安装和文档</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置webpack4编译react-js-less-sass-antd-环境"><span class="toc-number">12.5.3.</span> <span class="toc-text">配置webpack4编译react.js + less + sass + antd 环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#文件目录-1"><span class="toc-number">12.5.3.1.</span> <span class="toc-text">文件目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#webpack4-编译基础配置"><span class="toc-number">12.5.3.2.</span> <span class="toc-text">webpack4 编译基础配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#babel-7-配置"><span class="toc-number">12.5.3.2.1.</span> <span class="toc-text">babel@7 配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#webpack-base-config-js"><span class="toc-number">12.5.3.2.2.</span> <span class="toc-text">webpack.base.config.js</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置开发-amp-生产环境webpack4-编译设置"><span class="toc-number">12.5.3.3.</span> <span class="toc-text">配置开发&amp;生产环境webpack4 编译设置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#开发环境配置-wepack-dev-config-js"><span class="toc-number">12.5.3.3.1.</span> <span class="toc-text">开发环境配置 wepack.dev.config.js</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#编译环境配置-wepack-prod-config-js"><span class="toc-number">12.5.3.3.2.</span> <span class="toc-text">编译环境配置 wepack.prod.config.js</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用react-js"><span class="toc-number">12.6.</span> <span class="toc-text">使用react.js</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#react-js简介"><span class="toc-number">12.6.1.</span> <span class="toc-text">react.js简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编译使用"><span class="toc-number">12.6.2.</span> <span class="toc-text">编译使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#前端待编译源文件目录"><span class="toc-number">12.6.3.</span> <span class="toc-text">前端待编译源文件目录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#react-js页面应用文件"><span class="toc-number">12.6.3.1.</span> <span class="toc-text">react.js页面应用文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#react-js执行render渲染"><span class="toc-number">12.6.3.2.</span> <span class="toc-text">react.js执行render渲染</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#静态页面引用react-js编译后文件"><span class="toc-number">12.6.3.3.</span> <span class="toc-text">静态页面引用react.js编译后文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#页面渲染效果"><span class="toc-number">12.6.3.4.</span> <span class="toc-text">页面渲染效果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#登录注册功能实现"><span class="toc-number">12.7.</span> <span class="toc-text">登录注册功能实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#用户模型dao操作"><span class="toc-number">12.7.1.</span> <span class="toc-text">用户模型dao操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#业务层操作"><span class="toc-number">12.7.1.1.</span> <span class="toc-text">业务层操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#controller-操作"><span class="toc-number">12.7.1.2.</span> <span class="toc-text">controller 操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#api路由操作"><span class="toc-number">12.7.1.3.</span> <span class="toc-text">api路由操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#前端用react-js实现效果"><span class="toc-number">12.7.2.</span> <span class="toc-text">前端用react.js实现效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#session登录态判断处理"><span class="toc-number">12.8.</span> <span class="toc-text">session登录态判断处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用session中间件"><span class="toc-number">12.8.1.</span> <span class="toc-text">使用session中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#登录成功后设置session到MySQL和设置sessionId到cookie"><span class="toc-number">12.8.2.</span> <span class="toc-text">登录成功后设置session到MySQL和设置sessionId到cookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#需要判断登录态页面进行session判断"><span class="toc-number">12.8.3.</span> <span class="toc-text">需要判断登录态页面进行session判断</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#其他进阶"><span class="toc-number">13.</span> <span class="toc-text">其他进阶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言-7"><span class="toc-number">13.0.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node-9下import-export使用简单须知"><span class="toc-number">13.0.2.</span> <span class="toc-text">Node 9下import/export使用简单须知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用简述"><span class="toc-number">13.0.3.</span> <span class="toc-text">使用简述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#与require-区别"><span class="toc-number">13.0.3.1.</span> <span class="toc-text">与require()区别</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Loader-Hooks模式使用"><span class="toc-number">13.0.4.</span> <span class="toc-text">Loader Hooks模式使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Loader-Hooks-使用步骤"><span class="toc-number">13.0.4.1.</span> <span class="toc-text">Loader Hooks 使用步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Koa2-直接使用import-export"><span class="toc-number">13.0.5.</span> <span class="toc-text">Koa2 直接使用import/export</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义loader规则优化"><span class="toc-number">13.0.5.1.</span> <span class="toc-text">自定义loader规则优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#loader规则优化解析"><span class="toc-number">13.0.5.2.</span> <span class="toc-text">loader规则优化解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#规则总结"><span class="toc-number">13.0.5.3.</span> <span class="toc-text">规则总结</span></a></li></ol></li></ol></li></ol></li></ol>
            </div>
        </section>
    

    <section class="article typo">

        <div class="article-entry" itemprop="articleBody">
            <p>mysql学习笔记整理-账号管理<br><a id="more"></a></p>
<h1 id="koa2开始"><a href="#koa2开始" class="headerlink" title="koa2开始"></a>koa2开始</h1><h2 id="koa2-快速开始"><a href="#koa2-快速开始" class="headerlink" title="koa2 快速开始"></a>koa2 快速开始</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><ul>
<li>因为node.js v7.6.0开始完全支持async/await，不需要加flag，所以node.js环境都要7.6.0以上</li>
<li>node.js环境 版本v7.6以上<ul>
<li>直接安装node.js 7.6：node.js官网地址<a href="https://nodejs.org" target="_blank" rel="noopener">https://nodejs.org</a> </li>
<li>nvm管理多版本node.js：可以用nvm 进行node版本进行管理<ul>
<li>Mac系统安装nvm <a href="https://github.com/creationix/nvm#manual-install" target="_blank" rel="noopener">https://github.com/creationix/nvm#manual-install</a></li>
<li>windows系统安装nvm <a href="https://github.com/coreybutler/nvm-windows" target="_blank" rel="noopener">https://github.com/coreybutler/nvm-windows</a></li>
<li>Ubuntu系统安装nvm <a href="https://github.com/creationix/nvm" target="_blank" rel="noopener">https://github.com/creationix/nvm</a></li>
</ul>
</li>
</ul>
</li>
<li>npm 版本3.x以上 </li>
</ul>
<h3 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h3><h4 id="安装koa2"><a href="#安装koa2" class="headerlink" title="安装koa2"></a>安装koa2</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 初始化package.json</span></span><br><span class="line">npm init</span><br><span class="line"></span><br><span class="line"><span class="comment">## 安装koa2 </span></span><br><span class="line">npm install koa</span><br></pre></td></tr></table></figure>
<h4 id="hello-world-代码"><a href="#hello-world-代码" class="headerlink" title="hello world 代码"></a>hello world 代码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line">app.use( <span class="keyword">async</span> ( ctx ) =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">'hello koa2'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'[demo] start-quick is starting at port 3000'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="启动demo"><a href="#启动demo" class="headerlink" title="启动demo"></a>启动demo</h4><p>由于koa2是基于async/await操作中间件，目前node.js 7.x的harmony模式下才能使用，所以启动的时的脚本如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node index.js</span><br></pre></td></tr></table></figure>
<p>访问<a href="http:localhost:3000" target="_blank" rel="noopener">http:localhost:3000</a>，效果如下</p>
<p><img src="/2023/05/16/Koa2学习笔记/images/start-result-01.png" alt="start-result-01"></p>
<h2 id="async-await使用"><a href="#async-await使用" class="headerlink" title="async/await使用"></a>async/await使用</h2><h3 id="快速上手理解"><a href="#快速上手理解" class="headerlink" title="快速上手理解"></a>快速上手理解</h3><p> 先复制以下这段代码，在粘贴在chrome的控制台console中，按回车键执行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSyncTime</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> startTime = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime()</span><br><span class="line">      setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> endTime = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime()</span><br><span class="line">        <span class="keyword">let</span> data = endTime - startTime</span><br><span class="line">        resolve( data )</span><br><span class="line">      &#125;, <span class="number">500</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> ( err ) &#123;</span><br><span class="line">      reject( err )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getSyncData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> time = <span class="keyword">await</span> getSyncTime()</span><br><span class="line">  <span class="keyword">let</span> data = <span class="string">`endTime - startTime = <span class="subst">$&#123;time&#125;</span>`</span></span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data = <span class="keyword">await</span> getSyncData()</span><br><span class="line">  <span class="built_in">console</span>.log( data )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getData()</span><br></pre></td></tr></table></figure>
<h4 id="在chrome的console中执行结果如下"><a href="#在chrome的console中执行结果如下" class="headerlink" title="在chrome的console中执行结果如下"></a>在chrome的console中执行结果如下</h4><p><img src="/2023/05/16/Koa2学习笔记/images/async.png" alt="async"></p>
<h4 id="从上述例子可以看出-async-await-的特点："><a href="#从上述例子可以看出-async-await-的特点：" class="headerlink" title="从上述例子可以看出 async/await 的特点："></a>从上述例子可以看出 async/await 的特点：</h4><ul>
<li>可以让异步逻辑用同步写法实现</li>
<li>最底层的await返回需要是Promise对象</li>
<li>可以通过多层 async function 的同步写法代替传统的callback嵌套<h2 id="koa2简析结构"><a href="#koa2简析结构" class="headerlink" title="koa2简析结构"></a>koa2简析结构</h2></li>
</ul>
<h3 id="源码文件"><a href="#源码文件" class="headerlink" title="源码文件"></a>源码文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">├── lib</span><br><span class="line">│   ├── application.js</span><br><span class="line">│   ├── context.js</span><br><span class="line">│   ├── request.js</span><br><span class="line">│   └── response.js</span><br><span class="line">└── package.json</span><br></pre></td></tr></table></figure>
<p>这个就是 <code>GitHub</code> <a href="https://github.com/koajs/koa/" target="_blank" rel="noopener">https://github.com/koajs/koa</a>上开源的koa2源码的源文件结构，核心代码就是lib目录下的四个文件</p>
<ul>
<li>application.js 是整个koa2 的入口文件，封装了context，request，response，以及最核心的中间件处理流程。</li>
<li>context.js   处理应用上下文，里面直接封装部分request.js和response.js的方法</li>
<li>request.js   处理http请求</li>
<li>response.js  处理http响应</li>
</ul>
<h3 id="koa2特性"><a href="#koa2特性" class="headerlink" title="koa2特性"></a>koa2特性</h3><ul>
<li>只提供封装好http上下文、请求、响应，以及基于<code>async/await</code>的中间件容器。</li>
<li>利用ES7的<code>async/await</code>的来处理传统回调嵌套问题和代替koa@1的generator，但是需要在node.js 7.x的harmony模式下才能支持<code>async/await</code>。</li>
<li>中间件只支持 <code>async/await</code> 封装的，如果要使用koa@1基于generator中间件，需要通过中间件koa-convert封装一下才能使用。<h2 id="koa中间件开发和使用"><a href="#koa中间件开发和使用" class="headerlink" title="koa中间件开发和使用"></a>koa中间件开发和使用</h2></li>
</ul>
<blockquote>
<p>注：原文地址在我的博客issue里<a href="https://github.com/ChenShenhai/blog/issues/15" target="_blank" rel="noopener">https://github.com/ChenShenhai/blog/issues/15</a></p>
</blockquote>
<ul>
<li>koa v1和v2中使用到的中间件的开发和使用</li>
<li>generator 中间件开发在koa v1和v2中使用</li>
<li>async await 中间件开发和只能在koa v2中使用</li>
</ul>
<h3 id="generator中间件开发"><a href="#generator中间件开发" class="headerlink" title="generator中间件开发"></a>generator中间件开发</h3><h4 id="generator中间件开发-1"><a href="#generator中间件开发-1" class="headerlink" title="generator中间件开发"></a>generator中间件开发</h4><blockquote>
<p>generator中间件返回的应该是function * () 函数</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ./middleware/logger-generator.js */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params"> ctx </span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log( ctx.method, ctx.header.host + ctx.url )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> * (<span class="params"> next </span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行中间件的操作</span></span><br><span class="line">        log( <span class="keyword">this</span> )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( next ) &#123;</span><br><span class="line">            <span class="keyword">yield</span> next</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="generator中间件在koa-1中的使用"><a href="#generator中间件在koa-1中的使用" class="headerlink" title="generator中间件在koa@1中的使用"></a>generator中间件在koa@1中的使用</h4><blockquote>
<p>generator 中间件在koa v1中可以直接use使用</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)  <span class="comment">// koa v1</span></span><br><span class="line"><span class="keyword">const</span> loggerGenerator  = <span class="built_in">require</span>(<span class="string">'./middleware/logger-generator'</span>)</span><br><span class="line"><span class="keyword">const</span> app = koa()</span><br><span class="line"></span><br><span class="line">app.use(loggerGenerator())</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span> *(<span class="params"> </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.body = <span class="string">'hello world!'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'the server is starting at port 3000'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="generator中间件在koa-2中的使用"><a href="#generator中间件在koa-2中的使用" class="headerlink" title="generator中间件在koa@2中的使用"></a>generator中间件在koa@2中的使用</h4><blockquote>
<p>generator 中间件在koa v2中需要用koa-convert封装一下才能使用</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>) <span class="comment">// koa v2</span></span><br><span class="line"><span class="keyword">const</span> convert = <span class="built_in">require</span>(<span class="string">'koa-convert'</span>)</span><br><span class="line"><span class="keyword">const</span> loggerGenerator  = <span class="built_in">require</span>(<span class="string">'./middleware/logger-generator'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line">app.use(convert(loggerGenerator()))</span><br><span class="line"></span><br><span class="line">app.use(<span class="function">(<span class="params"> ctx </span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.body = <span class="string">'hello world!'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'the server is starting at port 3000'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="async中间件开发"><a href="#async中间件开发" class="headerlink" title="async中间件开发"></a>async中间件开发</h3><h4 id="async-中间件开发"><a href="#async-中间件开发" class="headerlink" title="async 中间件开发"></a>async 中间件开发</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ./middleware/logger-async.js */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params"> ctx </span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log( ctx.method, ctx.header.host + ctx.url )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"> ctx, next </span>) </span>&#123;</span><br><span class="line">    log(ctx);</span><br><span class="line">    <span class="keyword">await</span> next()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="async-中间件在koa-2中使用"><a href="#async-中间件在koa-2中使用" class="headerlink" title="async 中间件在koa@2中使用"></a>async 中间件在koa@2中使用</h4><blockquote>
<p>async 中间件只能在 koa v2中使用</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>) <span class="comment">// koa v2</span></span><br><span class="line"><span class="keyword">const</span> loggerAsync  = <span class="built_in">require</span>(<span class="string">'./middleware/logger-async'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line">app.use(loggerAsync())</span><br><span class="line"></span><br><span class="line">app.use(<span class="function">(<span class="params"> ctx </span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.body = <span class="string">'hello world!'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'the server is starting at port 3000'</span>)</span><br></pre></td></tr></table></figure>
<h1 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h1><h2 id="koa2-原生路由实现"><a href="#koa2-原生路由实现" class="headerlink" title="koa2 原生路由实现"></a>koa2 原生路由实现</h2><h3 id="简单例子"><a href="#简单例子" class="headerlink" title="简单例子"></a>简单例子</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line">app.use( <span class="keyword">async</span> ( ctx ) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> url = ctx.request.url</span><br><span class="line">  ctx.body = url</span><br><span class="line">&#125;)</span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>
<p>访问 <a href="http://localhost:3000/hello/world" target="_blank" rel="noopener">http://localhost:3000/hello/world</a> 页面会输出 /hello/world，也就是说上下文的请求request对象中url之就是当前访问的路径名称，可以根据ctx.request.url 通过一定的判断或者正则匹配就可以定制出所需要的路由。</p>
<h3 id="定制化的路由"><a href="#定制化的路由" class="headerlink" title="定制化的路由"></a>定制化的路由</h3><p>demo源码</p>
<p><a href="https://github.com/ChenShenhai/koa2-note/tree/master/demo/route-simple" target="_blank" rel="noopener">https://github.com/ChenShenhai/koa2-note/tree/master/demo/route-simple</a></p>
<h4 id="源码文件目录"><a href="#源码文件目录" class="headerlink" title="源码文件目录"></a>源码文件目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── index.js</span><br><span class="line">├── package.json</span><br><span class="line">└── view</span><br><span class="line">    ├── 404.html</span><br><span class="line">    ├── index.html</span><br><span class="line">    └── todo.html</span><br></pre></td></tr></table></figure>
<h4 id="demo源码"><a href="#demo源码" class="headerlink" title="demo源码"></a>demo源码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用Promise封装异步读取文件方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>page html文件名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;promise&#125;</span>      </span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"> page </span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params"> resolve, reject </span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> viewUrl = <span class="string">`./view/<span class="subst">$&#123;page&#125;</span>`</span></span><br><span class="line">    fs.readFile(viewUrl, <span class="string">"binary"</span>, ( err, data ) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> ( err ) &#123;</span><br><span class="line">        reject( err )</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve( data )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据URL获取HTML内容</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>url koa2上下文的url，ctx.url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;string&#125;</span>     </span>获取HTML文件内容</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">route</span>(<span class="params"> url </span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> view = <span class="string">'404.html'</span></span><br><span class="line">  <span class="keyword">switch</span> ( url ) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line">      view = <span class="string">'index.html'</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'/index'</span>:</span><br><span class="line">      view = <span class="string">'index.html'</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'/todo'</span>:</span><br><span class="line">      view = <span class="string">'todo.html'</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'/404'</span>:</span><br><span class="line">      view = <span class="string">'404.html'</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> html = <span class="keyword">await</span> render( view )</span><br><span class="line">  <span class="keyword">return</span> html</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use( <span class="keyword">async</span> ( ctx ) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> url = ctx.request.url</span><br><span class="line">  <span class="keyword">let</span> html = <span class="keyword">await</span> route( url )</span><br><span class="line">  ctx.body = html</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'[demo] route-simple is starting at port 3000'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="运行demo"><a href="#运行demo" class="headerlink" title="运行demo"></a>运行demo</h4><h5 id="执行运行脚本"><a href="#执行运行脚本" class="headerlink" title="执行运行脚本"></a>执行运行脚本</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node -harmony index.js</span><br></pre></td></tr></table></figure>
<h5 id="运行效果如下"><a href="#运行效果如下" class="headerlink" title="运行效果如下"></a>运行效果如下</h5><p>访问<a href="http://localhost:3000/index" target="_blank" rel="noopener">http://localhost:3000/index</a><br><img src="/2023/05/16/Koa2学习笔记/images/route-result-01.png" alt="route-result-01">## koa-router中间件</p>
<p>如果依靠ctx.request.url去手动处理路由，将会写很多处理代码，这时候就需要对应的路由的中间件对路由进行控制，这里介绍一个比较好用的路由中间件koa-router</p>
<h3 id="安装koa-router中间件"><a href="#安装koa-router中间件" class="headerlink" title="安装koa-router中间件"></a>安装koa-router中间件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## koa2 对应的版本是 7.x</span></span><br><span class="line">npm install --save koa-router@7</span><br></pre></td></tr></table></figure>
<h3 id="快速使用koa-router"><a href="#快速使用koa-router" class="headerlink" title="快速使用koa-router"></a>快速使用koa-router</h3><p>demo源码</p>
<p><a href="https://github.com/ChenShenhai/koa2-note/tree/master/demo/route-use-middleware" target="_blank" rel="noopener">https://github.com/ChenShenhai/koa2-note/tree/master/demo/route-use-middleware</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> home = <span class="keyword">new</span> Router()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子路由1</span></span><br><span class="line">home.get(<span class="string">'/'</span>, <span class="keyword">async</span> ( ctx )=&gt;&#123;</span><br><span class="line">  <span class="keyword">let</span> html = <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;ul&gt;</span></span><br><span class="line"><span class="string">      &lt;li&gt;&lt;a href="/page/helloworld"&gt;/page/helloworld&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">      &lt;li&gt;&lt;a href="/page/404"&gt;/page/404&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;/ul&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">  ctx.body = html</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子路由2</span></span><br><span class="line"><span class="keyword">let</span> page = <span class="keyword">new</span> Router()</span><br><span class="line">page.get(<span class="string">'/404'</span>, <span class="keyword">async</span> ( ctx )=&gt;&#123;</span><br><span class="line">  ctx.body = <span class="string">'404 page!'</span></span><br><span class="line">&#125;).get(<span class="string">'/helloworld'</span>, <span class="keyword">async</span> ( ctx )=&gt;&#123;</span><br><span class="line">  ctx.body = <span class="string">'helloworld page!'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 装载所有子路由</span></span><br><span class="line"><span class="keyword">let</span> router = <span class="keyword">new</span> Router()</span><br><span class="line">router.use(<span class="string">'/'</span>, home.routes(), home.allowedMethods())</span><br><span class="line">router.use(<span class="string">'/page'</span>, page.routes(), page.allowedMethods())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载路由中间件</span></span><br><span class="line">app.use(router.routes()).use(router.allowedMethods())</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'[demo] route-use-middleware is starting at port 3000'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h1 id="请求数据获取"><a href="#请求数据获取" class="headerlink" title="请求数据获取"></a>请求数据获取</h1><h2 id="GET请求数据获取"><a href="#GET请求数据获取" class="headerlink" title="GET请求数据获取"></a>GET请求数据获取</h2><h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><p>在koa中，获取GET请求数据源头是koa中request对象中的query方法或querystring方法，query返回是格式化好的参数对象，querystring返回的是请求字符串，由于ctx对request的API有直接引用的方式，所以获取GET请求数据有两个途径。</p>
<ul>
<li>1.是从上下文中直接获取<ul>
<li>请求对象ctx.query，返回如 { a:1, b:2 }</li>
<li>请求字符串 ctx.querystring，返回如 a=1&amp;b=2</li>
</ul>
</li>
<li>2.是从上下文的request对象中获取<ul>
<li>请求对象ctx.request.query，返回如 { a:1, b:2 }</li>
<li>请求字符串 ctx.request.querystring，返回如 a=1&amp;b=2</li>
</ul>
</li>
</ul>
<h3 id="举个例子"><a href="#举个例子" class="headerlink" title="举个例子"></a>举个例子</h3><p>demo源码</p>
<p><a href="https://github.com/ChenShenhai/koa2-note/blob/master/demo/request/get.js" target="_blank" rel="noopener">https://github.com/ChenShenhai/koa2-note/blob/master/demo/request/get.js</a></p>
<h4 id="例子代码"><a href="#例子代码" class="headerlink" title="例子代码"></a>例子代码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line">app.use( <span class="keyword">async</span> ( ctx ) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> url = ctx.url</span><br><span class="line">  <span class="comment">// 从上下文的request对象中获取</span></span><br><span class="line">  <span class="keyword">let</span> request = ctx.request</span><br><span class="line">  <span class="keyword">let</span> req_query = request.query</span><br><span class="line">  <span class="keyword">let</span> req_querystring = request.querystring</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 从上下文中直接获取</span></span><br><span class="line">  <span class="keyword">let</span> ctx_query = ctx.query</span><br><span class="line">  <span class="keyword">let</span> ctx_querystring = ctx.querystring</span><br><span class="line">  </span><br><span class="line">  ctx.body = &#123;</span><br><span class="line">    url,</span><br><span class="line">    req_query,</span><br><span class="line">    req_querystring,</span><br><span class="line">    ctx_query,</span><br><span class="line">    ctx_querystring</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'[demo] request get is starting at port 3000'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="执行程序"><a href="#执行程序" class="headerlink" title="执行程序"></a>执行程序</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node get.js</span><br></pre></td></tr></table></figure>
<p>执行后程序后，用chrome访问 <a href="http://localhost:3000/page/user?a=1&amp;b=2" target="_blank" rel="noopener">http://localhost:3000/page/user?a=1&amp;b=2</a> 会出现以下情况</p>
<blockquote>
<p>注意：我是用了chrome的json格式化插件才会显示json的格式化</p>
</blockquote>
<p><img src="/2023/05/16/Koa2学习笔记/images/request-get.png" alt="request-get"></p>
<h2 id="POST请求参数获取"><a href="#POST请求参数获取" class="headerlink" title="POST请求参数获取"></a>POST请求参数获取</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>对于POST请求的处理，koa2没有封装获取参数的方法，需要通过解析上下文context中的原生node.js请求对象req，将POST表单数据解析成query string（例如：<code>a=1&amp;b=2&amp;c=3</code>），再将query string 解析成JSON格式（例如：<code>{&quot;a&quot;:&quot;1&quot;, &quot;b&quot;:&quot;2&quot;, &quot;c&quot;:&quot;3&quot;}</code>）</p>
<blockquote>
<p>注意：ctx.request是context经过封装的请求对象，ctx.req是context提供的node.js原生HTTP请求对象，同理ctx.response是context经过封装的响应对象，ctx.res是context提供的node.js原生HTTP响应对象。</p>
</blockquote>
<blockquote>
<p>具体koa2 API文档可见 <a href="https://github.com/koajs/koa/blob/master/docs/api/context.md#ctxreq" target="_blank" rel="noopener">https://github.com/koajs/koa/blob/master/docs/api/context.md#ctxreq</a></p>
</blockquote>
<h4 id="解析出POST请求上下文中的表单数据"><a href="#解析出POST请求上下文中的表单数据" class="headerlink" title="解析出POST请求上下文中的表单数据"></a>解析出POST请求上下文中的表单数据</h4><p>demo源码</p>
<p><a href="https://github.com/ChenShenhai/koa2-note/blob/master/demo/request/post.js" target="_blank" rel="noopener">https://github.com/ChenShenhai/koa2-note/blob/master/demo/request/post.js</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析上下文里node原生请求的POST参数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parsePostData</span>(<span class="params"> ctx </span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> postdata = <span class="string">""</span>;</span><br><span class="line">      ctx.req.addListener(<span class="string">'data'</span>, (data) =&gt; &#123;</span><br><span class="line">        postdata += data</span><br><span class="line">      &#125;)</span><br><span class="line">      ctx.req.addListener(<span class="string">"end"</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> parseData = parseQueryStr( postdata )</span><br><span class="line">        resolve( parseData )</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> ( err ) &#123;</span><br><span class="line">      reject(err)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将POST请求参数字符串解析成JSON</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseQueryStr</span>(<span class="params"> queryStr </span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> queryData = &#123;&#125;</span><br><span class="line">  <span class="keyword">let</span> queryStrList = queryStr.split(<span class="string">'&amp;'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log( queryStrList )</span><br><span class="line">  <span class="keyword">for</span> (  <span class="keyword">let</span> [ index, queryStr ] <span class="keyword">of</span> queryStrList.entries()  ) &#123;</span><br><span class="line">    <span class="keyword">let</span> itemList = queryStr.split(<span class="string">'='</span>)</span><br><span class="line">    queryData[ itemList[<span class="number">0</span>] ] = <span class="built_in">decodeURIComponent</span>(itemList[<span class="number">1</span>])</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> queryData</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="举个例子-1"><a href="#举个例子-1" class="headerlink" title="举个例子"></a>举个例子</h3><p>源码在 /demos/request/post.js中</p>
<h4 id="例子代码-1"><a href="#例子代码-1" class="headerlink" title="例子代码"></a>例子代码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line">app.use( <span class="keyword">async</span> ( ctx ) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( ctx.url === <span class="string">'/'</span> &amp;&amp; ctx.method === <span class="string">'GET'</span> ) &#123;</span><br><span class="line">    <span class="comment">// 当GET请求时候返回表单页面</span></span><br><span class="line">    <span class="keyword">let</span> html = <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;h1&gt;koa2 request post demo&lt;/h1&gt;</span></span><br><span class="line"><span class="string">      &lt;form method="POST" action="/"&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;userName&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;input name="userName" /&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;nickName&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;input name="nickName" /&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;email&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;input name="email" /&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">        &lt;button type="submit"&gt;submit&lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;/form&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">    ctx.body = html</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( ctx.url === <span class="string">'/'</span> &amp;&amp; ctx.method === <span class="string">'POST'</span> ) &#123;</span><br><span class="line">    <span class="comment">// 当POST请求的时候，解析POST表单里的数据，并显示出来</span></span><br><span class="line">    <span class="keyword">let</span> postData = <span class="keyword">await</span> parsePostData( ctx )</span><br><span class="line">    ctx.body = postData</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 其他请求显示404</span></span><br><span class="line">    ctx.body = <span class="string">'&lt;h1&gt;404！！！ o(╯□╰)o&lt;/h1&gt;'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析上下文里node原生请求的POST参数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parsePostData</span>(<span class="params"> ctx </span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> postdata = <span class="string">""</span>;</span><br><span class="line">      ctx.req.addListener(<span class="string">'data'</span>, (data) =&gt; &#123;</span><br><span class="line">        postdata += data</span><br><span class="line">      &#125;)</span><br><span class="line">      ctx.req.addListener(<span class="string">"end"</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> parseData = parseQueryStr( postdata )</span><br><span class="line">        resolve( parseData )</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> ( err ) &#123;</span><br><span class="line">      reject(err)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将POST请求参数字符串解析成JSON</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseQueryStr</span>(<span class="params"> queryStr </span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> queryData = &#123;&#125;</span><br><span class="line">  <span class="keyword">let</span> queryStrList = queryStr.split(<span class="string">'&amp;'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log( queryStrList )</span><br><span class="line">  <span class="keyword">for</span> (  <span class="keyword">let</span> [ index, queryStr ] <span class="keyword">of</span> queryStrList.entries()  ) &#123;</span><br><span class="line">    <span class="keyword">let</span> itemList = queryStr.split(<span class="string">'='</span>)</span><br><span class="line">    queryData[ itemList[<span class="number">0</span>] ] = <span class="built_in">decodeURIComponent</span>(itemList[<span class="number">1</span>])</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> queryData</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'[demo] request post is starting at port 3000'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="启动例子"><a href="#启动例子" class="headerlink" title="启动例子"></a>启动例子</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node post.js</span><br></pre></td></tr></table></figure>
<h4 id="访问页面"><a href="#访问页面" class="headerlink" title="访问页面"></a>访问页面</h4><p><img src="/2023/05/16/Koa2学习笔记/images/request-post-form.png" alt="request-post-form"></p>
<h4 id="提交表单发起POST请求结果显示"><a href="#提交表单发起POST请求结果显示" class="headerlink" title="提交表单发起POST请求结果显示"></a>提交表单发起POST请求结果显示</h4><p><img src="/2023/05/16/Koa2学习笔记/images/request-post-result.png" alt="request-post-result"></p>
<h2 id="koa-bodyparser中间件"><a href="#koa-bodyparser中间件" class="headerlink" title="koa-bodyparser中间件"></a>koa-bodyparser中间件</h2><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>对于POST请求的处理，koa-bodyparser中间件可以把koa2上下文的formData数据解析到ctx.request.body中</p>
<h4 id="安装koa2版本的koa-bodyparser-3中间件"><a href="#安装koa2版本的koa-bodyparser-3中间件" class="headerlink" title="安装koa2版本的koa-bodyparser@3中间件"></a>安装koa2版本的koa-bodyparser@3中间件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save koa-bodyparser@3</span><br></pre></td></tr></table></figure>
<h3 id="举个例子-2"><a href="#举个例子-2" class="headerlink" title="举个例子"></a>举个例子</h3><h4 id="例子代码-2"><a href="#例子代码-2" class="headerlink" title="例子代码"></a>例子代码</h4><p>demo源码</p>
<p> <a href="https://github.com/ChenShenhai/koa2-note/blob/master/demo/request/post-middleware.js" target="_blank" rel="noopener">https://github.com/ChenShenhai/koa2-note/blob/master/demo/request/post-middleware.js</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用ctx.body解析中间件</span></span><br><span class="line">app.use(bodyParser())</span><br><span class="line"></span><br><span class="line">app.use( <span class="keyword">async</span> ( ctx ) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( ctx.url === <span class="string">'/'</span> &amp;&amp; ctx.method === <span class="string">'GET'</span> ) &#123;</span><br><span class="line">    <span class="comment">// 当GET请求时候返回表单页面</span></span><br><span class="line">    <span class="keyword">let</span> html = <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;h1&gt;koa2 request post demo&lt;/h1&gt;</span></span><br><span class="line"><span class="string">      &lt;form method="POST" action="/"&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;userName&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;input name="userName" /&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;nickName&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;input name="nickName" /&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;email&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;input name="email" /&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">        &lt;button type="submit"&gt;submit&lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;/form&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">    ctx.body = html</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( ctx.url === <span class="string">'/'</span> &amp;&amp; ctx.method === <span class="string">'POST'</span> ) &#123;</span><br><span class="line">    <span class="comment">// 当POST请求的时候，中间件koa-bodyparser解析POST表单里的数据，并显示出来</span></span><br><span class="line">    <span class="keyword">let</span> postData = ctx.request.body</span><br><span class="line">    ctx.body = postData</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 其他请求显示404</span></span><br><span class="line">    ctx.body = <span class="string">'&lt;h1&gt;404！！！ o(╯□╰)o&lt;/h1&gt;'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'[demo] request post is starting at port 3000'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="启动例子-1"><a href="#启动例子-1" class="headerlink" title="启动例子"></a>启动例子</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node post-middleware.js</span><br></pre></td></tr></table></figure>
<h4 id="访问页面-1"><a href="#访问页面-1" class="headerlink" title="访问页面"></a>访问页面</h4><p><img src="/2023/05/16/Koa2学习笔记/images/request-post-form.png" alt="request-post-form"></p>
<h4 id="提交表单发起POST请求结果显示-1"><a href="#提交表单发起POST请求结果显示-1" class="headerlink" title="提交表单发起POST请求结果显示"></a>提交表单发起POST请求结果显示</h4><p><img src="/2023/05/16/Koa2学习笔记/images/request-post-result.png" alt="request-post-result"></p>
<h1 id="静态资源加载"><a href="#静态资源加载" class="headerlink" title="静态资源加载"></a>静态资源加载</h1><h2 id="原生koa2实现静态资源服务器"><a href="#原生koa2实现静态资源服务器" class="headerlink" title="原生koa2实现静态资源服务器"></a>原生koa2实现静态资源服务器</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>一个http请求访问web服务静态资源，一般响应结果有三种情况</p>
<ul>
<li>访问文本，例如js，css，png，jpg，gif</li>
<li>访问静态目录</li>
<li>找不到资源，抛出404错误</li>
</ul>
<h3 id="原生koa2-静态资源服务器例子"><a href="#原生koa2-静态资源服务器例子" class="headerlink" title="原生koa2 静态资源服务器例子"></a>原生koa2 静态资源服务器例子</h3><p>demo源码 </p>
<p><a href="https://github.com/ChenShenhai/koa2-note/blob/master/demo/static-server/" target="_blank" rel="noopener">https://github.com/ChenShenhai/koa2-note/blob/master/demo/static-server/</a></p>
<h4 id="代码目录"><a href="#代码目录" class="headerlink" title="代码目录"></a>代码目录</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">├── static <span class="comment">## 静态资源目录</span></span><br><span class="line">│   ├── css/</span><br><span class="line">│   ├── image/</span><br><span class="line">│   ├── js/</span><br><span class="line">│   └── index.html</span><br><span class="line">├── util <span class="comment">## 工具代码</span></span><br><span class="line">│   ├── content.js <span class="comment">## 读取请求内容</span></span><br><span class="line">│   ├── dir.js <span class="comment">## 读取目录内容</span></span><br><span class="line">│   ├── file.js <span class="comment">## 读取文件内容</span></span><br><span class="line">│   ├── mimes.js <span class="comment">## 文件类型列表</span></span><br><span class="line">│   └── walk.js <span class="comment">## 遍历目录内容</span></span><br><span class="line">└── index.js <span class="comment">## 启动入口文件</span></span><br></pre></td></tr></table></figure>
<h4 id="代码解析"><a href="#代码解析" class="headerlink" title="代码解析"></a>代码解析</h4><h5 id="index-js"><a href="#index-js" class="headerlink" title="index.js"></a>index.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> content = <span class="built_in">require</span>(<span class="string">'./util/content'</span>)</span><br><span class="line"><span class="keyword">const</span> mimes = <span class="built_in">require</span>(<span class="string">'./util/mimes'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 静态资源目录对于相对入口文件index.js的路径</span></span><br><span class="line"><span class="keyword">const</span> staticPath = <span class="string">'./static'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析资源类型</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseMime</span>(<span class="params"> url </span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> extName = path.extname( url )</span><br><span class="line">  extName = extName ?  extName.slice(<span class="number">1</span>) : <span class="string">'unknown'</span></span><br><span class="line">  <span class="keyword">return</span>  mimes[ extName ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use( <span class="keyword">async</span> ( ctx ) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 静态资源目录在本地的绝对路径</span></span><br><span class="line">  <span class="keyword">let</span> fullStaticPath = path.join(__dirname, staticPath)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取静态资源内容，有可能是文件内容，目录，或404</span></span><br><span class="line">  <span class="keyword">let</span> _content = <span class="keyword">await</span> content( ctx, fullStaticPath )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解析请求内容的类型</span></span><br><span class="line">  <span class="keyword">let</span> _mime = parseMime( ctx.url )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果有对应的文件类型，就配置上下文的类型</span></span><br><span class="line">  <span class="keyword">if</span> ( _mime ) &#123;</span><br><span class="line">    ctx.type = _mime</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 输出静态资源内容</span></span><br><span class="line">  <span class="keyword">if</span> ( _mime &amp;&amp; _mime.indexOf(<span class="string">'image/'</span>) &gt;= <span class="number">0</span> ) &#123;</span><br><span class="line">    <span class="comment">// 如果是图片，则用node原生res，输出二进制数据</span></span><br><span class="line">    ctx.res.writeHead(<span class="number">200</span>)</span><br><span class="line">    ctx.res.write(_content, <span class="string">'binary'</span>)</span><br><span class="line">    ctx.res.end()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 其他则输出文本</span></span><br><span class="line">    ctx.body = _content</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'[demo] static-server is starting at port 3000'</span>)</span><br></pre></td></tr></table></figure>
<h5 id="util-content-js"><a href="#util-content-js" class="headerlink" title="util/content.js"></a>util/content.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 封装读取目录内容方法</span></span><br><span class="line"><span class="keyword">const</span> dir = <span class="built_in">require</span>(<span class="string">'./dir'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 封装读取文件内容方法</span></span><br><span class="line"><span class="keyword">const</span> file = <span class="built_in">require</span>(<span class="string">'./file'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取静态资源内容</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;object&#125;</span> </span>ctx koa上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>静态资源目录在本地的绝对路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return  <span class="type">&#123;string&#125;</span> </span>请求获取到的本地内容</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">content</span>(<span class="params"> ctx, fullStaticPath </span>) </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 封装请求资源的完绝对径</span></span><br><span class="line">  <span class="keyword">let</span> reqPath = path.join(fullStaticPath, ctx.url)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断请求路径是否为存在目录或者文件</span></span><br><span class="line">  <span class="keyword">let</span> exist = fs.existsSync( reqPath )</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 返回请求内容， 默认为空</span></span><br><span class="line">  <span class="keyword">let</span> content = <span class="string">''</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>( !exist ) &#123;</span><br><span class="line">    <span class="comment">//如果请求路径不存在，返回404</span></span><br><span class="line">    content = <span class="string">'404 Not Found! o(╯□╰)o！'</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//判断访问地址是文件夹还是文件</span></span><br><span class="line">    <span class="keyword">let</span> stat = fs.statSync( reqPath )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( stat.isDirectory() ) &#123;</span><br><span class="line">      <span class="comment">//如果为目录，则渲读取目录内容</span></span><br><span class="line">      content = dir( ctx.url, reqPath )</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 如果请求为文件，则读取文件内容</span></span><br><span class="line">      content = <span class="keyword">await</span> file( reqPath )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> content</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = content</span><br></pre></td></tr></table></figure>
<h5 id="util-dir-js"><a href="#util-dir-js" class="headerlink" title="util/dir.js"></a>util/dir.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历读取目录内容方法</span></span><br><span class="line"><span class="keyword">const</span> walk = <span class="built_in">require</span>(<span class="string">'./walk'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装目录内容</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>url 当前请求的上下文中的url，即ctx.url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>reqPath 请求静态资源的完整本地路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;string&#125;</span> </span>返回目录内容，封装成HTML</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dir</span> (<span class="params"> url, reqPath </span>) </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 遍历读取当前目录下的文件、子目录</span></span><br><span class="line">  <span class="keyword">let</span> contentList = walk( reqPath )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> html = <span class="string">`&lt;ul&gt;`</span></span><br><span class="line">  <span class="keyword">for</span> ( <span class="keyword">let</span> [ index, item ] <span class="keyword">of</span> contentList.entries() ) &#123;</span><br><span class="line">    html = <span class="string">`<span class="subst">$&#123;html&#125;</span>&lt;li&gt;&lt;a href="<span class="subst">$&#123;url === <span class="string">'/'</span> ? <span class="string">''</span> : url&#125;</span>/<span class="subst">$&#123;item&#125;</span>"&gt;<span class="subst">$&#123;item&#125;</span>&lt;/a&gt;`</span> </span><br><span class="line">  &#125;</span><br><span class="line">  html = <span class="string">`<span class="subst">$&#123;html&#125;</span>&lt;/ul&gt;`</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> html</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = dir</span><br></pre></td></tr></table></figure>
<h5 id="util-file-js"><a href="#util-file-js" class="headerlink" title="util/file.js"></a>util/file.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 读取文件方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>文件本地的绝对路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;string|binary&#125;</span> </span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">file</span> (<span class="params"> filePath </span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">let</span> content = fs.readFileSync(filePath, <span class="string">'binary'</span> )</span><br><span class="line"> <span class="keyword">return</span> content</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = file</span><br></pre></td></tr></table></figure>
<h5 id="util-walk-js"><a href="#util-walk-js" class="headerlink" title="util/walk.js"></a>util/walk.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> mimes = <span class="built_in">require</span>(<span class="string">'./mimes'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 遍历读取目录内容（子目录，文件名）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>reqPath 请求资源的绝对路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;array&#125;</span> </span>目录内容列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">walk</span>(<span class="params"> reqPath </span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> files = fs.readdirSync( reqPath );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> dirList = [], fileList = [];</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">let</span> i=<span class="number">0</span>, len=files.length; i&lt;len; i++ ) &#123;</span><br><span class="line">    <span class="keyword">let</span> item = files[i];</span><br><span class="line">    <span class="keyword">let</span> itemArr = item.split(<span class="string">"\."</span>);</span><br><span class="line">    <span class="keyword">let</span> itemMime = ( itemArr.length &gt; <span class="number">1</span> ) ? itemArr[ itemArr.length - <span class="number">1</span> ] : <span class="string">"undefined"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">typeof</span> mimes[ itemMime ] === <span class="string">"undefined"</span> ) &#123;</span><br><span class="line">      dirList.push( files[i] );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      fileList.push( files[i] );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> result = dirList.concat( fileList );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = walk;</span><br></pre></td></tr></table></figure>
<h5 id="util-mime-js"><a href="#util-mime-js" class="headerlink" title="util/mime.js"></a>util/mime.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> mimes = &#123;</span><br><span class="line">  <span class="string">'css'</span>: <span class="string">'text/css'</span>,</span><br><span class="line">  <span class="string">'less'</span>: <span class="string">'text/css'</span>,</span><br><span class="line">  <span class="string">'gif'</span>: <span class="string">'image/gif'</span>,</span><br><span class="line">  <span class="string">'html'</span>: <span class="string">'text/html'</span>,</span><br><span class="line">  <span class="string">'ico'</span>: <span class="string">'image/x-icon'</span>,</span><br><span class="line">  <span class="string">'jpeg'</span>: <span class="string">'image/jpeg'</span>,</span><br><span class="line">  <span class="string">'jpg'</span>: <span class="string">'image/jpeg'</span>,</span><br><span class="line">  <span class="string">'js'</span>: <span class="string">'text/javascript'</span>,</span><br><span class="line">  <span class="string">'json'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">  <span class="string">'pdf'</span>: <span class="string">'application/pdf'</span>,</span><br><span class="line">  <span class="string">'png'</span>: <span class="string">'image/png'</span>,</span><br><span class="line">  <span class="string">'svg'</span>: <span class="string">'image/svg+xml'</span>,</span><br><span class="line">  <span class="string">'swf'</span>: <span class="string">'application/x-shockwave-flash'</span>,</span><br><span class="line">  <span class="string">'tiff'</span>: <span class="string">'image/tiff'</span>,</span><br><span class="line">  <span class="string">'txt'</span>: <span class="string">'text/plain'</span>,</span><br><span class="line">  <span class="string">'wav'</span>: <span class="string">'audio/x-wav'</span>,</span><br><span class="line">  <span class="string">'wma'</span>: <span class="string">'audio/x-ms-wma'</span>,</span><br><span class="line">  <span class="string">'wmv'</span>: <span class="string">'video/x-ms-wmv'</span>,</span><br><span class="line">  <span class="string">'xml'</span>: <span class="string">'text/xml'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = mimes</span><br></pre></td></tr></table></figure>
<h4 id="运行效果"><a href="#运行效果" class="headerlink" title="运行效果"></a>运行效果</h4><h5 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node index.js</span><br></pre></td></tr></table></figure>
<h5 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h5><h6 id="访问http-localhost-3000"><a href="#访问http-localhost-3000" class="headerlink" title="访问http://localhost:3000"></a>访问<a href="http://localhost:3000" target="_blank" rel="noopener">http://localhost:3000</a></h6><p><img src="/2023/05/16/Koa2学习笔记/images/static-server-result-01.png" alt="static-server-result"></p>
<h6 id="访问http-localhost-3000-index-html"><a href="#访问http-localhost-3000-index-html" class="headerlink" title="访问http://localhost:3000/index.html"></a>访问<a href="http://localhost:3000/index.html" target="_blank" rel="noopener">http://localhost:3000/index.html</a></h6><p><img src="/2023/05/16/Koa2学习笔记/images/static-server-result-02.png" alt="static-server-result"></p>
<h6 id="访问http-localhost-3000-js-index-js"><a href="#访问http-localhost-3000-js-index-js" class="headerlink" title="访问http://localhost:3000/js/index.js"></a>访问<a href="http://localhost:3000/js/index.js" target="_blank" rel="noopener">http://localhost:3000/js/index.js</a></h6><p><img src="/2023/05/16/Koa2学习笔记/images/static-server-result-03.png" alt="static-server-result"></p>
<h2 id="koa-static中间件使用"><a href="#koa-static中间件使用" class="headerlink" title="koa-static中间件使用"></a>koa-static中间件使用</h2><h3 id="使用例子"><a href="#使用例子" class="headerlink" title="使用例子"></a>使用例子</h3><p>demo源码</p>
<p><a href="https://github.com/ChenShenhai/koa2-note/blob/master/demo/static-use-middleware/" target="_blank" rel="noopener">https://github.com/ChenShenhai/koa2-note/blob/master/demo/static-use-middleware/</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> = <span class="built_in">require</span>(<span class="string">'koa-static'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 静态资源目录对于相对入口文件index.js的路径</span></span><br><span class="line"><span class="keyword">const</span> staticPath = <span class="string">'./static'</span></span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">static</span>(</span><br><span class="line">  path.join( __dirname,  staticPath)</span><br><span class="line">))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use( <span class="keyword">async</span> ( ctx ) =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">'hello world'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'[demo] static-use-middleware is starting at port 3000'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h5 id="效果-1"><a href="#效果-1" class="headerlink" title="效果"></a>效果</h5><h6 id="访问http-localhost-3000-1"><a href="#访问http-localhost-3000-1" class="headerlink" title="访问http://localhost:3000"></a>访问<a href="http://localhost:3000" target="_blank" rel="noopener">http://localhost:3000</a></h6><p><img src="/2023/05/16/Koa2学习笔记/images/static-server-result-01.png" alt="static-server-result"></p>
<h6 id="访问http-localhost-3000-index-html-1"><a href="#访问http-localhost-3000-index-html-1" class="headerlink" title="访问http://localhost:3000/index.html"></a>访问<a href="http://localhost:3000/index.html" target="_blank" rel="noopener">http://localhost:3000/index.html</a></h6><p><img src="/2023/05/16/Koa2学习笔记/images/static-server-result-02.png" alt="static-server-result"></p>
<h6 id="访问http-localhost-3000-js-index-js-1"><a href="#访问http-localhost-3000-js-index-js-1" class="headerlink" title="访问http://localhost:3000/js/index.js"></a>访问<a href="http://localhost:3000/js/index.js" target="_blank" rel="noopener">http://localhost:3000/js/index.js</a></h6><p><img src="/2023/05/16/Koa2学习笔记/images/static-server-result-03.png" alt="static-server-result"></p>
<h1 id="cookie-session"><a href="#cookie-session" class="headerlink" title="cookie/session"></a>cookie/session</h1><h2 id="koa2使用cookie"><a href="#koa2使用cookie" class="headerlink" title="koa2使用cookie"></a>koa2使用cookie</h2><h3 id="使用方法-1"><a href="#使用方法-1" class="headerlink" title="使用方法"></a>使用方法</h3><p>koa提供了从上下文直接读取、写入cookie的方法</p>
<ul>
<li>ctx.cookies.get(name, [options]) 读取上下文请求中的cookie</li>
<li>ctx.cookies.set(name, value, [options]) 在上下文中写入cookie</li>
</ul>
<p>koa2 中操作的cookies是使用了npm的cookies模块，源码在<a href="https://github.com/pillarjs/cookies" target="_blank" rel="noopener">https://github.com/pillarjs/cookies</a>，所以在读写cookie的使用参数与该模块的使用一致。</p>
<h3 id="例子代码-3"><a href="#例子代码-3" class="headerlink" title="例子代码"></a>例子代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line">app.use( <span class="keyword">async</span> ( ctx ) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( ctx.url === <span class="string">'/index'</span> ) &#123;</span><br><span class="line">    ctx.cookies.set(</span><br><span class="line">      <span class="string">'cid'</span>, </span><br><span class="line">      <span class="string">'hello world'</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        domain: <span class="string">'localhost'</span>,  <span class="comment">// 写cookie所在的域名</span></span><br><span class="line">        path: <span class="string">'/index'</span>,       <span class="comment">// 写cookie所在的路径</span></span><br><span class="line">        maxAge: <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000</span>, <span class="comment">// cookie有效时长</span></span><br><span class="line">        expires: <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">'2017-02-15'</span>),  <span class="comment">// cookie失效时间</span></span><br><span class="line">        httpOnly: <span class="literal">false</span>,  <span class="comment">// 是否只用于http请求中获取</span></span><br><span class="line">        overwrite: <span class="literal">false</span>  <span class="comment">// 是否允许重写</span></span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">    ctx.body = <span class="string">'cookie is ok'</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ctx.body = <span class="string">'hello world'</span> </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'[demo] cookie is starting at port 3000'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="运行例子"><a href="#运行例子" class="headerlink" title="运行例子"></a>运行例子</h3><h4 id="执行脚本"><a href="#执行脚本" class="headerlink" title="执行脚本"></a>执行脚本</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node index.js</span><br></pre></td></tr></table></figure>
<h4 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h4><h5 id="访问http-localhost-3000-index"><a href="#访问http-localhost-3000-index" class="headerlink" title="访问http://localhost:3000/index"></a>访问<a href="http://localhost:3000/index" target="_blank" rel="noopener">http://localhost:3000/index</a></h5><ul>
<li>可以在控制台的cookie列表中中看到写在页面上的cookie</li>
<li>在控制台的console中使用document.cookie可以打印出在页面的所有cookie（需要是httpOnly设置false才能显示）</li>
</ul>
<p><img src="/2023/05/16/Koa2学习笔记/images/cookie-result-01.png" alt="cookie-result-01"></p>
<h2 id="koa2实现session"><a href="#koa2实现session" class="headerlink" title="koa2实现session"></a>koa2实现session</h2><h3 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h3><p>koa2原生功能只提供了cookie的操作，但是没有提供session操作。session就只用自己实现或者通过第三方中间件实现。在koa2中实现session的方案有一下几种</p>
<ul>
<li>如果session数据量很小，可以直接存在内存中</li>
<li>如果session数据量很大，则需要存储介质存放session数据</li>
</ul>
<h3 id="数据库存储方案"><a href="#数据库存储方案" class="headerlink" title="数据库存储方案"></a>数据库存储方案</h3><ul>
<li>将session存放在MySQL数据库中</li>
<li>需要用到中间件<ul>
<li>koa-session-minimal 适用于koa2 的session中间件，提供存储介质的读写接口 。</li>
<li>koa-mysql-session 为koa-session-minimal中间件提供MySQL数据库的session数据读写操作。</li>
<li>将sessionId和对应的数据存到数据库</li>
</ul>
</li>
<li>将数据库的存储的sessionId存到页面的cookie中</li>
<li>根据cookie的sessionId去获取对于的session信息</li>
</ul>
<h3 id="快速使用"><a href="#快速使用" class="headerlink" title="快速使用"></a>快速使用</h3><p>demo源码 </p>
<p><a href="https://github.com/ChenShenhai/koa2-note/blob/master/demo/session/index.js" target="_blank" rel="noopener">https://github.com/ChenShenhai/koa2-note/blob/master/demo/session/index.js</a></p>
<h4 id="例子代码-4"><a href="#例子代码-4" class="headerlink" title="例子代码"></a>例子代码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'koa-session-minimal'</span>)</span><br><span class="line"><span class="keyword">const</span> MysqlSession = <span class="built_in">require</span>(<span class="string">'koa-mysql-session'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置存储session信息的mysql</span></span><br><span class="line"><span class="keyword">let</span> store = <span class="keyword">new</span> MysqlSession(&#123;</span><br><span class="line">  user: <span class="string">'root'</span>,</span><br><span class="line">  password: <span class="string">'abc123'</span>,</span><br><span class="line">  database: <span class="string">'koa_demo'</span>,</span><br><span class="line">  host: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 存放sessionId的cookie配置</span></span><br><span class="line"><span class="keyword">let</span> cookie = &#123;</span><br><span class="line">  maxAge: <span class="string">''</span>, <span class="comment">// cookie有效时长</span></span><br><span class="line">  expires: <span class="string">''</span>,  <span class="comment">// cookie失效时间</span></span><br><span class="line">  path: <span class="string">''</span>, <span class="comment">// 写cookie所在的路径</span></span><br><span class="line">  domain: <span class="string">''</span>, <span class="comment">// 写cookie所在的域名</span></span><br><span class="line">  httpOnly: <span class="string">''</span>, <span class="comment">// 是否只用于http请求中获取</span></span><br><span class="line">  overwrite: <span class="string">''</span>,  <span class="comment">// 是否允许重写</span></span><br><span class="line">  secure: <span class="string">''</span>,</span><br><span class="line">  sameSite: <span class="string">''</span>,</span><br><span class="line">  signed: <span class="string">''</span>,</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用session中间件</span></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">  key: <span class="string">'SESSION_ID'</span>,</span><br><span class="line">  store: store,</span><br><span class="line">  cookie: cookie</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">app.use( <span class="keyword">async</span> ( ctx ) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置session</span></span><br><span class="line">  <span class="keyword">if</span> ( ctx.url === <span class="string">'/set'</span> ) &#123;</span><br><span class="line">    ctx.session = &#123;</span><br><span class="line">      user_id: <span class="built_in">Math</span>.random().toString(<span class="number">36</span>).substr(<span class="number">2</span>),</span><br><span class="line">      count: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    ctx.body = ctx.session</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( ctx.url === <span class="string">'/'</span> ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取session信息</span></span><br><span class="line">    ctx.session.count = ctx.session.count + <span class="number">1</span></span><br><span class="line">    ctx.body = ctx.session</span><br><span class="line">  &#125; </span><br><span class="line">  </span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'[demo] session is starting at port 3000'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="运行例子-1"><a href="#运行例子-1" class="headerlink" title="运行例子"></a>运行例子</h4><h5 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node index.js</span><br></pre></td></tr></table></figure>
<h5 id="访问连接设置session"><a href="#访问连接设置session" class="headerlink" title="访问连接设置session"></a>访问连接设置session</h5><p><a href="http://localhost:3000/set" target="_blank" rel="noopener">http://localhost:3000/set</a><br><img src="/2023/05/16/Koa2学习笔记/images/session-result-01.png" alt="session-result-01"></p>
<h5 id="查看数据库session是否存储"><a href="#查看数据库session是否存储" class="headerlink" title="查看数据库session是否存储"></a>查看数据库session是否存储</h5><p><img src="/2023/05/16/Koa2学习笔记/images/session-result-03.png" alt="session-result-01"></p>
<h5 id="查看cookie中是否种下了sessionId"><a href="#查看cookie中是否种下了sessionId" class="headerlink" title="查看cookie中是否种下了sessionId"></a>查看cookie中是否种下了sessionId</h5><p><a href="http://localhost:3000" target="_blank" rel="noopener">http://localhost:3000</a><br><img src="/2023/05/16/Koa2学习笔记/images/session-result-02.png" alt="session-result-01"></p>
<h1 id="模板引擎"><a href="#模板引擎" class="headerlink" title="模板引擎"></a>模板引擎</h1><h2 id="koa2加载模板引擎"><a href="#koa2加载模板引擎" class="headerlink" title="koa2加载模板引擎"></a>koa2加载模板引擎</h2><h3 id="快速开始-1"><a href="#快速开始-1" class="headerlink" title="快速开始"></a>快速开始</h3><h4 id="安装模块"><a href="#安装模块" class="headerlink" title="安装模块"></a>安装模块</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 安装koa模板使用中间件</span></span><br><span class="line">npm install --save koa-views</span><br><span class="line"></span><br><span class="line"><span class="comment">## 安装ejs模板引擎</span></span><br><span class="line">npm install --save ejs</span><br></pre></td></tr></table></figure>
<h4 id="使用模板引擎"><a href="#使用模板引擎" class="headerlink" title="使用模板引擎"></a>使用模板引擎</h4><p>demo源码</p>
<p><a href="https://github.com/ChenShenhai/koa2-note/blob/master/demo/ejs/" target="_blank" rel="noopener">https://github.com/ChenShenhai/koa2-note/blob/master/demo/ejs/</a></p>
<h5 id="文件目录"><a href="#文件目录" class="headerlink" title="文件目录"></a>文件目录</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">├── package.json</span><br><span class="line">├── index.js</span><br><span class="line">└── view</span><br><span class="line">    └── index.ejs</span><br></pre></td></tr></table></figure>
<h5 id="index-js文件"><a href="#index-js文件" class="headerlink" title="./index.js文件"></a>./index.js文件</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> views = <span class="built_in">require</span>(<span class="string">'koa-views'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载模板引擎</span></span><br><span class="line">app.use(views(path.join(__dirname, <span class="string">'./view'</span>), &#123;</span><br><span class="line">  extension: <span class="string">'ejs'</span></span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">app.use( <span class="keyword">async</span> ( ctx ) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> title = <span class="string">'hello koa2'</span></span><br><span class="line">  <span class="keyword">await</span> ctx.render(<span class="string">'index'</span>, &#123;</span><br><span class="line">    title,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>
<h5 id="view-index-ejs-模板"><a href="#view-index-ejs-模板" class="headerlink" title="./view/index.ejs 模板"></a>./view/index.ejs 模板</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">title</span> %&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">title</span> %&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>EJS Welcome to <span class="tag">&lt;<span class="name">%=</span> <span class="attr">title</span> %&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="ejs模板引擎"><a href="#ejs模板引擎" class="headerlink" title="ejs模板引擎"></a>ejs模板引擎</h2><h3 id="具体查看ejs官方文档"><a href="#具体查看ejs官方文档" class="headerlink" title="具体查看ejs官方文档"></a>具体查看ejs官方文档</h3><p><a href="https://github.com/mde/ejs" target="_blank" rel="noopener">https://github.com/mde/ejs</a></p>
<h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><h2 id="busboy模块"><a href="#busboy模块" class="headerlink" title="busboy模块"></a>busboy模块</h2><h3 id="快速开始-2"><a href="#快速开始-2" class="headerlink" title="快速开始"></a>快速开始</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save busboy</span><br></pre></td></tr></table></figure>
<h4 id="模块简介"><a href="#模块简介" class="headerlink" title="模块简介"></a>模块简介</h4><p>busboy 模块是用来解析POST请求，node原生req中的文件流。</p>
<h4 id="开始使用"><a href="#开始使用" class="headerlink" title="开始使用"></a>开始使用</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> inspect = <span class="built_in">require</span>(<span class="string">'util'</span>).inspect </span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> Busboy = <span class="built_in">require</span>(<span class="string">'busboy'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// req 为node原生请求</span></span><br><span class="line"><span class="keyword">const</span> busboy = <span class="keyword">new</span> Busboy(&#123; <span class="attr">headers</span>: req.headers &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听文件解析事件</span></span><br><span class="line">busboy.on(<span class="string">'file'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">fieldname, file, filename, encoding, mimetype</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`File [<span class="subst">$&#123;fieldname&#125;</span>]: filename: <span class="subst">$&#123;filename&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 文件保存到特定路径</span></span><br><span class="line">  file.pipe(fs.createWriteStream(<span class="string">'./upload'</span>))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开始解析文件流</span></span><br><span class="line">  file.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`File [<span class="subst">$&#123;fieldname&#125;</span>] got <span class="subst">$&#123;data.length&#125;</span> bytes`</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解析文件结束</span></span><br><span class="line">  file.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`File [<span class="subst">$&#123;fieldname&#125;</span>] Finished`</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听请求中的字段</span></span><br><span class="line">busboy.on(<span class="string">'field'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">fieldname, val, fieldnameTruncated, valTruncated</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Field [<span class="subst">$&#123;fieldname&#125;</span>]: value: <span class="subst">$&#123;inspect(val)&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听结束事件</span></span><br><span class="line">busboy.on(<span class="string">'finish'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Done parsing form!'</span>)</span><br><span class="line">  res.writeHead(<span class="number">303</span>, &#123; <span class="attr">Connection</span>: <span class="string">'close'</span>, <span class="attr">Location</span>: <span class="string">'/'</span> &#125;)</span><br><span class="line">  res.end()</span><br><span class="line">&#125;)</span><br><span class="line">req.pipe(busboy)</span><br></pre></td></tr></table></figure>
<h3 id="更多模块信息"><a href="#更多模块信息" class="headerlink" title="更多模块信息"></a>更多模块信息</h3><p>更多详细API可以访问npm官方文档 <a href="https://www.npmjs.com/package/busboy" target="_blank" rel="noopener">https://www.npmjs.com/package/busboy</a></p>
<h2 id="上传文件简单实现"><a href="#上传文件简单实现" class="headerlink" title="上传文件简单实现"></a>上传文件简单实现</h2><h3 id="依赖模块"><a href="#依赖模块" class="headerlink" title="依赖模块"></a>依赖模块</h3><h4 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save busboy</span><br></pre></td></tr></table></figure>
<ul>
<li>busboy 是用来解析出请求中文件流</li>
</ul>
<h3 id="例子源码"><a href="#例子源码" class="headerlink" title="例子源码"></a>例子源码</h3><p>demo源码</p>
<p><a href="https://github.com/ChenShenhai/koa2-note/blob/master/demo/upload/" target="_blank" rel="noopener">https://github.com/ChenShenhai/koa2-note/blob/master/demo/upload/</a></p>
<h4 id="封装上传文件到写入服务的方法"><a href="#封装上传文件到写入服务的方法" class="headerlink" title="封装上传文件到写入服务的方法"></a>封装上传文件到写入服务的方法</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> inspect = <span class="built_in">require</span>(<span class="string">'util'</span>).inspect</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> os = <span class="built_in">require</span>(<span class="string">'os'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> Busboy = <span class="built_in">require</span>(<span class="string">'busboy'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 同步创建文件目录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>dirname 目录绝对地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;boolean&#125;</span>        </span>创建目录结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mkdirsSync</span>(<span class="params"> dirname </span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (fs.existsSync( dirname )) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mkdirsSync( path.dirname(dirname)) ) &#123;</span><br><span class="line">      fs.mkdirSync( dirname )</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取上传文件的后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>fileName 获取上传文件的后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;string&#125;</span>          </span>文件后缀名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSuffixName</span>(<span class="params"> fileName </span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> nameList = fileName.split(<span class="string">'.'</span>)</span><br><span class="line">  <span class="keyword">return</span> nameList[nameList.length - <span class="number">1</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;object&#125;</span> </span>ctx     koa上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;object&#125;</span> </span>options 文件上传参数 fileType文件类型， path文件存放路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;promise&#125;</span>         </span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uploadFile</span>(<span class="params"> ctx, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> req = ctx.req</span><br><span class="line">  <span class="keyword">let</span> res = ctx.res</span><br><span class="line">  <span class="keyword">let</span> busboy = <span class="keyword">new</span> Busboy(&#123;<span class="attr">headers</span>: req.headers&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取类型</span></span><br><span class="line">  <span class="keyword">let</span> fileType = options.fileType || <span class="string">'common'</span></span><br><span class="line">  <span class="keyword">let</span> filePath = path.join( options.path,  fileType)</span><br><span class="line">  <span class="keyword">let</span> mkdirResult = mkdirsSync( filePath )</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件上传中...'</span>)</span><br><span class="line">    <span class="keyword">let</span> result = &#123; </span><br><span class="line">      success: <span class="literal">false</span>,</span><br><span class="line">      formData: &#123;&#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析请求文件事件</span></span><br><span class="line">    busboy.on(<span class="string">'file'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">fieldname, file, filename, encoding, mimetype</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> fileName = <span class="built_in">Math</span>.random().toString(<span class="number">16</span>).substr(<span class="number">2</span>) + <span class="string">'.'</span> + getSuffixName(filename)</span><br><span class="line">      <span class="keyword">let</span> _uploadFilePath = path.join( filePath, fileName )</span><br><span class="line">      <span class="keyword">let</span> saveTo = path.join(_uploadFilePath)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 文件保存到制定路径</span></span><br><span class="line">      file.pipe(fs.createWriteStream(saveTo))</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 文件写入事件结束</span></span><br><span class="line">      file.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        result.success = <span class="literal">true</span></span><br><span class="line">        result.message = <span class="string">'文件上传成功'</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'文件上传成功！'</span>)</span><br><span class="line">        resolve(result)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析表单中其他字段信息</span></span><br><span class="line">    busboy.on(<span class="string">'field'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">fieldname, val, fieldnameTruncated, valTruncated, encoding, mimetype</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'表单字段数据 ['</span> + fieldname + <span class="string">']: value: '</span> + inspect(val));</span><br><span class="line">      result.formData[fieldname] = inspect(val);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析结束事件</span></span><br><span class="line">    busboy.on(<span class="string">'finish'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"> </span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'文件上结束'</span>)</span><br><span class="line">      resolve(result)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析错误事件</span></span><br><span class="line">    busboy.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'文件上出错'</span>)</span><br><span class="line">      reject(result)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    req.pipe(busboy)</span><br><span class="line">  &#125;)</span><br><span class="line">    </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports =  &#123;</span><br><span class="line">  uploadFile</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="入口文件"><a href="#入口文件" class="headerlink" title="入口文件"></a>入口文件</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"><span class="comment">// const bodyParser = require('koa-bodyparser')</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; uploadFile &#125; = <span class="built_in">require</span>(<span class="string">'./util/upload'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// app.use(bodyParser())</span></span><br><span class="line"></span><br><span class="line">app.use( <span class="keyword">async</span> ( ctx ) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( ctx.url === <span class="string">'/'</span> &amp;&amp; ctx.method === <span class="string">'GET'</span> ) &#123;</span><br><span class="line">    <span class="comment">// 当GET请求时候返回表单页面</span></span><br><span class="line">    <span class="keyword">let</span> html = <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;h1&gt;koa2 upload demo&lt;/h1&gt;</span></span><br><span class="line"><span class="string">      &lt;form method="POST" action="/upload.json" enctype="multipart/form-data"&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;file upload&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;span&gt;picName:&lt;/span&gt;&lt;input name="picName" type="text" /&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">        &lt;input name="file" type="file" /&gt;&lt;br/&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">        &lt;button type="submit"&gt;submit&lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;/form&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">    ctx.body = html</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( ctx.url === <span class="string">'/upload.json'</span> &amp;&amp; ctx.method === <span class="string">'POST'</span> ) &#123;</span><br><span class="line">    <span class="comment">// 上传文件请求处理</span></span><br><span class="line">    <span class="keyword">let</span> result = &#123; <span class="attr">success</span>: <span class="literal">false</span> &#125;</span><br><span class="line">    <span class="keyword">let</span> serverFilePath = path.join( __dirname, <span class="string">'upload-files'</span> )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上传文件事件</span></span><br><span class="line">    result = <span class="keyword">await</span> uploadFile( ctx, &#123;</span><br><span class="line">      fileType: <span class="string">'album'</span>, <span class="comment">// common or album</span></span><br><span class="line">      path: serverFilePath</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    ctx.body = result</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 其他请求显示404</span></span><br><span class="line">    ctx.body = <span class="string">'&lt;h1&gt;404！！！ o(╯□╰)o&lt;/h1&gt;'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'[demo] upload-simple is starting at port 3000'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="运行结果-1"><a href="#运行结果-1" class="headerlink" title="运行结果"></a>运行结果</h4><p><img src="/2023/05/16/Koa2学习笔记/images/upload-simple-result-03.png" alt="upload-simple-result"></p>
<p><img src="/2023/05/16/Koa2学习笔记/images/upload-simple-result-02.png" alt="upload-simple-result"></p>
<p><img src="/2023/05/16/Koa2学习笔记/images/upload-simple-result-01.png" alt="upload-simple-result"></p>
<p><img src="/2023/05/16/Koa2学习笔记/images/upload-simple-result-04.png" alt="upload-simple-result"></p>
<h2 id="异步上传图片实现"><a href="#异步上传图片实现" class="headerlink" title="异步上传图片实现"></a>异步上传图片实现</h2><h3 id="快速上手"><a href="#快速上手" class="headerlink" title="快速上手"></a>快速上手</h3><p>demo 地址</p>
<p><a href="https://github.com/ChenShenhai/koa2-note/tree/master/demo/upload-async" target="_blank" rel="noopener">https://github.com/ChenShenhai/koa2-note/tree/master/demo/upload-async</a></p>
<h3 id="源码理解"><a href="#源码理解" class="headerlink" title="源码理解"></a>源码理解</h3><h4 id="demo源码目录"><a href="#demo源码目录" class="headerlink" title="demo源码目录"></a>demo源码目录</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── index.js <span class="comment">## 后端启动文件</span></span><br><span class="line">├── node_modules</span><br><span class="line">├── package.json</span><br><span class="line">├── static <span class="comment">## 静态资源目录</span></span><br><span class="line">│   ├── image <span class="comment">## 异步上传图片存储目录</span></span><br><span class="line">│   └── js</span><br><span class="line">│       └── index.js <span class="comment">## 上传图片前端js操作</span></span><br><span class="line">├── util</span><br><span class="line">│   └── upload.js <span class="comment">## 后端处理图片流操作</span></span><br><span class="line">└── view</span><br><span class="line">    └── index.ejs <span class="comment">## ejs后端渲染模板</span></span><br></pre></td></tr></table></figure>
<h4 id="后端代码"><a href="#后端代码" class="headerlink" title="后端代码"></a>后端代码</h4><p>入口文件 demo/upload-async/index.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> views = <span class="built_in">require</span>(<span class="string">'koa-views'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> convert = <span class="built_in">require</span>(<span class="string">'koa-convert'</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> = <span class="built_in">require</span>(<span class="string">'koa-static'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; uploadFile &#125; = <span class="built_in">require</span>(<span class="string">'./util/upload'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用第三方中间件 start </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">app.use(views(path.join(__dirname, <span class="string">'./view'</span>), &#123;</span><br><span class="line">  extension: <span class="string">'ejs'</span></span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 静态资源目录对于相对入口文件index.js的路径</span></span><br><span class="line"><span class="keyword">const</span> staticPath = <span class="string">'./static'</span></span><br><span class="line"><span class="comment">// 由于koa-static目前不支持koa2</span></span><br><span class="line"><span class="comment">// 所以只能用koa-convert封装一下</span></span><br><span class="line">app.use(convert(<span class="keyword">static</span>(</span><br><span class="line">  path.join( __dirname,  staticPath)</span><br><span class="line">)))</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用第三方中间件 end </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">app.use( <span class="keyword">async</span> ( ctx ) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> ( ctx.method === <span class="string">'GET'</span> ) &#123;</span><br><span class="line">    <span class="keyword">let</span> title = <span class="string">'upload pic async'</span></span><br><span class="line">    <span class="keyword">await</span> ctx.render(<span class="string">'index'</span>, &#123;</span><br><span class="line">      title,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( ctx.url === <span class="string">'/api/picture/upload.json'</span> &amp;&amp; ctx.method === <span class="string">'POST'</span> ) &#123;</span><br><span class="line">    <span class="comment">// 上传文件请求处理</span></span><br><span class="line">    <span class="keyword">let</span> result = &#123; <span class="attr">success</span>: <span class="literal">false</span> &#125;</span><br><span class="line">    <span class="keyword">let</span> serverFilePath = path.join( __dirname, <span class="string">'static/image'</span> )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上传文件事件</span></span><br><span class="line">    result = <span class="keyword">await</span> uploadFile( ctx, &#123;</span><br><span class="line">      fileType: <span class="string">'album'</span>,</span><br><span class="line">      path: serverFilePath</span><br><span class="line">    &#125;)</span><br><span class="line">    ctx.body = result</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 其他请求显示404</span></span><br><span class="line">    ctx.body = <span class="string">'&lt;h1&gt;404！！！ o(╯□╰)o&lt;/h1&gt;'</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'[demo] upload-pic-async is starting at port 3000'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>后端上传图片流写操作<br>入口文件 demo/upload-async/util/upload.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> inspect = <span class="built_in">require</span>(<span class="string">'util'</span>).inspect</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> os = <span class="built_in">require</span>(<span class="string">'os'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> Busboy = <span class="built_in">require</span>(<span class="string">'busboy'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 同步创建文件目录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>dirname 目录绝对地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;boolean&#125;</span>        </span>创建目录结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mkdirsSync</span>(<span class="params"> dirname </span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (fs.existsSync( dirname )) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mkdirsSync( path.dirname(dirname)) ) &#123;</span><br><span class="line">      fs.mkdirSync( dirname )</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取上传文件的后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>fileName 获取上传文件的后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;string&#125;</span>          </span>文件后缀名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSuffixName</span>(<span class="params"> fileName </span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> nameList = fileName.split(<span class="string">'.'</span>)</span><br><span class="line">  <span class="keyword">return</span> nameList[nameList.length - <span class="number">1</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;object&#125;</span> </span>ctx     koa上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;object&#125;</span> </span>options 文件上传参数 fileType文件类型， path文件存放路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;promise&#125;</span>         </span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uploadFile</span>(<span class="params"> ctx, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> req = ctx.req</span><br><span class="line">  <span class="keyword">let</span> res = ctx.res</span><br><span class="line">  <span class="keyword">let</span> busboy = <span class="keyword">new</span> Busboy(&#123;<span class="attr">headers</span>: req.headers&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取类型</span></span><br><span class="line">  <span class="keyword">let</span> fileType = options.fileType || <span class="string">'common'</span></span><br><span class="line">  <span class="keyword">let</span> filePath = path.join( options.path,  fileType)</span><br><span class="line">  <span class="keyword">let</span> mkdirResult = mkdirsSync( filePath )</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件上传中...'</span>)</span><br><span class="line">    <span class="keyword">let</span> result = &#123; </span><br><span class="line">      success: <span class="literal">false</span>,</span><br><span class="line">      message: <span class="string">''</span>,</span><br><span class="line">      data: <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析请求文件事件</span></span><br><span class="line">    busboy.on(<span class="string">'file'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">fieldname, file, filename, encoding, mimetype</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> fileName = <span class="built_in">Math</span>.random().toString(<span class="number">16</span>).substr(<span class="number">2</span>) + <span class="string">'.'</span> + getSuffixName(filename)</span><br><span class="line">      <span class="keyword">let</span> _uploadFilePath = path.join( filePath, fileName )</span><br><span class="line">      <span class="keyword">let</span> saveTo = path.join(_uploadFilePath)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 文件保存到制定路径</span></span><br><span class="line">      file.pipe(fs.createWriteStream(saveTo))</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 文件写入事件结束</span></span><br><span class="line">      file.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        result.success = <span class="literal">true</span></span><br><span class="line">        result.message = <span class="string">'文件上传成功'</span></span><br><span class="line">        result.data = &#123;</span><br><span class="line">          pictureUrl: <span class="string">`//<span class="subst">$&#123;ctx.host&#125;</span>/image/<span class="subst">$&#123;fileType&#125;</span>/<span class="subst">$&#123;fileName&#125;</span>`</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'文件上传成功！'</span>)</span><br><span class="line">        resolve(result)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析结束事件</span></span><br><span class="line">    busboy.on(<span class="string">'finish'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"> </span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'文件上结束'</span>)</span><br><span class="line">      resolve(result)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析错误事件</span></span><br><span class="line">    busboy.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'文件上出错'</span>)</span><br><span class="line">      reject(result)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    req.pipe(busboy)</span><br><span class="line">  &#125;)</span><br><span class="line">    </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports =  &#123;</span><br><span class="line">  uploadFile</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="前端代码"><a href="#前端代码" class="headerlink" title="前端代码"></a>前端代码</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn"</span> <span class="attr">id</span>=<span class="string">"J_UploadPictureBtn"</span>&gt;</span>上传图片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>上传进度<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"J_UploadProgress"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span>%<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>上传结果图片<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"J_PicturePreview"</span> <span class="attr">class</span>=<span class="string">"preview-picture"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/js/index.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>上传操作代码<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> btn = <span class="built_in">document</span>.getElementById(<span class="string">'J_UploadPictureBtn'</span>)</span><br><span class="line"><span class="keyword">let</span> progressElem = <span class="built_in">document</span>.getElementById(<span class="string">'J_UploadProgress'</span>)</span><br><span class="line"><span class="keyword">let</span> previewElem = <span class="built_in">document</span>.getElementById(<span class="string">'J_PicturePreview'</span>)</span><br><span class="line">btn.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  uploadAction(&#123;</span><br><span class="line">    success: <span class="function"><span class="keyword">function</span>(<span class="params"> result </span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log( result )</span><br><span class="line">      <span class="keyword">if</span> ( result &amp;&amp; result.success &amp;&amp; result.data &amp;&amp; result.data.pictureUrl ) &#123;</span><br><span class="line">        previewElem.innerHTML = <span class="string">'&lt;img src="'</span>+ result.data.pictureUrl +<span class="string">'" style="max-width: 100%"&gt;'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    progress: <span class="function"><span class="keyword">function</span>(<span class="params"> data </span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> ( data &amp;&amp; data * <span class="number">1</span> &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">        progressElem.innerText = data</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 类型判断</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@type <span class="type">&#123;Object&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">let</span> UtilType = &#123;</span><br><span class="line">  isPrototype: <span class="function"><span class="keyword">function</span>(<span class="params"> data </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.prototype.toString.call(data).toLowerCase();</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  isJSON: <span class="function"><span class="keyword">function</span>(<span class="params"> data </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.isPrototype( data ) === <span class="string">'[object object]'</span>;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  isFunction: <span class="function"><span class="keyword">function</span>(<span class="params"> data </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.isPrototype( data ) === <span class="string">'[object function]'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * form表单上传请求事件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;object&#125;</span> </span>options 请求参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">requestEvent</span>(<span class="params"> options </span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> formData = options.formData</span><br><span class="line">    <span class="keyword">let</span> xhr = <span class="keyword">new</span> XMLHttpRequest()</span><br><span class="line">    xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ( xhr.readyState === <span class="number">4</span> &amp;&amp; xhr.status === <span class="number">200</span> ) &#123;</span><br><span class="line">        options.success(<span class="built_in">JSON</span>.parse(xhr.responseText))</span><br><span class="line">      &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    xhr.upload.onprogress = <span class="function"><span class="keyword">function</span>(<span class="params">evt</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> loaded = evt.loaded</span><br><span class="line">      <span class="keyword">let</span> tot = evt.total</span><br><span class="line">      <span class="keyword">let</span> per = <span class="built_in">Math</span>.floor(<span class="number">100</span> * loaded / tot) </span><br><span class="line">      options.progress(per)</span><br><span class="line">    &#125;</span><br><span class="line">    xhr.open(<span class="string">'post'</span>, <span class="string">'/api/picture/upload.json'</span>)</span><br><span class="line">    xhr.send(formData)</span><br><span class="line">  &#125; <span class="keyword">catch</span> ( err ) &#123;</span><br><span class="line">    options.fail(err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传事件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;object&#125;</span> </span>options 上传参数      </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uploadEvent</span> (<span class="params"> options </span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> file</span><br><span class="line">  <span class="keyword">let</span> formData = <span class="keyword">new</span> FormData()</span><br><span class="line">  <span class="keyword">let</span> input = <span class="built_in">document</span>.createElement(<span class="string">'input'</span>)</span><br><span class="line">  input.setAttribute(<span class="string">'type'</span>, <span class="string">'file'</span>)</span><br><span class="line">  input.setAttribute(<span class="string">'name'</span>, <span class="string">'files'</span>)</span><br><span class="line"></span><br><span class="line">  input.click()</span><br><span class="line">  input.onchange = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    file = input.files[<span class="number">0</span>]</span><br><span class="line">    formData.append(<span class="string">'files'</span>, file)</span><br><span class="line"></span><br><span class="line">    requestEvent(&#123;</span><br><span class="line">      formData,</span><br><span class="line">      success: options.success,</span><br><span class="line">      fail: options.fail,</span><br><span class="line">      progress: options.progress</span><br><span class="line">    &#125;)  </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;object&#125;</span> </span>options 上传参数     </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uploadAction</span>(<span class="params"> options </span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( !UtilType.isJSON( options ) ) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log( <span class="string">'upload options is null'</span> )</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> _options = &#123;&#125;</span><br><span class="line">  _options.success = UtilType.isFunction(options.success) ? options.success : <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">  _options.fail = UtilType.isFunction(options.fail) ? options.fail : <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">  _options.progress = UtilType.isFunction(options.progress) ? options.progress : <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">  </span><br><span class="line">  uploadEvent(_options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure></p>
<h4 id="运行效果-1"><a href="#运行效果-1" class="headerlink" title="运行效果"></a>运行效果</h4><p><img src="/2023/05/16/Koa2学习笔记/images/upload-async-result-01.png" alt="images/upload-async-result"></p>
<h1 id="数据库mysql"><a href="#数据库mysql" class="headerlink" title="数据库mysql"></a>数据库mysql</h1><h2 id="mysql模块"><a href="#mysql模块" class="headerlink" title="mysql模块"></a>mysql模块</h2><h3 id="快速开始-3"><a href="#快速开始-3" class="headerlink" title="快速开始"></a>快速开始</h3><h4 id="安装MySQL数据库"><a href="#安装MySQL数据库" class="headerlink" title="安装MySQL数据库"></a>安装MySQL数据库</h4><p><a href="https://www.mysql.com/downloads/" target="_blank" rel="noopener">https://www.mysql.com/downloads/</a></p>
<h4 id="安装-node-js的mysql模块"><a href="#安装-node-js的mysql模块" class="headerlink" title="安装 node.js的mysql模块"></a>安装 node.js的mysql模块</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save mysql</span><br></pre></td></tr></table></figure>
<h4 id="模块介绍"><a href="#模块介绍" class="headerlink" title="模块介绍"></a>模块介绍</h4><p>mysql模块是node操作MySQL的引擎，可以在node.js环境下对MySQL数据库进行建表，增、删、改、查等操作。</p>
<h4 id="开始使用-1"><a href="#开始使用-1" class="headerlink" title="开始使用"></a>开始使用</h4><h5 id="创建数据库会话"><a href="#创建数据库会话" class="headerlink" title="创建数据库会话"></a>创建数据库会话</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql      = <span class="built_in">require</span>(<span class="string">'mysql'</span>)</span><br><span class="line"><span class="keyword">const</span> connection = mysql.createConnection(&#123;</span><br><span class="line">  host     : <span class="string">'127.0.0.1'</span>,   <span class="comment">// 数据库地址</span></span><br><span class="line">  user     : <span class="string">'root'</span>,    <span class="comment">// 数据库用户</span></span><br><span class="line">  password : <span class="string">'123456'</span>   <span class="comment">// 数据库密码</span></span><br><span class="line">  database : <span class="string">'my_database'</span>  <span class="comment">// 选中数据库</span></span><br><span class="line">&#125;)</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 执行sql脚本对数据库进行读写 </span></span><br><span class="line">connection.query(<span class="string">'SELECT * FROM my_table'</span>,  (error, results, fields) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">throw</span> error</span><br><span class="line">  <span class="comment">// connected! </span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 结束会话</span></span><br><span class="line">  connection.release() </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：一个事件就有一个从开始到结束的过程，数据库会话操作执行完后，就需要关闭掉，以免占用连接资源。</p>
</blockquote>
<h5 id="创建数据连接池"><a href="#创建数据连接池" class="headerlink" title="创建数据连接池"></a>创建数据连接池</h5><p>一般情况下操作数据库是很复杂的读写过程，不只是一个会话，如果直接用会话操作，就需要每次会话都要配置连接参数。所以这时候就需要连接池管理会话。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">'mysql'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建数据池</span></span><br><span class="line"><span class="keyword">const</span> pool  = mysql.createPool(&#123;</span><br><span class="line">  host     : <span class="string">'127.0.0.1'</span>,   <span class="comment">// 数据库地址</span></span><br><span class="line">  user     : <span class="string">'root'</span>,    <span class="comment">// 数据库用户</span></span><br><span class="line">  password : <span class="string">'123456'</span>   <span class="comment">// 数据库密码</span></span><br><span class="line">  database : <span class="string">'my_database'</span>  <span class="comment">// 选中数据库</span></span><br><span class="line">&#125;)</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 在数据池中进行会话操作</span></span><br><span class="line">pool.getConnection(<span class="function"><span class="keyword">function</span>(<span class="params">err, connection</span>) </span>&#123;</span><br><span class="line">   </span><br><span class="line">  connection.query(<span class="string">'SELECT * FROM my_table'</span>,  (error, results, fields) =&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 结束会话</span></span><br><span class="line">    connection.release();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 如果有错误就抛出</span></span><br><span class="line">    <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="更多模块信息-1"><a href="#更多模块信息-1" class="headerlink" title="更多模块信息"></a>更多模块信息</h3><p>更多详细API可以访问npm官方文档 <a href="https://www.npmjs.com/package/mysql" target="_blank" rel="noopener">https://www.npmjs.com/package/mysql</a></p>
<h2 id="async-await封装使用mysql"><a href="#async-await封装使用mysql" class="headerlink" title="async/await封装使用mysql"></a>async/await封装使用mysql</h2><h3 id="前言-2"><a href="#前言-2" class="headerlink" title="前言"></a>前言</h3><p>由于mysql模块的操作都是异步操作，每次操作的结果都是在回调函数中执行，现在有了async/await，就可以用同步的写法去操作数据库</p>
<h4 id="Promise封装mysql模块"><a href="#Promise封装mysql模块" class="headerlink" title="Promise封装mysql模块"></a>Promise封装mysql模块</h4><h5 id="Promise封装-async-db"><a href="#Promise封装-async-db" class="headerlink" title="Promise封装 ./async-db"></a>Promise封装 ./async-db</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">'mysql'</span>)</span><br><span class="line"><span class="keyword">const</span> pool = mysql.createPool(&#123;</span><br><span class="line">  host     :  <span class="string">'127.0.0.1'</span>,</span><br><span class="line">  user     :  <span class="string">'root'</span>,</span><br><span class="line">  password :  <span class="string">'123456'</span>,</span><br><span class="line">  database :  <span class="string">'my_database'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> query = <span class="function"><span class="keyword">function</span>(<span class="params"> sql, values </span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params"> resolve, reject </span>) =&gt;</span> &#123;</span><br><span class="line">    pool.getConnection(<span class="function"><span class="keyword">function</span>(<span class="params">err, connection</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        reject( err )</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        connection.query(sql, values, ( err, rows) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> ( err ) &#123;</span><br><span class="line">            reject( err )</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resolve( rows )</span><br><span class="line">          &#125;</span><br><span class="line">          connection.release()</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123; query &#125;</span><br></pre></td></tr></table></figure>
<h5 id="async-await使用-1"><a href="#async-await使用-1" class="headerlink" title="async/await使用"></a>async/await使用</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; query &#125; = <span class="built_in">require</span>(<span class="string">'./async-db'</span>)</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">selectAllData</span>(<span class="params"> </span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> sql = <span class="string">'SELECT * FROM my_table'</span></span><br><span class="line">  <span class="keyword">let</span> dataList = <span class="keyword">await</span> query( sql )</span><br><span class="line">  <span class="keyword">return</span> dataList</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> dataList = <span class="keyword">await</span> selectAllData()</span><br><span class="line">  <span class="built_in">console</span>.log( dataList )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getData()</span><br></pre></td></tr></table></figure>
<h2 id="建表初始化"><a href="#建表初始化" class="headerlink" title="建表初始化"></a>建表初始化</h2><h3 id="前言-3"><a href="#前言-3" class="headerlink" title="前言"></a>前言</h3><p>通常初始化数据库要建立很多表，特别在项目开发的时候表的格式可能会有些变动，这时候就需要封装对数据库建表初始化的方法，保留项目的sql脚本文件，然后每次需要重新建表，则执行建表初始化程序就行</p>
<h3 id="快速开始-4"><a href="#快速开始-4" class="headerlink" title="快速开始"></a>快速开始</h3><p>demo源码</p>
<p><a href="https://github.com/ChenShenhai/koa2-note/blob/master/demo/mysql/" target="_blank" rel="noopener">https://github.com/ChenShenhai/koa2-note/blob/master/demo/mysql/</a></p>
<h4 id="源码目录"><a href="#源码目录" class="headerlink" title="源码目录"></a>源码目录</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">├── index.js <span class="comment">## 程序入口文件</span></span><br><span class="line">├── node_modules/</span><br><span class="line">├── package.json</span><br><span class="line">├── sql   <span class="comment">## sql脚本文件目录</span></span><br><span class="line">│   ├── data.sql</span><br><span class="line">│   └── user.sql</span><br><span class="line">└── util    <span class="comment">## 工具代码</span></span><br><span class="line">    ├── db.js <span class="comment">## 封装的mysql模块方法</span></span><br><span class="line">    ├── get-sql-content-map.js <span class="comment">## 获取sql脚本文件内容</span></span><br><span class="line">    ├── get-sql-map.js <span class="comment">## 获取所有sql脚本文件</span></span><br><span class="line">    └── walk-file.js <span class="comment">## 遍历sql脚本文件</span></span><br></pre></td></tr></table></figure>
<h4 id="具体流程"><a href="#具体流程" class="headerlink" title="具体流程"></a>具体流程</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">       +---------------------------------------------------+</span><br><span class="line">       |                                                   |</span><br><span class="line">       |   +-----------+   +-----------+   +-----------+   |</span><br><span class="line">       |   |           |   |           |   |           |   |</span><br><span class="line">       |   |           |   |           |   |           |   |</span><br><span class="line">       |   |           |   |           |   |           |   |</span><br><span class="line">       |   |           |   |           |   |           |   |</span><br><span class="line">+----------+  遍历sql  +---+ 解析所有sql +---+  执行sql  +------------&gt;</span><br><span class="line">       |   |  目录下的  |   |  文件脚本  |   |   脚本     |   |</span><br><span class="line">+----------+  sql文件   +---+   内容    +---+           +------------&gt;</span><br><span class="line">       |   |           |   |           |   |           |   |</span><br><span class="line">       |   |           |   |           |   |           |   |</span><br><span class="line">       |   |           |   |           |   |           |   |</span><br><span class="line">       |   |           |   |           |   |           |   |</span><br><span class="line">       |   +-----------+   +-----------+   +-----------+   |</span><br><span class="line">       |                                                   |</span><br><span class="line">       +---------------------------------------------------+</span><br></pre></td></tr></table></figure>
<h3 id="源码详解"><a href="#源码详解" class="headerlink" title="源码详解"></a>源码详解</h3><h4 id="数据库操作文件-util-db-js"><a href="#数据库操作文件-util-db-js" class="headerlink" title="数据库操作文件 ./util/db.js"></a>数据库操作文件 ./util/db.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">'mysql'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pool = mysql.createPool(&#123;</span><br><span class="line">  host     :  <span class="string">'127.0.0.1'</span>,</span><br><span class="line">  user     :  <span class="string">'root'</span>,</span><br><span class="line">  password :  <span class="string">'abc123'</span>,</span><br><span class="line">  database :  <span class="string">'koa_demo'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> query = <span class="function"><span class="keyword">function</span>(<span class="params"> sql, values </span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params"> resolve, reject </span>) =&gt;</span> &#123;</span><br><span class="line">    pool.getConnection(<span class="function"><span class="keyword">function</span>(<span class="params">err, connection</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        reject( err )</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        connection.query(sql, values, ( err, rows) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> ( err ) &#123;</span><br><span class="line">            reject( err )</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resolve( rows )</span><br><span class="line">          &#125;</span><br><span class="line">          connection.release()</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  query</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取所有sql脚本内容-util-get-sql-content-map-js"><a href="#获取所有sql脚本内容-util-get-sql-content-map-js" class="headerlink" title="获取所有sql脚本内容 ./util/get-sql-content-map.js"></a>获取所有sql脚本内容 ./util/get-sql-content-map.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> getSqlMap = <span class="built_in">require</span>(<span class="string">'./get-sql-map'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> sqlContentMap = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 读取sql文件内容</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>fileName 文件名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>path     文件所在的路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;string&#125;</span>          </span>脚本文件内容</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSqlContent</span>(<span class="params"> fileName,  path </span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> content = fs.readFileSync( path, <span class="string">'binary'</span> )</span><br><span class="line">  sqlContentMap[ fileName ] = content</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装所有sql文件脚本内容</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;object&#125;</span> </span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSqlContentMap</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> sqlMap = getSqlMap()</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">let</span> key <span class="keyword">in</span> sqlMap ) &#123;</span><br><span class="line">    getSqlContent( key, sqlMap[key] )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> sqlContentMap</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = getSqlContentMap</span><br></pre></td></tr></table></figure>
<h4 id="获取sql目录详情-util-get-sql-map-js"><a href="#获取sql目录详情-util-get-sql-map-js" class="headerlink" title="获取sql目录详情 ./util/get-sql-map.js"></a>获取sql目录详情 ./util/get-sql-map.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> walkFile = <span class="built_in">require</span>(<span class="string">'./walk-file'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取sql目录下的文件目录数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;object&#125;</span> </span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSqlMap</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> basePath = __dirname</span><br><span class="line">  basePath = basePath.replace(<span class="regexp">/\\/g</span>, <span class="string">'\/'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> pathArr = basePath.split(<span class="string">'\/'</span>)</span><br><span class="line">  pathArr = pathArr.splice( <span class="number">0</span>, pathArr.length - <span class="number">1</span> )</span><br><span class="line">  basePath = pathArr.join(<span class="string">'/'</span>) + <span class="string">'/sql/'</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> fileList = walkFile( basePath, <span class="string">'sql'</span> )</span><br><span class="line">  <span class="keyword">return</span> fileList</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = getSqlMap</span><br></pre></td></tr></table></figure>
<h4 id="遍历目录操作-util-walk-file-js"><a href="#遍历目录操作-util-walk-file-js" class="headerlink" title="遍历目录操作 ./util/walk-file.js"></a>遍历目录操作 ./util/walk-file.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 遍历目录下的文件目录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>pathResolve  需进行遍历的目录路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>mime         遍历文件的后缀名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;object&#125;</span>              </span>返回遍历后的目录结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> walkFile = <span class="function"><span class="keyword">function</span>(<span class="params">  pathResolve , mime </span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> files = fs.readdirSync( pathResolve )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> fileList = &#123;&#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span>( <span class="keyword">let</span> [ i, item] <span class="keyword">of</span> files.entries() ) &#123;</span><br><span class="line">    <span class="keyword">let</span> itemArr = item.split(<span class="string">'\.'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> itemMime = ( itemArr.length &gt; <span class="number">1</span> ) ? itemArr[ itemArr.length - <span class="number">1</span> ] : <span class="string">'undefined'</span></span><br><span class="line">    <span class="keyword">let</span> keyName = item + <span class="string">''</span></span><br><span class="line">    <span class="keyword">if</span>( mime === itemMime ) &#123;</span><br><span class="line">      fileList[ item ] =  pathResolve + item</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fileList</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = walkFile</span><br></pre></td></tr></table></figure>
<h4 id="入口文件-index-js"><a href="#入口文件-index-js" class="headerlink" title="入口文件 ./index.js"></a>入口文件 ./index.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> getSqlContentMap = <span class="built_in">require</span>(<span class="string">'./util/get-sql-content-map'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; query &#125; = <span class="built_in">require</span>(<span class="string">'./util/db'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印脚本执行日志</span></span><br><span class="line"><span class="keyword">const</span> eventLog = <span class="function"><span class="keyword">function</span>(<span class="params"> err , sqlFile, index </span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>( err ) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[ERROR] sql脚本文件: <span class="subst">$&#123;sqlFile&#125;</span> 第<span class="subst">$&#123;index + <span class="number">1</span>&#125;</span>条脚本 执行失败 o(╯□╰)o ！`</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[SUCCESS] sql脚本文件: <span class="subst">$&#123;sqlFile&#125;</span> 第<span class="subst">$&#123;index + <span class="number">1</span>&#125;</span>条脚本 执行成功 O(∩_∩)O !`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取所有sql脚本内容</span></span><br><span class="line"><span class="keyword">let</span> sqlContentMap = getSqlContentMap()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行建表sql脚本</span></span><br><span class="line"><span class="keyword">const</span> createAllTables = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">let</span> key <span class="keyword">in</span> sqlContentMap ) &#123;</span><br><span class="line">    <span class="keyword">let</span> sqlShell = sqlContentMap[key]</span><br><span class="line">    <span class="keyword">let</span> sqlShellList = sqlShell.split(<span class="string">';'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">let</span> [ i, shell ] <span class="keyword">of</span> sqlShellList.entries() ) &#123;</span><br><span class="line">      <span class="keyword">if</span> ( shell.trim() ) &#123;</span><br><span class="line">        <span class="keyword">let</span> result = <span class="keyword">await</span> query( shell )</span><br><span class="line">        <span class="keyword">if</span> ( result.serverStatus * <span class="number">1</span> === <span class="number">2</span> ) &#123;</span><br><span class="line">          eventLog( <span class="literal">null</span>,  key, i)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          eventLog( <span class="literal">true</span>,  key, i) </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'sql脚本执行结束！'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'请按 ctrl + c 键退出！'</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">createAllTables()</span><br></pre></td></tr></table></figure>
<h4 id="sql脚本文件-sql-data-sql"><a href="#sql脚本文件-sql-data-sql" class="headerlink" title="sql脚本文件 ./sql/data.sql"></a>sql脚本文件 ./sql/data.sql</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span>   <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>  <span class="string">`data`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`data_info`</span> <span class="keyword">json</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`create_time`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`modified_time`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`level`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8</span><br></pre></td></tr></table></figure>
<h4 id="sql脚本文件-sql-user-sql"><a href="#sql脚本文件-sql-user-sql" class="headerlink" title="sql脚本文件 ./sql/user.sql"></a>sql脚本文件 ./sql/user.sql</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span>   <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>  <span class="string">`user`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`email`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`password`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`nick`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`detail_info`</span> <span class="keyword">json</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`create_time`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`modified_time`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`level`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user`</span> <span class="keyword">set</span> email=<span class="string">'1@example.com'</span>, <span class="keyword">password</span>=<span class="string">'123456'</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user`</span> <span class="keyword">set</span> email=<span class="string">'2@example.com'</span>, <span class="keyword">password</span>=<span class="string">'123456'</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user`</span> <span class="keyword">set</span> email=<span class="string">'3@example.com'</span>, <span class="keyword">password</span>=<span class="string">'123456'</span>;</span><br></pre></td></tr></table></figure>
<h3 id="效果-2"><a href="#效果-2" class="headerlink" title="效果"></a>效果</h3><h4 id="执行脚本-1"><a href="#执行脚本-1" class="headerlink" title="执行脚本"></a>执行脚本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node index.js</span><br></pre></td></tr></table></figure>
<h4 id="执行结果"><a href="#执行结果" class="headerlink" title="执行结果"></a>执行结果</h4><p><img src="/2023/05/16/Koa2学习笔记/images/mysql-init-result-01.png" alt="mysql-init-result-01"></p>
<h4 id="查看数据库写入数据"><a href="#查看数据库写入数据" class="headerlink" title="查看数据库写入数据"></a>查看数据库写入数据</h4><p><img src="/2023/05/16/Koa2学习笔记/images/mysql-init-result-02.png" alt="mysql-init-result-01"></p>
<h1 id="JSONP实现"><a href="#JSONP实现" class="headerlink" title="JSONP实现"></a>JSONP实现</h1><h2 id="原生koa2实现jsonp"><a href="#原生koa2实现jsonp" class="headerlink" title="原生koa2实现jsonp"></a>原生koa2实现jsonp</h2><h3 id="前言-4"><a href="#前言-4" class="headerlink" title="前言"></a>前言</h3><p>在项目复杂的业务场景，有时候需要在前端跨域获取数据，这时候提供数据的服务就需要提供跨域请求的接口，通常是使用JSONP的方式提供跨域接口。</p>
<h3 id="实现JSONP"><a href="#实现JSONP" class="headerlink" title="实现JSONP"></a>实现JSONP</h3><p>demo地址</p>
<p><a href="https://github.com/ChenShenhai/koa2-note/blob/master/demo/jsonp/" target="_blank" rel="noopener">https://github.com/ChenShenhai/koa2-note/blob/master/demo/jsonp/</a></p>
<h4 id="具体原理"><a href="#具体原理" class="headerlink" title="具体原理"></a>具体原理</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 判断是否为JSONP的请求 </span></span><br><span class="line"><span class="keyword">if</span> ( ctx.method === <span class="string">'GET'</span> &amp;&amp; ctx.url.split(<span class="string">'?'</span>)[<span class="number">0</span>] === <span class="string">'/getData.jsonp'</span>) &#123;</span><br><span class="line">  <span class="comment">// 获取jsonp的callback</span></span><br><span class="line">  <span class="keyword">let</span> callbackName = ctx.query.callback || <span class="string">'callback'</span></span><br><span class="line">  <span class="keyword">let</span> returnData = &#123;</span><br><span class="line">    success: <span class="literal">true</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      text: <span class="string">'this is a jsonp api'</span>,</span><br><span class="line">      time: <span class="keyword">new</span> <span class="built_in">Date</span>().getTime(),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line"></span><br><span class="line">  <span class="comment">// jsonp的script字符串</span></span><br><span class="line">  <span class="keyword">let</span> jsonpStr = <span class="string">`;<span class="subst">$&#123;callbackName&#125;</span>(<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(returnData)&#125;</span>)`</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用text/javascript，让请求支持跨域获取</span></span><br><span class="line">  ctx.type = <span class="string">'text/javascript'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 输出jsonp字符串</span></span><br><span class="line">  ctx.body = jsonpStr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="解析原理"><a href="#解析原理" class="headerlink" title="解析原理"></a>解析原理</h4><ul>
<li>JSONP跨域输出的数据是可执行的JavaScript代码<ul>
<li>ctx输出的类型应该是’text/javascript’</li>
<li>ctx输出的内容为可执行的返回数据JavaScript代码字符串</li>
</ul>
</li>
<li>需要有回调函数名callbackName，前端获取后会通过动态执行JavaScript代码字符，获取里面的数据</li>
</ul>
<h4 id="效果截图"><a href="#效果截图" class="headerlink" title="效果截图"></a>效果截图</h4><h5 id="同域访问JSON请求"><a href="#同域访问JSON请求" class="headerlink" title="同域访问JSON请求"></a>同域访问JSON请求</h5><p><img src="/2023/05/16/Koa2学习笔记/images/jsonp-result-01.png" alt="jsonp-result-01"></p>
<h5 id="跨域访问JSON请求"><a href="#跨域访问JSON请求" class="headerlink" title="跨域访问JSON请求"></a>跨域访问JSON请求</h5><p><img src="/2023/05/16/Koa2学习笔记/images/jsonp-result-02.png" alt="jsonp-result-02"></p>
<h4 id="完整demo代码"><a href="#完整demo代码" class="headerlink" title="完整demo代码"></a>完整demo代码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line">app.use( <span class="keyword">async</span> ( ctx ) =&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果jsonp 的请求为GET</span></span><br><span class="line">  <span class="keyword">if</span> ( ctx.method === <span class="string">'GET'</span> &amp;&amp; ctx.url.split(<span class="string">'?'</span>)[<span class="number">0</span>] === <span class="string">'/getData.jsonp'</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取jsonp的callback</span></span><br><span class="line">    <span class="keyword">let</span> callbackName = ctx.query.callback || <span class="string">'callback'</span></span><br><span class="line">    <span class="keyword">let</span> returnData = &#123;</span><br><span class="line">      success: <span class="literal">true</span>,</span><br><span class="line">      data: &#123;</span><br><span class="line">        text: <span class="string">'this is a jsonp api'</span>,</span><br><span class="line">        time: <span class="keyword">new</span> <span class="built_in">Date</span>().getTime(),</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// jsonp的script字符串</span></span><br><span class="line">    <span class="keyword">let</span> jsonpStr = <span class="string">`;<span class="subst">$&#123;callbackName&#125;</span>(<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(returnData)&#125;</span>)`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用text/javascript，让请求支持跨域获取</span></span><br><span class="line">    ctx.type = <span class="string">'text/javascript'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出jsonp字符串</span></span><br><span class="line">    ctx.body = jsonpStr</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    ctx.body = <span class="string">'hello jsonp'</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'[demo] jsonp is starting at port 3000'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="string">``</span><span class="string">`## koa-jsonp中间件</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">koa.js 官方wiki中也介绍了不少jsonp的中间件</span></span><br><span class="line"><span class="string">![jsonp-wiki](./../images/jsonp-wiki.png)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">其中koa-jsonp是支持koa2的，使用方式也非常简单，koa-jsonp的官方demo也很容易理解</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### 快速使用</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">demo地址</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[https://github.com/ChenShenhai/koa2-note/blob/master/demo/jsonp-use-middleware/](https://github.com/ChenShenhai/koa2-note/blob/master/demo/jsonp-use-middleware/)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### 安装</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>sh</span><br><span class="line">npm install --save koa-jsonp</span><br></pre></td></tr></table></figure>
<h4 id="简单例子-1"><a href="#简单例子-1" class="headerlink" title="简单例子"></a>简单例子</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> jsonp = <span class="built_in">require</span>(<span class="string">'koa-jsonp'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用中间件</span></span><br><span class="line">app.use(jsonp())</span><br><span class="line"></span><br><span class="line">app.use( <span class="keyword">async</span> ( ctx ) =&gt; &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> returnData = &#123;</span><br><span class="line">    success: <span class="literal">true</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      text: <span class="string">'this is a jsonp api'</span>,</span><br><span class="line">      time: <span class="keyword">new</span> <span class="built_in">Date</span>().getTime(),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 直接输出JSON</span></span><br><span class="line">  ctx.body = returnData</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'[demo] jsonp is starting at port 3000'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><h3 id="前言-5"><a href="#前言-5" class="headerlink" title="前言"></a>前言</h3><p>测试是一个项目周期里必不可少的环节，开发者在开发过程中也是无时无刻进行“人工测试”，如果每次修改一点代码，都要牵一发动全身都要手动测试关联接口，这样子是禁锢了生产力。为了解放大部分测试生产力，相关的测试框架应运而生，比较出名的有mocha，karma，jasmine等。虽然框架繁多，但是使用起来都是大同小异。</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="安装测试相关框架"><a href="#安装测试相关框架" class="headerlink" title="安装测试相关框架"></a>安装测试相关框架</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev mocha chai supertest</span><br></pre></td></tr></table></figure>
<ul>
<li>mocha 模块是测试框架</li>
<li>chai 模块是用来进行测试结果断言库，比如一个判断 1 + 1 是否等于 2</li>
<li>supertest 模块是http请求测试库，用来请求API接口</li>
</ul>
<h3 id="测试例子"><a href="#测试例子" class="headerlink" title="测试例子"></a>测试例子</h3><p>demo地址</p>
<p><a href="https://github.com/ChenShenhai/koa2-note/blob/master/demo/test-unit/" target="_blank" rel="noopener">https://github.com/ChenShenhai/koa2-note/blob/master/demo/test-unit/</a></p>
<h4 id="例子目录"><a href="#例子目录" class="headerlink" title="例子目录"></a>例子目录</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── index.js <span class="comment">## api文件</span></span><br><span class="line">├── package.json</span><br><span class="line">└── <span class="built_in">test</span> <span class="comment">## 测试目录</span></span><br><span class="line">    └── index.test.js <span class="comment">## 测试用例</span></span><br></pre></td></tr></table></figure>
<h4 id="所需测试demo"><a href="#所需测试demo" class="headerlink" title="所需测试demo"></a>所需测试demo</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">async</span> ( ctx, next ) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> result = &#123;</span><br><span class="line">    success: <span class="literal">true</span>,</span><br><span class="line">    data: <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( ctx.method === <span class="string">'GET'</span> ) &#123; </span><br><span class="line">    <span class="keyword">if</span> ( ctx.url === <span class="string">'/getString.json'</span> ) &#123;</span><br><span class="line">      result.data = <span class="string">'this is string data'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( ctx.url === <span class="string">'/getNumber.json'</span> ) &#123;</span><br><span class="line">      result.data = <span class="number">123456</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result.success = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    ctx.body = result</span><br><span class="line">    next &amp;&amp; next()</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( ctx.method === <span class="string">'POST'</span> ) &#123;</span><br><span class="line">    <span class="keyword">if</span> ( ctx.url === <span class="string">'/postData.json'</span> ) &#123;</span><br><span class="line">      result.data = <span class="string">'ok'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result.success = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    ctx.body = result</span><br><span class="line">    next &amp;&amp; next()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ctx.body = <span class="string">'hello world'</span></span><br><span class="line">    next &amp;&amp; next()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use(server)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = app</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'[demo] test-unit is starting at port 3000'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>启动服务后访问接口会看到以下数据</p>
<p><a href="http://localhost:3000/getString.json" target="_blank" rel="noopener">http://localhost:3000/getString.json</a></p>
<p><img src="/2023/05/16/Koa2学习笔记/images/test-unit-result-01.png" alt="test-unit-result-01"></p>
<h4 id="开始写测试用例"><a href="#开始写测试用例" class="headerlink" title="开始写测试用例"></a>开始写测试用例</h4><p>demo/test-unit/test/index.test.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> supertest = <span class="built_in">require</span>(<span class="string">'supertest'</span>)</span><br><span class="line"><span class="keyword">const</span> chai = <span class="built_in">require</span>(<span class="string">'chai'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">'./../index'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> expect = chai.expect</span><br><span class="line"><span class="keyword">const</span> request = supertest( app.listen() )</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试套件/组</span></span><br><span class="line">describe( <span class="string">'开始测试demo的GET请求'</span>, ( ) =&gt; &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 测试用例</span></span><br><span class="line">  it(<span class="string">'测试/getString.json请求'</span>, ( done ) =&gt; &#123;</span><br><span class="line">      request</span><br><span class="line">        .get(<span class="string">'/getString.json'</span>)</span><br><span class="line">        .expect(<span class="number">200</span>)</span><br><span class="line">        .end(<span class="function">(<span class="params"> err, res </span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 断言判断结果是否为object类型</span></span><br><span class="line">            expect(res.body).to.be.an(<span class="string">'object'</span>)</span><br><span class="line">            expect(res.body.success).to.be.an(<span class="string">'boolean'</span>)</span><br><span class="line">            expect(res.body.data).to.be.an(<span class="string">'string'</span>)</span><br><span class="line">            done()</span><br><span class="line">        &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="执行测试用例"><a href="#执行测试用例" class="headerlink" title="执行测试用例"></a>执行测试用例</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## node.js &lt;= 7.5.x</span></span><br><span class="line">./node_modules/.bin/mocha  --harmony</span><br><span class="line"></span><br><span class="line"><span class="comment">## node.js = 7.6.0</span></span><br><span class="line">./node_modules/.bin/mocha</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：</p>
<ol>
<li>如果是全局安装了mocha，可以直接在当前项目目录下执行 mocha –harmony 命令</li>
<li>如果当前node.js版本低于7.6，由于7.5.x以下还直接不支持async/awiar就需要加上–harmony</li>
</ol>
</blockquote>
<p>会自动读取执行命令 ./test 目录下的测用例文件 inde.test.js，并执行。测试结果如下<br><img src="/2023/05/16/Koa2学习笔记/images/test-unit-result-03.png" alt="test-unit-result-03"></p>
<h4 id="用例详解"><a href="#用例详解" class="headerlink" title="用例详解"></a>用例详解</h4><h5 id="服务入口加载"><a href="#服务入口加载" class="headerlink" title="服务入口加载"></a>服务入口加载</h5><p>如果要对一个服务的API接口，进行单元测试，要用supertest加载服务的入口文件<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> supertest = <span class="built_in">require</span>(<span class="string">'supertest'</span>)</span><br><span class="line"><span class="keyword">const</span> request = supertest( app.listen() )</span><br></pre></td></tr></table></figure></p>
<h5 id="测试套件、用例"><a href="#测试套件、用例" class="headerlink" title="测试套件、用例"></a>测试套件、用例</h5><ul>
<li>describe()描述的是一个测试套件</li>
<li>嵌套在describe()的it()是对接口进行自动化测试的测试用例</li>
<li><p>一个describe()可以包含多个it()</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">describe( <span class="string">'开始测试demo的GET请求'</span>, ( ) =&gt; &#123;</span><br><span class="line">    it(<span class="string">'测试/getString.json请求'</span>, () =&gt; &#123;</span><br><span class="line">        <span class="comment">// TODO ...</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>supertest封装服务request，是用来请求接口</p>
</li>
<li>chai.expect使用来判断测试结果是否与预期一样<ul>
<li>chai 断言有很多种方法，这里只是用了数据类型断言  </li>
</ul>
</li>
</ul>
<h1 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h1><h2 id="开发debug"><a href="#开发debug" class="headerlink" title="开发debug"></a>开发debug</h2><h3 id="快速开始-5"><a href="#快速开始-5" class="headerlink" title="快速开始"></a>快速开始</h3><h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h4><ul>
<li>node环境 8.x +</li>
<li>chrome 60+</li>
</ul>
<h4 id="启动脚本"><a href="#启动脚本" class="headerlink" title="启动脚本"></a>启动脚本</h4><h5 id="调试demo"><a href="#调试demo" class="headerlink" title="调试demo"></a>调试demo</h5><p><a href="https://github.com/ChenShenhai/koa2-note/blob/master/demo/start-quick/index.js" target="_blank" rel="noopener">https://github.com/ChenShenhai/koa2-note/blob/master/demo/start-quick/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node --inspect index.js</span><br></pre></td></tr></table></figure>
<h5 id="指令框显示"><a href="#指令框显示" class="headerlink" title="指令框显示"></a>指令框显示</h5><blockquote>
<p>指令框就会出现以下字样</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Debugger listening on ws://127.0.0.1:9229/4c23c723-5197-4d23-9b90-d473f1164abe</span><br><span class="line">For <span class="built_in">help</span> see https://nodejs.org/en/docs/inspector</span><br></pre></td></tr></table></figure>
<p><img src="/2023/05/16/Koa2学习笔记/images/debug-result-001.png" alt="debug-result"></p>
<h5 id="访问chrome浏览器调试server"><a href="#访问chrome浏览器调试server" class="headerlink" title="访问chrome浏览器调试server"></a>访问chrome浏览器调试server</h5><p><img src="/2023/05/16/Koa2学习笔记/images/debug-result-002.png" alt="debug-result"></p>
<blockquote>
<p> 打开浏览器调试窗口会看到一个node.js 的小logo</p>
</blockquote>
<p><img src="/2023/05/16/Koa2学习笔记/images/debug-result-003.png" alt="debug-result"></p>
<h5 id="打开chrome浏览器的node调试窗口"><a href="#打开chrome浏览器的node调试窗口" class="headerlink" title="打开chrome浏览器的node调试窗口"></a>打开chrome浏览器的node调试窗口</h5><p><img src="/2023/05/16/Koa2学习笔记/images/debug-result-004.png" alt="debug-result"></p>
<p><img src="/2023/05/16/Koa2学习笔记/images/debug-result-006.png" alt="debug-result"></p>
<blockquote>
<p>注意打开了node的调试窗口后，原来绿色的node按钮会变灰色，同时调试框会显示debug状态</p>
</blockquote>
<p><img src="/2023/05/16/Koa2学习笔记/images/debug-result-005.png" alt="debug-result"></p>
<p><img src="/2023/05/16/Koa2学习笔记/images/debug-result-008.png" alt="debug-result"></p>
<h5 id="可以自定义打断点调试了"><a href="#可以自定义打断点调试了" class="headerlink" title="可以自定义打断点调试了"></a>可以自定义打断点调试了</h5><p><img src="/2023/05/16/Koa2学习笔记/images/debug-result-007.png" alt="debug-result"></p>
<h1 id="项目框架搭建"><a href="#项目框架搭建" class="headerlink" title="项目框架搭建"></a>项目框架搭建</h1><h2 id="项目demo"><a href="#项目demo" class="headerlink" title="项目demo"></a>项目demo</h2><h3 id="快速启动"><a href="#快速启动" class="headerlink" title="快速启动"></a>快速启动</h3><h4 id="demo地址"><a href="#demo地址" class="headerlink" title="demo地址"></a>demo地址</h4><p><a href="https://github.com/ChenShenhai/koa2-note/blob/master/demo/project/" target="_blank" rel="noopener">https://github.com/ChenShenhai/koa2-note/blob/master/demo/project/</a></p>
<h4 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a>环境准备</h4><h4 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h4><ul>
<li>安装MySQL5.6以上版本</li>
<li>创建数据库koa_demo</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database koa_demo;</span><br></pre></td></tr></table></figure>
<ul>
<li>配置项目config.js</li>
</ul>
<p><a href="https://github.com/ChenShenhai/koa2-note/blob/master/demo/project/" target="_blank" rel="noopener">https://github.com/ChenShenhai/koa2-note/blob/master/demo/project/</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">  <span class="comment">// 启动端口</span></span><br><span class="line">  port: <span class="number">3001</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 数据库配置</span></span><br><span class="line">  database: &#123;</span><br><span class="line">    DATABASE: <span class="string">'koa_demo'</span>,</span><br><span class="line">    USERNAME: <span class="string">'root'</span>,</span><br><span class="line">    PASSWORD: <span class="string">'abc123'</span>,</span><br><span class="line">    PORT: <span class="string">'3306'</span>,</span><br><span class="line">    HOST: <span class="string">'localhost'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = config</span><br></pre></td></tr></table></figure>
<h4 id="启动脚本-1"><a href="#启动脚本-1" class="headerlink" title="启动脚本"></a>启动脚本</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 安装淘宝镜像cnpm</span></span><br><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br><span class="line"></span><br><span class="line"><span class="comment">## 安装依赖</span></span><br><span class="line">cnpm install</span><br><span class="line"></span><br><span class="line"><span class="comment">## 数据建库初始化</span></span><br><span class="line">npm run init_sql</span><br><span class="line"></span><br><span class="line"><span class="comment">## 编译react.js源码</span></span><br><span class="line">npm run start_static</span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动服务</span></span><br><span class="line">npm run start_server</span><br></pre></td></tr></table></figure>
<h4 id="访问项目demo"><a href="#访问项目demo" class="headerlink" title="访问项目demo"></a>访问项目demo</h4><p><a href="http://localhost:3001/admin" target="_blank" rel="noopener">http://localhost:3001/admin</a></p>
<p><img src="/2023/05/16/Koa2学习笔记/images/project-result-02.png" alt="project-result"></p>
<h2 id="框架设计"><a href="#框架设计" class="headerlink" title="框架设计"></a>框架设计</h2><h3 id="实现概要"><a href="#实现概要" class="headerlink" title="实现概要"></a>实现概要</h3><ul>
<li>koa2 搭建服务</li>
<li>MySQL作为数据库<ul>
<li>mysql 5.7 版本</li>
<li>储存普通数据</li>
<li>存储session登录态数据 </li>
</ul>
</li>
<li>渲染<ul>
<li>服务端渲染：ejs作为服务端渲染的模板引擎</li>
<li>前端渲染：用webpack4环境编译react.js动态渲染页面，使用ant-design框架</li>
</ul>
</li>
</ul>
<h3 id="文件目录设计"><a href="#文件目录设计" class="headerlink" title="文件目录设计"></a>文件目录设计</h3><p>demo源码</p>
<p><a href="https://github.com/ChenShenhai/koa2-note/blob/master/demo/project/config.js" target="_blank" rel="noopener">https://github.com/ChenShenhai/koa2-note/blob/master/demo/project/</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">├── init <span class="comment">## 数据库初始化目录</span></span><br><span class="line">│   ├── index.js <span class="comment">## 初始化入口文件</span></span><br><span class="line">│   ├── sql/    <span class="comment">## sql脚本文件目录</span></span><br><span class="line">│   └── util/   <span class="comment">## 工具操作目录</span></span><br><span class="line">├── package.json </span><br><span class="line">├── config.js <span class="comment">## 配置文件</span></span><br><span class="line">├── server  <span class="comment">## 后端代码目录</span></span><br><span class="line">│   ├── app.js <span class="comment">## 后端服务入口文件</span></span><br><span class="line">│   ├── codes/ <span class="comment">## 提示语代码目录</span></span><br><span class="line">│   ├── controllers/    <span class="comment">## 操作层目录</span></span><br><span class="line">│   ├── models/ <span class="comment">## 数据模型model层目录</span></span><br><span class="line">│   ├── routers/ <span class="comment">## 路由目录</span></span><br><span class="line">│   ├── services/   <span class="comment">## 业务层目录</span></span><br><span class="line">│   ├── utils/  <span class="comment">## 工具类目录</span></span><br><span class="line">│   └── views/  <span class="comment">## 模板目录</span></span><br><span class="line">└── static <span class="comment">## 前端静态代码目录</span></span><br><span class="line">    ├── build/   <span class="comment">## webpack编译配置目录</span></span><br><span class="line">    ├── output/  <span class="comment">## 编译后前端代码目录&amp;静态资源前端访问目录</span></span><br><span class="line">    └── src/ <span class="comment">## 前端源代码目录</span></span><br></pre></td></tr></table></figure>
<h3 id="入口文件预览"><a href="#入口文件预览" class="headerlink" title="入口文件预览"></a>入口文件预览</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> convert = <span class="built_in">require</span>(<span class="string">'koa-convert'</span>)</span><br><span class="line"><span class="keyword">const</span> views = <span class="built_in">require</span>(<span class="string">'koa-views'</span>)</span><br><span class="line"><span class="keyword">const</span> koaStatic = <span class="built_in">require</span>(<span class="string">'koa-static'</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>)</span><br><span class="line"><span class="keyword">const</span> koaLogger = <span class="built_in">require</span>(<span class="string">'koa-logger'</span>)</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'koa-session-minimal'</span>)</span><br><span class="line"><span class="keyword">const</span> MysqlStore = <span class="built_in">require</span>(<span class="string">'koa-mysql-session'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'./../config'</span>)</span><br><span class="line"><span class="keyword">const</span> routers = <span class="built_in">require</span>(<span class="string">'./routers/index'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line"><span class="comment">// session存储配置</span></span><br><span class="line"><span class="keyword">const</span> sessionMysqlConfig= &#123;</span><br><span class="line">  user: config.database.USERNAME,</span><br><span class="line">  password: config.database.PASSWORD,</span><br><span class="line">  database: config.database.DATABASE,</span><br><span class="line">  host: config.database.HOST,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置session中间件</span></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">  key: <span class="string">'USER_SID'</span>,</span><br><span class="line">  store: <span class="keyword">new</span> MysqlStore(sessionMysqlConfig)</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置控制台日志中间件</span></span><br><span class="line">app.use(convert(koaLogger()))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置ctx.body解析中间件</span></span><br><span class="line">app.use(bodyParser())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置静态资源加载中间件</span></span><br><span class="line">app.use(convert(koaStatic(</span><br><span class="line">  path.join(__dirname , <span class="string">'./../static'</span>)</span><br><span class="line">)))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置服务端模板渲染引擎中间件</span></span><br><span class="line">app.use(views(path.join(__dirname, <span class="string">'./views'</span>), &#123;</span><br><span class="line">  extension: <span class="string">'ejs'</span></span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化路由中间件</span></span><br><span class="line">app.use(routers.routes()).use(routers.allowedMethods())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听启动端口</span></span><br><span class="line">app.listen( config.port )</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`the server is start at port <span class="subst">$&#123;config.port&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">``</span><span class="string">`## 分层设计</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### 后端代码目录</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>sh</span><br><span class="line">└── server</span><br><span class="line">    ├── controllers ## 操作层 执行服务端模板渲染，json接口返回数据，页面跳转</span><br><span class="line">    │   ├── admin.js</span><br><span class="line">    │   ├── index.js</span><br><span class="line">    │   ├── user-info.js</span><br><span class="line">    │   └── work.js</span><br><span class="line">    ├── models ## 数据模型层 执行数据操作</span><br><span class="line">    │   └── user-Info.js</span><br><span class="line">    ├── routers ## 路由层 控制路由</span><br><span class="line">    │   ├── admin.js</span><br><span class="line">    │   ├── api.js</span><br><span class="line">    │   ├── error.js</span><br><span class="line">    │   ├── home.js</span><br><span class="line">    │   ├── index.js</span><br><span class="line">    │   └── work.js</span><br><span class="line">    ├── services ## 业务层 实现数据层model到操作层controller的耦合封装</span><br><span class="line">    │   └── user-info.js</span><br><span class="line">    └── views ## 服务端模板代码</span><br><span class="line">        ├── admin.ejs</span><br><span class="line">        ├── error.ejs</span><br><span class="line">        ├── index.ejs</span><br><span class="line">        └── work.ejs</span><br></pre></td></tr></table></figure>
<h2 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h2><h3 id="初始化数据库脚本"><a href="#初始化数据库脚本" class="headerlink" title="初始化数据库脚本"></a>初始化数据库脚本</h3><h4 id="脚本目录"><a href="#脚本目录" class="headerlink" title="脚本目录"></a>脚本目录</h4><p>./demos/project/init/sql/ </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span>   <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>  <span class="string">`user_info`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT, <span class="comment">## 用户ID</span></span><br><span class="line">  <span class="string">`email`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,    <span class="comment">## 邮箱地址</span></span><br><span class="line">  <span class="string">`password`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>, <span class="comment">## 密码</span></span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,     <span class="comment">## 用户名</span></span><br><span class="line">  <span class="string">`nick`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,     <span class="comment">## 用户昵称</span></span><br><span class="line">  <span class="string">`detail_info`</span> longtext <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,  <span class="comment">## 详细信息</span></span><br><span class="line">  <span class="string">`create_time`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,   <span class="comment">## 创建时间</span></span><br><span class="line">  <span class="string">`modified_time`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>, <span class="comment">## 修改时间</span></span><br><span class="line">  <span class="string">`level`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>, <span class="comment">## 权限级别</span></span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 插入默认信息</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user_info`</span> <span class="keyword">set</span> <span class="keyword">name</span>=<span class="string">'admin001'</span>, email=<span class="string">'admin001@example.com'</span>, <span class="keyword">password</span>=<span class="string">'123456'</span>;</span><br></pre></td></tr></table></figure>
<h2 id="路由设计"><a href="#路由设计" class="headerlink" title="路由设计"></a>路由设计</h2><h3 id="使用koa-router中间件"><a href="#使用koa-router中间件" class="headerlink" title="使用koa-router中间件"></a>使用koa-router中间件</h3><h4 id="路由目录"><a href="#路由目录" class="headerlink" title="路由目录"></a>路由目录</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## ...</span></span><br><span class="line">└── server <span class="comment">## 后端代码目录</span></span><br><span class="line">    └── routers</span><br><span class="line">        ├── admin.js <span class="comment">## /admin/* 子路由</span></span><br><span class="line">        ├── api.js <span class="comment">##  resetful /api/* 子路由</span></span><br><span class="line">        ├── error.js <span class="comment">##   /error/* 子路由</span></span><br><span class="line">        ├── home.js <span class="comment">## 主页子路由</span></span><br><span class="line">        ├── index.js <span class="comment">## 子路由汇总文件</span></span><br><span class="line">        └── work.js <span class="comment">## /work/* 子路由</span></span><br><span class="line"> <span class="comment">## ...</span></span><br></pre></td></tr></table></figure>
<h4 id="子路由配置"><a href="#子路由配置" class="headerlink" title="子路由配置"></a>子路由配置</h4><h4 id="resetful-API-子路由"><a href="#resetful-API-子路由" class="headerlink" title="resetful API 子路由"></a>resetful API 子路由</h4><p>例如api子路由/user/getUserInfo.json，整合到主路由，加载到中间件后，请求的路径会是 <a href="http://www.example.com/api/user/getUserInfo.json" target="_blank" rel="noopener">http://www.example.com/api/user/getUserInfo.json</a></p>
<p>./demos/project/server/routers/api.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * restful api 子路由</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)()</span><br><span class="line"><span class="keyword">const</span> userInfoController = <span class="built_in">require</span>(<span class="string">'./../controllers/user-info'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routers = router</span><br><span class="line">  .get(<span class="string">'/user/getUserInfo.json'</span>, userInfoController.getLoginUserInfo)</span><br><span class="line">  .post(<span class="string">'/user/signIn.json'</span>, userInfoController.signIn)</span><br><span class="line">  .post(<span class="string">'/user/signUp.json'</span>, userInfoController.signUp)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = routers</span><br></pre></td></tr></table></figure></p>
<h5 id="子路由汇总"><a href="#子路由汇总" class="headerlink" title="子路由汇总"></a>子路由汇总</h5><p>./demos/project/server/routers/index.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 整合所有子路由</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> home = <span class="built_in">require</span>(<span class="string">'./home'</span>)</span><br><span class="line"><span class="keyword">const</span> api = <span class="built_in">require</span>(<span class="string">'./api'</span>)</span><br><span class="line"><span class="keyword">const</span> admin = <span class="built_in">require</span>(<span class="string">'./admin'</span>)</span><br><span class="line"><span class="keyword">const</span> work = <span class="built_in">require</span>(<span class="string">'./work'</span>)</span><br><span class="line"><span class="keyword">const</span> error = <span class="built_in">require</span>(<span class="string">'./error'</span>)</span><br><span class="line"></span><br><span class="line">router.use(<span class="string">'/'</span>, home.routes(), home.allowedMethods())</span><br><span class="line">router.use(<span class="string">'/api'</span>, api.routes(), api.allowedMethods())</span><br><span class="line">router.use(<span class="string">'/admin'</span>, admin.routes(), admin.allowedMethods())</span><br><span class="line">router.use(<span class="string">'/work'</span>, work.routes(), work.allowedMethods())</span><br><span class="line">router.use(<span class="string">'/error'</span>, error.routes(), error.allowedMethods())</span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br></pre></td></tr></table></figure></p>
<h5 id="app-js加载路由中间件"><a href="#app-js加载路由中间件" class="headerlink" title="app.js加载路由中间件"></a>app.js加载路由中间件</h5><p>./demos/project/server/app.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routers = <span class="built_in">require</span>(<span class="string">'./routers/index'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化路由中间件</span></span><br><span class="line">app.use(routers.routes()).use(routers.allowedMethods())</span><br></pre></td></tr></table></figure></p>
<h2 id="webpack4-环境搭建"><a href="#webpack4-环境搭建" class="headerlink" title="webpack4 环境搭建"></a>webpack4 环境搭建</h2><h3 id="前言-6"><a href="#前言-6" class="headerlink" title="前言"></a>前言</h3><p>由于demos/project 前端渲染是通过react.js渲染的，这就需要webpack4 对react.js及其相关JSX，ES6/7代码进行编译和混淆压缩。</p>
<h3 id="webpack4"><a href="#webpack4" class="headerlink" title="webpack4"></a>webpack4</h3><h4 id="安装和文档"><a href="#安装和文档" class="headerlink" title="安装和文档"></a>安装和文档</h4><p>可访问网<a href="https://webpack.js.org/" target="_blank" rel="noopener">https://webpack.js.org/</a></p>
<h3 id="配置webpack4编译react-js-less-sass-antd-环境"><a href="#配置webpack4编译react-js-less-sass-antd-环境" class="headerlink" title="配置webpack4编译react.js + less + sass + antd 环境"></a>配置webpack4编译react.js + less + sass + antd 环境</h3><h4 id="文件目录-1"><a href="#文件目录-1" class="headerlink" title="文件目录"></a>文件目录</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">└── static <span class="comment">## 项目静态文件目录</span></span><br><span class="line">    ├── build</span><br><span class="line">    │   ├── webpack.base.config.js <span class="comment">## 基础编译脚本</span></span><br><span class="line">    │   ├── webpack.dev.config.js <span class="comment">## 开发环境编译脚本</span></span><br><span class="line">    │   └── webpack.prod.config.js <span class="comment">## 生产环境编译脚本</span></span><br><span class="line">    ├── output <span class="comment">## 编译后输出目录</span></span><br><span class="line">    │   ├── asset</span><br><span class="line">    │   ├── dist</span><br><span class="line">    │   └── upload</span><br><span class="line">    └── src <span class="comment">## 待编译的ES6/7、JSX源代码</span></span><br><span class="line">        ├── api</span><br><span class="line">        ├── apps</span><br><span class="line">        ├── components</span><br><span class="line">        ├── pages</span><br><span class="line">        ├── texts</span><br><span class="line">        └── utils</span><br></pre></td></tr></table></figure>
<h4 id="webpack4-编译基础配置"><a href="#webpack4-编译基础配置" class="headerlink" title="webpack4 编译基础配置"></a>webpack4 编译基础配置</h4><h5 id="babel-7-配置"><a href="#babel-7-配置" class="headerlink" title="babel@7 配置"></a>babel@7 配置</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> babelConfig = &#123;</span><br><span class="line">  presets: [</span><br><span class="line">    <span class="string">'@babel/env'</span>,</span><br><span class="line">    <span class="comment">// [</span></span><br><span class="line">    <span class="comment">//   '@babel/env',</span></span><br><span class="line">    <span class="comment">//   &#123;</span></span><br><span class="line">    <span class="comment">//     targets: &#123;</span></span><br><span class="line">    <span class="comment">//       edge: '17',</span></span><br><span class="line">    <span class="comment">//       firefox: '60',</span></span><br><span class="line">    <span class="comment">//       chrome: '67',</span></span><br><span class="line">    <span class="comment">//       safari: '11.1'</span></span><br><span class="line">    <span class="comment">//     &#125;,</span></span><br><span class="line">    <span class="comment">//     useBuiltIns: 'usage'</span></span><br><span class="line">    <span class="comment">//   &#125;</span></span><br><span class="line">    <span class="comment">// ],</span></span><br><span class="line">    <span class="string">'@babel/preset-react'</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">'plugins'</span>: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">'import'</span>,</span><br><span class="line">      &#123; <span class="string">'libraryName'</span>: <span class="string">'antd'</span>, <span class="string">'libraryDirectory'</span>: <span class="string">'lib'</span> &#125;,</span><br><span class="line">      <span class="string">'ant'</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">      <span class="string">'import'</span>,</span><br><span class="line">      &#123; <span class="string">'libraryName'</span>: <span class="string">'antd-mobile'</span>, <span class="string">'libraryDirectory'</span>: <span class="string">'lib'</span> &#125;,</span><br><span class="line">      <span class="string">'antd-mobile'</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">'@babel/plugin-proposal-class-properties'</span></span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = babelConfig;</span><br></pre></td></tr></table></figure>
<h5 id="webpack-base-config-js"><a href="#webpack-base-config-js" class="headerlink" title="webpack.base.config.js"></a>webpack.base.config.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</span><br><span class="line"><span class="keyword">const</span> MiniCssExtractPlugin = <span class="built_in">require</span>(<span class="string">'mini-css-extract-plugin'</span>);</span><br><span class="line"><span class="keyword">const</span> babelConfig = <span class="built_in">require</span>(<span class="string">'./babel.config'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// const prodMode = process.env.NODE_ENV === 'production';</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> srcResolve = <span class="function"><span class="keyword">function</span> (<span class="params">file</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> path.join(__dirname, <span class="string">'..'</span>, <span class="string">'src'</span>, file);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> distResolve = <span class="function"><span class="keyword">function</span> (<span class="params">file</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> path.join(__dirname, <span class="string">'..'</span>, <span class="string">'output'</span>, <span class="string">'dist'</span>, file);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    <span class="string">'index'</span>: srcResolve(<span class="string">'js/index'</span>),</span><br><span class="line">    <span class="string">'admin'</span> : srcResolve(<span class="string">'pages/admin.js'</span>),</span><br><span class="line">    <span class="string">'work'</span> : srcResolve(<span class="string">'pages/work.js'</span>),</span><br><span class="line">    <span class="string">'index'</span> : srcResolve(<span class="string">'pages/index.js'</span>),</span><br><span class="line">    <span class="string">'error'</span> : srcResolve(<span class="string">'pages/error.js'</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: distResolve(<span class="string">''</span>),</span><br><span class="line">    filename: <span class="string">'vendorjs/[name].js'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.(js|jsx)$/</span>,</span><br><span class="line">        use: &#123;</span><br><span class="line">          loader: <span class="string">'babel-loader'</span>,</span><br><span class="line">          options: babelConfig</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.(css|less)$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          <span class="comment">// devMode ? 'style-loader' : MiniCssExtractPlugin.loader,</span></span><br><span class="line">          <span class="comment">// 'style-loader',</span></span><br><span class="line">          MiniCssExtractPlugin.loader,</span><br><span class="line">          <span class="string">'css-loader'</span>,</span><br><span class="line">          <span class="comment">// 'postcss-loader',</span></span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'postcss-loader'</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              plugins: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> [];</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">'less-loader'</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> MiniCssExtractPlugin(&#123;</span><br><span class="line">      filename: <span class="string">'css/[name].css'</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ],</span><br><span class="line">  optimization: &#123;</span><br><span class="line">    splitChunks: &#123;</span><br><span class="line">      cacheGroups: &#123;</span><br><span class="line">        commons: &#123;</span><br><span class="line">          test: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">          name: <span class="string">'vendor'</span>,</span><br><span class="line">          chunks: <span class="string">'all'</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="配置开发-amp-生产环境webpack4-编译设置"><a href="#配置开发-amp-生产环境webpack4-编译设置" class="headerlink" title="配置开发&amp;生产环境webpack4 编译设置"></a>配置开发&amp;生产环境webpack4 编译设置</h4><p>为了方便编译基本配置代码统一管理，开发环境（wepack.dev.config.js）和生产环境（webpack.prod.config.js）的编译配置都是继承了基本配置（wepack.base.config.js）的代码</p>
<h5 id="开发环境配置-wepack-dev-config-js"><a href="#开发环境配置-wepack-dev-config-js" class="headerlink" title="开发环境配置 wepack.dev.config.js"></a>开发环境配置 wepack.dev.config.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> merge = <span class="built_in">require</span>(<span class="string">'webpack-merge'</span>)</span><br><span class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line"><span class="keyword">var</span> baseWebpackConfig = <span class="built_in">require</span>(<span class="string">'./webpack.base.config'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = merge(baseWebpackConfig, &#123;</span><br><span class="line"></span><br><span class="line">  devtool: <span class="string">'source-map'</span>,</span><br><span class="line">  plugins: [</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">new</span> webpack.DefinePlugin(&#123;</span><br><span class="line">      <span class="string">'process.env'</span>: &#123;</span><br><span class="line">        NODE_ENV: <span class="built_in">JSON</span>.stringify(<span class="string">'development'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;),</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h5 id="编译环境配置-wepack-prod-config-js"><a href="#编译环境配置-wepack-prod-config-js" class="headerlink" title="编译环境配置 wepack.prod.config.js"></a>编译环境配置 wepack.prod.config.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">process.env.NODE_ENV = <span class="string">'production'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> merge = <span class="built_in">require</span>(<span class="string">'webpack-merge'</span>);</span><br><span class="line"><span class="keyword">const</span> UglifyJsPlugin = <span class="built_in">require</span>(<span class="string">'uglifyjs-webpack-plugin'</span>);</span><br><span class="line"><span class="keyword">const</span> OptimizeCSSAssetsPlugin = <span class="built_in">require</span>(<span class="string">'optimize-css-assets-webpack-plugin'</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'./webpack.base.config'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = merge(config, &#123;</span><br><span class="line">  mode: <span class="string">'production'</span>,</span><br><span class="line">  <span class="comment">// plugins: [</span></span><br><span class="line">  <span class="comment">//   new UglifyJsPlugin()</span></span><br><span class="line">  <span class="comment">// ]</span></span><br><span class="line">  optimization: &#123;</span><br><span class="line">    minimizer: [</span><br><span class="line">      <span class="keyword">new</span> UglifyJsPlugin(&#123;</span><br><span class="line">        cache: <span class="literal">true</span>,</span><br><span class="line">        parallel: <span class="literal">true</span></span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="keyword">new</span> OptimizeCSSAssetsPlugin(&#123;&#125;)</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="使用react-js"><a href="#使用react-js" class="headerlink" title="使用react.js"></a>使用react.js</h2><h3 id="react-js简介"><a href="#react-js简介" class="headerlink" title="react.js简介"></a>react.js简介</h3><p>react.js 是作为前端渲染的js库（注意：不是框架）。react.js用JSX开发来描述DOM结构，通过编译成virtual dom的在浏览器中进行view渲染和动态交互处理。更多了解可查阅GitHub<a href="https://facebook.github.io/react/" target="_blank" rel="noopener">https://facebook.github.io/react/</a></p>
<h3 id="编译使用"><a href="#编译使用" class="headerlink" title="编译使用"></a>编译使用</h3><p>由于react.js开发过程用JSX编程，无法直接在浏览器中运行，需要编译成浏览器可识别运行的virtual dom。从JSX开发到运行，需要有一个编译的过程。目前最常用的方案是用webpack + babel进行编译打包。</p>
<h3 id="前端待编译源文件目录"><a href="#前端待编译源文件目录" class="headerlink" title="前端待编译源文件目录"></a>前端待编译源文件目录</h3><p>demos/project/static/<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── build <span class="comment">## 编译的webpack脚本</span></span><br><span class="line">│   ├── webpack.base.config.js</span><br><span class="line">│   ├── webpack.dev.config.js</span><br><span class="line">│   └── webpack.prod.config.js</span><br><span class="line">├── output <span class="comment">## 输出文件</span></span><br><span class="line">│   ├── asset</span><br><span class="line">│   ├── dist <span class="comment">##  react.js编译后的文件目录</span></span><br><span class="line">│   └── ...</span><br><span class="line">└── src</span><br><span class="line">   ├── apps <span class="comment">## 页面react.js应用</span></span><br><span class="line">   │   ├── admin.jsx</span><br><span class="line">   │   ├── error.jsx</span><br><span class="line">   │   ├── index.jsx</span><br><span class="line">   │   └── work.jsx</span><br><span class="line">   ├── components <span class="comment">## jsx 模块、组件</span></span><br><span class="line">   │   ├── footer-common.jsx</span><br><span class="line">   │   ├── form-group.jsx</span><br><span class="line">   │   ├── header-nav.jsx</span><br><span class="line">   │   ├── sign-in-form.jsx</span><br><span class="line">   │   └── sign-up-form.jsx</span><br><span class="line">   └── pages <span class="comment">## react.js 执行render文件目录</span></span><br><span class="line">       ├── admin.js</span><br><span class="line">       ├── error.js</span><br><span class="line">       ├── index.js</span><br><span class="line">       └── work.js</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure></p>
<h4 id="react-js页面应用文件"><a href="#react-js页面应用文件" class="headerlink" title="react.js页面应用文件"></a>react.js页面应用文件</h4><p>static/src/apps/index.jsx 文件<br><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Layout, Menu, Breadcrumb &#125; <span class="keyword">from</span> <span class="string">'antd'</span></span><br><span class="line"><span class="keyword">import</span> HeadeNav <span class="keyword">from</span> <span class="string">'./../components/header-nav.jsx'</span></span><br><span class="line"><span class="keyword">import</span> FooterCommon <span class="keyword">from</span> <span class="string">'./../components/footer-common.jsx'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'antd/lib/layout/style/css'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; Header, Content, Footer &#125; = Layout</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Layout className=<span class="string">"layout"</span>&gt;</span><br><span class="line">        &lt;HeadeNav/&gt;</span><br><span class="line">        &lt;Content style=&#123;&#123; <span class="attr">padding</span>: <span class="string">'0 50px'</span> &#125;&#125;&gt;</span><br><span class="line">          &lt;Breadcrumb style=&#123;&#123; <span class="attr">margin</span>: <span class="string">'12px 0'</span> &#125;&#125;&gt;</span><br><span class="line">            &lt;Breadcrumb.Item&gt;Home&lt;<span class="regexp">/Breadcrumb.Item&gt;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>Breadcrumb&gt;</span><br><span class="line">          &lt;div style=&#123;&#123; <span class="attr">background</span>: <span class="string">'#fff'</span>, <span class="attr">padding</span>: <span class="number">24</span>, <span class="attr">minHeight</span>: <span class="number">280</span> &#125;&#125;&gt;</span><br><span class="line">            &lt;p&gt;index&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>div&gt;</span><br><span class="line">        &lt;<span class="regexp">/Content&gt;</span></span><br><span class="line"><span class="regexp">        &lt;FooterCommon /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/Layout&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">export default App</span></span><br></pre></td></tr></table></figure></p>
<h4 id="react-js执行render渲染"><a href="#react-js执行render渲染" class="headerlink" title="react.js执行render渲染"></a>react.js执行render渲染</h4><p>static/src/pages/index.js 文件<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./../apps/index.jsx'</span></span><br><span class="line"></span><br><span class="line">ReactDOM.render( <span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">"app"</span>))</span><br></pre></td></tr></table></figure></p>
<h4 id="静态页面引用react-js编译后文件"><a href="#静态页面引用react-js编译后文件" class="headerlink" title="静态页面引用react.js编译后文件"></a>静态页面引用react.js编译后文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;&lt;%= title %&gt;&lt;/title&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"/output/dist/css/index.css"</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div id=<span class="string">"app"</span>&gt;&lt;/div&gt;</span><br><span class="line">    &lt;script src=<span class="string">"/output/dist/js/vendor.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">"/output/dist/js/index.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h4 id="页面渲染效果"><a href="#页面渲染效果" class="headerlink" title="页面渲染效果"></a>页面渲染效果</h4><p><img src="/2023/05/16/Koa2学习笔记/images/project-result-00.png" alt="project-result-01.png"></p>
<h2 id="登录注册功能实现"><a href="#登录注册功能实现" class="headerlink" title="登录注册功能实现"></a>登录注册功能实现</h2><h3 id="用户模型dao操作"><a href="#用户模型dao操作" class="headerlink" title="用户模型dao操作"></a>用户模型dao操作</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 数据库创建用户</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;object&#125;</span> </span>model 用户数据模型</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123;object&#125;</span>       </span>mysql执行结果</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> create ( model ) &#123;</span><br><span class="line">    <span class="keyword">let</span> result = <span class="keyword">await</span> dbUtils.insertData( <span class="string">'user_info'</span>, model )</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 查找一个存在用户的数据</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;obejct&#125;</span> </span>options 查找条件参数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123;object|null&#125;</span>        </span>查找结果</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> getExistOne(options ) &#123;</span><br><span class="line">    <span class="keyword">let</span> _sql = <span class="string">`</span></span><br><span class="line"><span class="string">    SELECT * from user_info</span></span><br><span class="line"><span class="string">      where email="<span class="subst">$&#123;options.email&#125;</span>" or name="<span class="subst">$&#123;options.name&#125;</span>"</span></span><br><span class="line"><span class="string">      limit 1`</span></span><br><span class="line">    <span class="keyword">let</span> result = <span class="keyword">await</span> dbUtils.query( _sql )</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">Array</span>.isArray(result) &amp;&amp; result.length &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">      result = result[<span class="number">0</span>]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 根据用户名和密码查找用户</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;object&#125;</span> </span>options 用户名密码对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123;object|null&#125;</span>         </span>查找结果</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> getOneByUserNameAndPassword( options ) &#123;</span><br><span class="line">    <span class="keyword">let</span> _sql = <span class="string">`</span></span><br><span class="line"><span class="string">    SELECT * from user_info</span></span><br><span class="line"><span class="string">      where password="<span class="subst">$&#123;options.password&#125;</span>" and name="<span class="subst">$&#123;options.name&#125;</span>"</span></span><br><span class="line"><span class="string">      limit 1`</span></span><br><span class="line">    <span class="keyword">let</span> result = <span class="keyword">await</span> dbUtils.query( _sql )</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">Array</span>.isArray(result) &amp;&amp; result.length &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">      result = result[<span class="number">0</span>]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 根据用户名查找用户信息</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>userName 用户账号名称</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123;object|null&#125;</span>     </span>查找结果</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> getUserInfoByUserName( userName ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> result = <span class="keyword">await</span> dbUtils.select(</span><br><span class="line">      <span class="string">'user_info'</span>,</span><br><span class="line">      [<span class="string">'id'</span>, <span class="string">'email'</span>, <span class="string">'name'</span>, <span class="string">'detail_info'</span>, <span class="string">'create_time'</span>, <span class="string">'modified_time'</span>, <span class="string">'modified_time'</span> ])</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">Array</span>.isArray(result) &amp;&amp; result.length &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">      result = result[<span class="number">0</span>]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<h4 id="业务层操作"><a href="#业务层操作" class="headerlink" title="业务层操作"></a>业务层操作</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 创建用户</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;object&#125;</span> </span>user 用户信息</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123;object&#125;</span>      </span>创建结果</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> create( user ) &#123;</span><br><span class="line">    <span class="keyword">let</span> result = <span class="keyword">await</span> userModel.create(user)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 查找存在用户信息</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;object&#125;</span> </span>formData 查找的表单数据</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123;object|null&#125;</span>      </span>查找结果</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> getExistOne( formData ) &#123;</span><br><span class="line">    <span class="keyword">let</span> resultData = <span class="keyword">await</span> userModel.getExistOne(&#123;</span><br><span class="line">      <span class="string">'email'</span>: formData.email,</span><br><span class="line">      <span class="string">'name'</span>: formData.userName</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> resultData</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 登录业务操作</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;object&#125;</span> </span>formData 登录表单信息</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123;object&#125;</span>          </span>登录业务操作结果</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> signIn( formData ) &#123;</span><br><span class="line">    <span class="keyword">let</span> resultData = <span class="keyword">await</span> userModel.getOneByUserNameAndPassword(&#123;</span><br><span class="line">      <span class="string">'password'</span>: formData.password,</span><br><span class="line">      <span class="string">'name'</span>: formData.userName&#125;)</span><br><span class="line">    <span class="keyword">return</span> resultData</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 根据用户名查找用户业务操作</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;string&#125;</span> </span>userName 用户名</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123;object|null&#125;</span>     </span>查找结果</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> getUserInfoByUserName( userName ) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> resultData = <span class="keyword">await</span> userModel.getUserInfoByUserName( userName ) || &#123;&#125;</span><br><span class="line">    <span class="keyword">let</span> userInfo = &#123;</span><br><span class="line">      <span class="comment">// id: resultData.id,</span></span><br><span class="line">      email: resultData.email,</span><br><span class="line">      userName: resultData.name,</span><br><span class="line">      detailInfo: resultData.detail_info,</span><br><span class="line">      createTime: resultData.create_time</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> userInfo</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 检验用户注册数据</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;object&#125;</span> </span>userInfo 用户注册数据</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123;object&#125;</span>          </span>校验结果</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  validatorSignUp( userInfo ) &#123;</span><br><span class="line">    <span class="keyword">let</span> result = &#123;</span><br><span class="line">      success: <span class="literal">false</span>,</span><br><span class="line">      message: <span class="string">''</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( <span class="regexp">/[a-z0-9\_\-]&#123;6,16&#125;/</span>.test(userInfo.userName) === <span class="literal">false</span> ) &#123;</span><br><span class="line">      result.message = userCode.ERROR_USER_NAME</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !validator.isEmail( userInfo.email ) ) &#123;</span><br><span class="line">      result.message = userCode.ERROR_EMAIL</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="regexp">/[\w+]&#123;6,16&#125;/</span>.test( userInfo.password )  ) &#123;</span><br><span class="line">      result.message = userCode.ERROR_PASSWORD</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( userInfo.password !== userInfo.confirmPassword ) &#123;</span><br><span class="line">      result.message = userCode.ERROR_PASSWORD_CONFORM</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result.success = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="controller-操作"><a href="#controller-操作" class="headerlink" title="controller 操作"></a>controller 操作</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 登录操作</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;obejct&#125;</span> </span>ctx 上下文对象</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">async</span> signIn( ctx ) &#123;</span><br><span class="line">   <span class="keyword">let</span> formData = ctx.request.body</span><br><span class="line">   <span class="keyword">let</span> result = &#123;</span><br><span class="line">     success: <span class="literal">false</span>,</span><br><span class="line">     message: <span class="string">''</span>,</span><br><span class="line">     data: <span class="literal">null</span>,</span><br><span class="line">     code: <span class="string">''</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">let</span> userResult = <span class="keyword">await</span> userInfoService.signIn( formData )</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> ( userResult ) &#123;</span><br><span class="line">     <span class="keyword">if</span> ( formData.userName === userResult.name ) &#123;</span><br><span class="line">       result.success = <span class="literal">true</span></span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       result.message = userCode.FAIL_USER_NAME_OR_PASSWORD_ERROR</span><br><span class="line">       result.code = <span class="string">'FAIL_USER_NAME_OR_PASSWORD_ERROR'</span></span><br><span class="line">     &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     result.code = <span class="string">'FAIL_USER_NO_EXIST'</span>,</span><br><span class="line">     result.message = userCode.FAIL_USER_NO_EXIST</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> ( formData.source === <span class="string">'form'</span> &amp;&amp; result.success === <span class="literal">true</span> ) &#123;</span><br><span class="line">     <span class="keyword">let</span> session = ctx.session</span><br><span class="line">     session.isLogin = <span class="literal">true</span></span><br><span class="line">     session.userName = userResult.name</span><br><span class="line">     session.userId = userResult.id</span><br><span class="line"></span><br><span class="line">     ctx.redirect(<span class="string">'/work'</span>)</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     ctx.body = result</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;,</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 注册操作</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param   <span class="type">&#123;obejct&#125;</span> </span>ctx 上下文对象</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">async</span> signUp( ctx ) &#123;</span><br><span class="line">   <span class="keyword">let</span> formData = ctx.request.body</span><br><span class="line">   <span class="keyword">let</span> result = &#123;</span><br><span class="line">     success: <span class="literal">false</span>,</span><br><span class="line">     message: <span class="string">''</span>,</span><br><span class="line">     data: <span class="literal">null</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">let</span> validateResult = userInfoService.validatorSignUp( formData )</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> ( validateResult.success === <span class="literal">false</span> ) &#123;</span><br><span class="line">     result = validateResult</span><br><span class="line">     ctx.body = result</span><br><span class="line">     <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">let</span> existOne  = <span class="keyword">await</span> userInfoService.getExistOne(formData)</span><br><span class="line">   <span class="built_in">console</span>.log( existOne )</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> ( existOne  ) &#123;</span><br><span class="line">     <span class="keyword">if</span> ( existOne .name === formData.userName ) &#123;</span><br><span class="line">       result.message = userCode.FAIL_USER_NAME_IS_EXIST</span><br><span class="line">       ctx.body = result</span><br><span class="line">       <span class="keyword">return</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> ( existOne .email === formData.email ) &#123;</span><br><span class="line">       result.message = userCode.FAIL_EMAIL_IS_EXIST</span><br><span class="line">       ctx.body = result</span><br><span class="line">       <span class="keyword">return</span></span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">let</span> userResult = <span class="keyword">await</span> userInfoService.create(&#123;</span><br><span class="line">     email: formData.email,</span><br><span class="line">     password: formData.password,</span><br><span class="line">     name: formData.userName,</span><br><span class="line">     create_time: <span class="keyword">new</span> <span class="built_in">Date</span>().getTime(),</span><br><span class="line">     level: <span class="number">1</span>,</span><br><span class="line">   &#125;)</span><br><span class="line"></span><br><span class="line">   <span class="built_in">console</span>.log( userResult )</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> ( userResult &amp;&amp; userResult.insertId * <span class="number">1</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">     result.success = <span class="literal">true</span></span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     result.message = userCode.ERROR_SYS</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   ctx.body = result</span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure>
<h4 id="api路由操作"><a href="#api路由操作" class="headerlink" title="api路由操作"></a>api路由操作</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)()</span><br><span class="line"><span class="keyword">const</span> userInfoController = <span class="built_in">require</span>(<span class="string">'./../controllers/user-info'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routers = router</span><br><span class="line">  .get(<span class="string">'/user/getUserInfo.json'</span>, userInfoController.getLoginUserInfo)</span><br><span class="line">  .post(<span class="string">'/user/signIn.json'</span>, userInfoController.signIn)</span><br><span class="line">  .post(<span class="string">'/user/signUp.json'</span>, userInfoController.signUp)</span><br></pre></td></tr></table></figure>
<h3 id="前端用react-js实现效果"><a href="#前端用react-js实现效果" class="headerlink" title="前端用react.js实现效果"></a>前端用react.js实现效果</h3><p>登录模式<br><img src="/2023/05/16/Koa2学习笔记/images/project-result-01.png" alt="project-result-01"><br>注册模式<br><img src="/2023/05/16/Koa2学习笔记/images/project-result-02.png" alt="project-result-01"></p>
<h2 id="session登录态判断处理"><a href="#session登录态判断处理" class="headerlink" title="session登录态判断处理"></a>session登录态判断处理</h2><h3 id="使用session中间件"><a href="#使用session中间件" class="headerlink" title="使用session中间件"></a>使用session中间件</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// code ...</span></span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'koa-session-minimal'</span>)</span><br><span class="line"><span class="keyword">const</span> MysqlStore = <span class="built_in">require</span>(<span class="string">'koa-mysql-session'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'./../config'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// code ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line"><span class="comment">// session存储配置</span></span><br><span class="line"><span class="keyword">const</span> sessionMysqlConfig= &#123;</span><br><span class="line">  user: config.database.USERNAME,</span><br><span class="line">  password: config.database.PASSWORD,</span><br><span class="line">  database: config.database.DATABASE,</span><br><span class="line">  host: config.database.HOST,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置session中间件</span></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">  key: <span class="string">'USER_SID'</span>,</span><br><span class="line">  store: <span class="keyword">new</span> MysqlStore(sessionMysqlConfig)</span><br><span class="line">&#125;))</span><br><span class="line"><span class="comment">// code ...</span></span><br></pre></td></tr></table></figure>
<h3 id="登录成功后设置session到MySQL和设置sessionId到cookie"><a href="#登录成功后设置session到MySQL和设置sessionId到cookie" class="headerlink" title="登录成功后设置session到MySQL和设置sessionId到cookie"></a>登录成功后设置session到MySQL和设置sessionId到cookie</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> session = ctx.session</span><br><span class="line">session.isLogin = <span class="literal">true</span></span><br><span class="line">session.userName = userResult.name</span><br><span class="line">session.userId = userResult.id</span><br></pre></td></tr></table></figure>
<h3 id="需要判断登录态页面进行session判断"><a href="#需要判断登录态页面进行session判断" class="headerlink" title="需要判断登录态页面进行session判断"></a>需要判断登录态页面进行session判断</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> indexPage ( ctx ) &#123;</span><br><span class="line">    <span class="comment">// 判断是否有session</span></span><br><span class="line">    <span class="keyword">if</span> ( ctx.session &amp;&amp; ctx.session.isLogin &amp;&amp; ctx.session.userName ) &#123;</span><br><span class="line">      <span class="keyword">const</span> title = <span class="string">'work页面'</span></span><br><span class="line">      <span class="keyword">await</span> ctx.render(<span class="string">'work'</span>, &#123;</span><br><span class="line">        title,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 没有登录态则跳转到错误页面</span></span><br><span class="line">      ctx.redirect(<span class="string">'/error'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<h1 id="其他进阶"><a href="#其他进阶" class="headerlink" title="其他进阶"></a>其他进阶</h1><h3 id="前言-7"><a href="#前言-7" class="headerlink" title="前言"></a>前言</h3><p> Node 9最激动人心的是提供了在flag模式下使用<code>ECMAScript Modules</code>，虽然现在还是<code>Stability: 1 - Experimental</code>阶段，但是可以让Noder抛掉babel等工具的束缚，直接在Node环境下愉快地去玩耍<code>import/export</code></p>
<p>如果觉得文字太多，看不下去，可以直接去玩玩demo，地址是<a href="https://github.com/chenshenhai/node-modules-demo" target="_blank" rel="noopener">https://github.com/chenshenhai/node-modules-demo</a></p>
<h3 id="Node-9下import-export使用简单须知"><a href="#Node-9下import-export使用简单须知" class="headerlink" title="Node 9下import/export使用简单须知"></a>Node 9下import/export使用简单须知</h3><ul>
<li>Node 环境必须在 9.0以上</li>
<li>不加loader时候，使用<code>import/export</code>的文件后缀名必须为<code>*.mjs</code>（下面会讲利用Loader Hooks兼容<code>*.js</code>后缀文件） </li>
<li>启动必须加上flag <code>--experimental-modules</code></li>
<li>文件的<code>import</code>和<code>export</code>必须严格按照<code>ECMAScript Modules</code>语法</li>
<li><code>ECMAScript Modules</code>和<code>require()</code>的cache机制不一样</li>
</ul>
<h3 id="使用简述"><a href="#使用简述" class="headerlink" title="使用简述"></a>使用简述</h3><p>Node 9.x官方文档 <a href="https://nodejs.org/dist/latest-v9.x/docs/api/esm.html" target="_blank" rel="noopener">https://nodejs.org/dist/latest-v9.x/docs/api/esm.html</a></p>
<h4 id="与require-区别"><a href="#与require-区别" class="headerlink" title="与require()区别"></a>与require()区别</h4><table>
<thead>
<tr>
<th>能力</th>
<th>描述</th>
<th>require()</th>
<th>import</th>
</tr>
</thead>
<tbody>
<tr>
<td>NODE_PATH</td>
<td>从NODE_PATH加载依赖模块</td>
<td>Y</td>
<td>N</td>
</tr>
<tr>
<td>cache</td>
<td>缓存机制</td>
<td>可以通过require的API操作缓存</td>
<td>自己独立的缓存机制，目前不可访问</td>
</tr>
<tr>
<td>path</td>
<td>引用路径</td>
<td>文件路径</td>
<td>URL格式文件路径，例如<code>import A from &#39;./a?v=2017&#39;</code></td>
</tr>
<tr>
<td>extensions</td>
<td>扩展名机制</td>
<td>require.extensions</td>
<td>Loader Hooks</td>
</tr>
<tr>
<td>natives</td>
<td>原生模块引用</td>
<td>直接支持</td>
<td>直接支持</td>
</tr>
<tr>
<td>npm</td>
<td>npm模块引用</td>
<td>直接支持</td>
<td>需要Loader Hooks</td>
</tr>
<tr>
<td>file</td>
<td>文件(引用)</td>
<td><code>*.js</code>,<code>*.json</code>等直接支持</td>
<td>默认只能是<code>*.mjs</code>，通过<code>Loader Hooks</code>可以自定义配置规则支持<code>*.js</code>,<code>*.json</code>等Node原有支持文件</td>
</tr>
</tbody>
</table>
<h3 id="Loader-Hooks模式使用"><a href="#Loader-Hooks模式使用" class="headerlink" title="Loader Hooks模式使用"></a>Loader Hooks模式使用</h3><blockquote>
<p>由于历史原因，在ES6的Modules还没确定之前，JavaScript的模块化处理方案都是八仙过海，各显神通，例如前端的AMD、CMD模块方案，Node的CommonJS方案也在这个“乱世”诞生。<br>当到了ES6规范确定后，Node的CommonJS方案已经是JavaScript中比较成熟的模块化方案，但ES6怎么说都是正统的规范，“法理”上是需要兼容的，所以<code>*.mjs</code>这个针对<code>ECMAScript Modules</code>规范的Node文件方案在一片讨论声中应运而生。</p>
</blockquote>
<blockquote>
<p>当然如果<code>import/export</code>只能对<code>*.mjs</code>文件起作用，意味着Node原生模块和npm所有第三方模块都不能。所以这时候Node 9就提供了 <code>Loader Hooks</code>，开发者可自定义配置<code>Resolve Hook</code>规则去利用<code>import/export</code>加载使用Node原生模块，<code>*.js</code>文件，npm模块，C/C++的Node编译模块等Node生态圈的模块。</p>
</blockquote>
<h4 id="Loader-Hooks-使用步骤"><a href="#Loader-Hooks-使用步骤" class="headerlink" title="Loader Hooks 使用步骤"></a>Loader Hooks 使用步骤</h4><ul>
<li>自定义loader规则</li>
<li>启动的flag要加载loader规则文件 <ul>
<li>例如：<code>node --experimental-modules  --loader ./custom-loader.mjs ./index.js</code></li>
</ul>
</li>
</ul>
<h3 id="Koa2-直接使用import-export"><a href="#Koa2-直接使用import-export" class="headerlink" title="Koa2 直接使用import/export"></a>Koa2 直接使用import/export</h3><p>看看demo4，<a href="https://github.com/chenshenhai/node-modules-demo/tree/master/demo4" target="_blank" rel="noopener">https://github.com/chenshenhai/node-modules-demo/tree/master/demo4</a></p>
<ul>
<li>文件目录</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">├── esm</span><br><span class="line">│   ├── README.md</span><br><span class="line">│   ├── custom-loader.mjs</span><br><span class="line">│   ├── index.js</span><br><span class="line">│   ├── lib</span><br><span class="line">│   │   ├── data.json</span><br><span class="line">│   │   ├── path.js</span><br><span class="line">│   │   └── render.js</span><br><span class="line">│   ├── package.json</span><br><span class="line">│   └── view</span><br><span class="line">│       ├── index.html</span><br><span class="line">│       ├── index.html</span><br><span class="line">│       └── todo.html</span><br></pre></td></tr></table></figure>
<p>代码片段太多，不一一贴出来，只显示主文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Koa <span class="keyword">from</span> <span class="string">'koa'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; render &#125; <span class="keyword">from</span> <span class="string">'./lib/render.js'</span>;</span><br><span class="line"><span class="keyword">import</span> data <span class="keyword">from</span> <span class="string">'./lib/data.json'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line">app.use(<span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> view = ctx.url.substr(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">let</span> content;</span><br><span class="line">    <span class="keyword">if</span> ( view === <span class="string">''</span> ) &#123;</span><br><span class="line">        content = render(<span class="string">'index'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( view === <span class="string">'data'</span> ) &#123;</span><br><span class="line">        content = data;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        content = render(view);</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.body = content;</span><br><span class="line">&#125;)</span><br><span class="line">app.listen(<span class="number">3000</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'the modules test server is starting'</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>执行代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node --experimental-modules  --loader ./custom-loader.mjs ./index.js</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问</p>
<ul>
<li>访问 <a href="http://127.0.0.1:3000/index" target="_blank" rel="noopener">http://127.0.0.1:3000/index</a></li>
<li>访问 <a href="http://127.0.0.1:3000/data" target="_blank" rel="noopener">http://127.0.0.1:3000/data</a></li>
<li>访问 <a href="http://127.0.0.1:3000/todo" target="_blank" rel="noopener">http://127.0.0.1:3000/todo</a></li>
</ul>
</li>
</ul>
<h4 id="自定义loader规则优化"><a href="#自定义loader规则优化" class="headerlink" title="自定义loader规则优化"></a>自定义loader规则优化</h4><p>从上面官方提供的自定义loader例子看出，只是对<code>*.js</code>文件做<code>import/export</code>做loader兼容，然而我们在实际开发中需要对npm模块，<code>*.json</code>文件也使用<code>import/export</code></p>
<h4 id="loader规则优化解析"><a href="#loader规则优化解析" class="headerlink" title="loader规则优化解析"></a>loader规则优化解析</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> url <span class="keyword">from</span> <span class="string">'url'</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="keyword">import</span> process <span class="keyword">from</span> <span class="string">'process'</span>;</span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">'fs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从package.json中</span></span><br><span class="line"><span class="comment">// 的dependencies、devDependencies获取项目所需npm模块信息</span></span><br><span class="line"><span class="keyword">const</span> ROOT_PATH = process.cwd();</span><br><span class="line"><span class="keyword">const</span> PKG_JSON_PATH = path.join( ROOT_PATH, <span class="string">'package.json'</span> );</span><br><span class="line"><span class="keyword">const</span> PKG_JSON_STR = fs.readFileSync(PKG_JSON_PATH, <span class="string">'binary'</span>);</span><br><span class="line"><span class="keyword">const</span> PKG_JSON = <span class="built_in">JSON</span>.parse(PKG_JSON_STR);</span><br><span class="line"><span class="comment">// 项目所需npm模块信息</span></span><br><span class="line"><span class="keyword">const</span> allDependencies = &#123;</span><br><span class="line">  ...PKG_JSON.dependencies || &#123;&#125;,</span><br><span class="line">  ...PKG_JSON.devDependencies || &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Node原生模信息</span></span><br><span class="line"><span class="keyword">const</span> builtins = <span class="keyword">new</span> <span class="built_in">Set</span>(</span><br><span class="line">  <span class="built_in">Object</span>.keys(process.binding(<span class="string">'natives'</span>)).filter(<span class="function">(<span class="params">str</span>) =&gt;</span></span><br><span class="line">    /^(?!(?:internal|node|v8)\/)/.test(str))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文件引用兼容后缀名</span></span><br><span class="line"><span class="keyword">const</span> JS_EXTENSIONS = <span class="keyword">new</span> <span class="built_in">Set</span>([<span class="string">'.js'</span>, <span class="string">'.mjs'</span>]);</span><br><span class="line"><span class="keyword">const</span> JSON_EXTENSIONS = <span class="keyword">new</span> <span class="built_in">Set</span>([<span class="string">'.json'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">resolve</span>(<span class="params">specifier, parentModuleURL, defaultResolve</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 判断是否为Node原生模块</span></span><br><span class="line">  <span class="keyword">if</span> (builtins.has(specifier)) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      url: specifier,</span><br><span class="line">      format: <span class="string">'builtin'</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断是否为npm模块</span></span><br><span class="line">  <span class="keyword">if</span> ( allDependencies &amp;&amp; <span class="keyword">typeof</span> allDependencies[specifier] === <span class="string">'string'</span> ) &#123;</span><br><span class="line">    <span class="keyword">return</span> defaultResolve(specifier, parentModuleURL);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果是文件引用，判断是否路径格式正确</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="regexp">/^\.&#123;0,2&#125;[/]/</span>.test(specifier) !== <span class="literal">true</span> &amp;&amp; !specifier.startsWith(<span class="string">'file:'</span>)) &#123; </span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">      <span class="string">`imports must begin with '/', './', or '../'; '<span class="subst">$&#123;specifier&#125;</span>' does not`</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断是否为*.js、*.mjs、*.json文件</span></span><br><span class="line">  <span class="keyword">const</span> resolved = <span class="keyword">new</span> url.URL(specifier, parentModuleURL);</span><br><span class="line">  <span class="keyword">const</span> ext = path.extname(resolved.pathname);</span><br><span class="line">  <span class="keyword">if</span> (!JS_EXTENSIONS.has(ext) &amp;&amp; !JSON_EXTENSIONS.has(ext)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">      <span class="string">`Cannot load file with non-JavaScript file extension <span class="subst">$&#123;ext&#125;</span>.`</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果是*.js、*.mjs文件</span></span><br><span class="line">  <span class="keyword">if</span> (JS_EXTENSIONS.has(ext)) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      url: resolved.href,</span><br><span class="line">      format: <span class="string">'esm'</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 如果是*.json文件</span></span><br><span class="line">  <span class="keyword">if</span> (JSON_EXTENSIONS.has(ext)) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      url: resolved.href,</span><br><span class="line">      format: <span class="string">'json'</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="规则总结"><a href="#规则总结" class="headerlink" title="规则总结"></a>规则总结</h4><p>在自定义loader中，export的resolve规则最核心的代码是<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  url: <span class="string">''</span>,</span><br><span class="line">  format: <span class="string">''</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>url 是模块名称或者文件URL格式路径</li>
<li>format 是模块格式有<code>esm</code>, <code>cjs</code>, <code>json</code>, <code>builtin</code>, <code>addon</code>这四种模块/文件格式.</li>
</ul>
<p>注意：<br>目前Node对<code>import/export</code>的支持现在还是<code>Stability: 1 - Experimental</code>阶段，后续的发展还有很多不确定因素，自己练手玩玩还可以，但是在还没去flag使用之前，尽量不要在生产环境中使用。Node 9.x 更详细<code>import/export</code>的使用，可参考 <a href="https://github.com/ChenShenhai/blog/issues/24" target="_blank" rel="noopener">https://github.com/ChenShenhai/blog/issues/24</a></p>

        </div>

        
            <div class="article-tags tags">
                
                    <a href="/tags/后端/"><i class="fa fa-tag"></i>&nbsp;&nbsp;后端</a>
                
            </div>
        

        
            <div class="art-item-footer">
                
                    <span class="art-item-left">
                        <i class="fa fa-chevron-left" aria-hidden="true"></i>&nbsp;
                        <a href="/2023/05/25/手写Koa2/" rel="prev" title="手写Koa2">
                            手写Koa2
                        </a>
                    </span>
                
                
                    <span class="art-item-right">
                        <a href="/2023/04/06/MYSQL-十二/" rel="next" title="MYSQL(十二)">
                            MYSQL(十二)
                        </a>&nbsp;
                        <i class="fa fa-chevron-right" aria-hidden="true"></i>
                    </span>
                
            </div>
        

    </section>

</article>

<br>

<!-- 显示推荐文章和评论 -->


<script>
    window.subData = {
        title: 'Koa2学习笔记',
        tools: true
    }
</script>


      </div>
      <aside class='l_side'>
        
  <section class='m_widget about'>
    
        <img class='avatar waves-image' src='https://avatars2.githubusercontent.com/u/20313228?s=400&u=81b6a332e9a0f8c63e4841766106f3c8f881cfb5&v=4' />
    
</section>


  <section class='m_widget categories'>
<div class='header'><i class="fa fa-sitemap" aria-hidden="true"></i>&nbsp;&nbsp;分类</div>
<div class='content'>
    
    <ul class="entry">
    
        <li><a class="flat-box" href="/categories/css/"><div class='name'>css</div><div class='badge'>11</div></a></li>
    
        <li><a class="flat-box" href="/categories/javascript/"><div class='name'>javascript</div><div class='badge'>181</div></a></li>
    
        <li><a class="flat-box" href="/categories/nodejs/"><div class='name'>nodejs</div><div class='badge'>21</div></a></li>
    
        <li><a class="flat-box" href="/categories/服务器/"><div class='name'>服务器</div><div class='badge'>15</div></a></li>
    
        <li><a class="flat-box" href="/categories/计算机原理/"><div class='name'>计算机原理</div><div class='badge'>21</div></a></li>
    
    </ul>
    
</div>
</section>


  
<div class="m_widget tagcloud">
    <div class="header"><i class="fa fa-tags" aria-hidden="true"></i>&nbsp;&nbsp;标签</div>
    <div class='content'>
        <a href="/tags/3D/" style="font-size: 14.83px; color: #939393">3D</a> <a href="/tags/AI/" style="font-size: 14px; color: #999">AI</a> <a href="/tags/MYSQL笔记/" style="font-size: 20.67px; color: #6c6c6c">MYSQL笔记</a> <a href="/tags/Threejs/" style="font-size: 15.67px; color: #8e8e8e">Threejs</a> <a href="/tags/ajax/" style="font-size: 18.17px; color: #7d7d7d">ajax</a> <a href="/tags/canvas/" style="font-size: 14.83px; color: #939393">canvas</a> <a href="/tags/cordova/" style="font-size: 14px; color: #999">cordova</a> <a href="/tags/docker/" style="font-size: 14px; color: #999">docker</a> <a href="/tags/electron/" style="font-size: 14px; color: #999">electron</a> <a href="/tags/github/" style="font-size: 18.17px; color: #7d7d7d">github</a> <a href="/tags/hexo/" style="font-size: 14px; color: #999">hexo</a> <a href="/tags/html/" style="font-size: 17.33px; color: #828282">html</a> <a href="/tags/jquery/" style="font-size: 15.67px; color: #8e8e8e">jquery</a> <a href="/tags/linux/" style="font-size: 14.83px; color: #939393">linux</a> <a href="/tags/nodejs/" style="font-size: 15.67px; color: #8e8e8e">nodejs</a> <a href="/tags/npm/" style="font-size: 14px; color: #999">npm</a> <a href="/tags/typescript/" style="font-size: 15.67px; color: #8e8e8e">typescript</a> <a href="/tags/vue/" style="font-size: 21.5px; color: #666">vue</a> <a href="/tags/webSocket/" style="font-size: 14px; color: #999">webSocket</a> <a href="/tags/webpack/" style="font-size: 18.17px; color: #7d7d7d">webpack</a> <a href="/tags/web图形/" style="font-size: 18.17px; color: #7d7d7d">web图形</a> <a href="/tags/web安全/" style="font-size: 18.17px; color: #7d7d7d">web安全</a> <a href="/tags/web性能/" style="font-size: 19px; color: #777">web性能</a> <a href="/tags/worker/" style="font-size: 14.83px; color: #939393">worker</a> <a href="/tags/兼容性/" style="font-size: 15.67px; color: #8e8e8e">兼容性</a> <a href="/tags/后端/" style="font-size: 15.67px; color: #8e8e8e">后端</a> <a href="/tags/后端代理服务/" style="font-size: 14px; color: #999">后端代理服务</a> <a href="/tags/图片处理/" style="font-size: 18.17px; color: #7d7d7d">图片处理</a> <a href="/tags/基础知识/" style="font-size: 24px; color: #555">基础知识</a> <a href="/tags/少儿编程/" style="font-size: 14px; color: #999">少儿编程</a> <a href="/tags/工具库/" style="font-size: 23.17px; color: #5b5b5b">工具库</a> <a href="/tags/微信/" style="font-size: 14.83px; color: #939393">微信</a> <a href="/tags/手写/" style="font-size: 19.83px; color: #717171">手写</a> <a href="/tags/打印/" style="font-size: 14px; color: #999">打印</a> <a href="/tags/文章收集/" style="font-size: 14px; color: #999">文章收集</a> <a href="/tags/日语/" style="font-size: 18.17px; color: #7d7d7d">日语</a> <a href="/tags/样式/" style="font-size: 18.17px; color: #7d7d7d">样式</a> <a href="/tags/正则/" style="font-size: 14px; color: #999">正则</a> <a href="/tags/浏览器/" style="font-size: 16.5px; color: #888">浏览器</a> <a href="/tags/爬虫/" style="font-size: 14px; color: #999">爬虫</a> <a href="/tags/移动端/" style="font-size: 21.5px; color: #666">移动端</a> <a href="/tags/算法/" style="font-size: 15.67px; color: #8e8e8e">算法</a> <a href="/tags/编译/" style="font-size: 17.33px; color: #828282">编译</a> <a href="/tags/网络基础/" style="font-size: 20.67px; color: #6c6c6c">网络基础</a> <a href="/tags/调试/" style="font-size: 14.83px; color: #939393">调试</a> <a href="/tags/资源导航/" style="font-size: 14.83px; color: #939393">资源导航</a> <a href="/tags/软考/" style="font-size: 14px; color: #999">软考</a> <a href="/tags/面试题/" style="font-size: 22.33px; color: #606060">面试题</a> <a href="/tags/面试题系列/" style="font-size: 18.17px; color: #7d7d7d">面试题系列</a>
    </div>
</div>




      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">
    <div class="social-wrapper">
      
    </div>
    <br>
    <div>博客内容遵循 <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="licenses">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></div>
    <div>本站使用 <a href="https://github.com/xaoxuu/hexo-theme-material-x" target="_blank" class="codename">Material-X</a> 作为主题，
		总访问量为 <span id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span> 次。
    </div>

</footer>

  <script>setLoadingBarProgress(80);</script>
  <!-- <script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/js/jquery.min.js"></script>
<!-- <script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script> -->
<script src="/js/waves.min.js"></script>
<!-- <script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script> -->
<script src="/js/scrollreveal.min.js"></script>
<!-- 访问统计 -->
<!-- <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script> -->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- 推荐文章 -->
<!-- <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script> -->
<!-- <script src="//unpkg.com/valine/dist/Valine.min.js"></script> -->
<script src="/js/jquery.fitvids.js"></script>
<script>
var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
var ALGOLIA_API_KEY = "";
var ALGOLIA_APP_ID = "";
var ALGOLIA_INDEX_NAME = "";
var AZURE_SERVICE_NAME = "";
var AZURE_INDEX_NAME = "";
var AZURE_QUERY_KEY = "";
var BAIDU_API_ID = "";
var SEARCH_SERVICE = "hexo";
var ROOT = "/"||"/";
if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


    
    
    


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
